"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[300],{5137:function(a,b,c){c.d(b,{C:function(){return gB},E:function(){return gs},M:function(){return w},Q:function(){return hC},T:function(){return gt},U:function(){return hA},W:function(){return hE},X:function(){return hK},Z:function(){return hL},a:function(){return hy},c:function(){return hT},j:function(){return hD},n:function(){return hO},o:function(){return hS},q:function(){return hz},r:function(){return hR},s:function(){return hP},t:function(){return hM},u:function(){return hU},z:function(){return hG}});var d=c(655),e=c(4589),f=c(4594),g=c(3705),h=c(3454),i=function(){function a(a,b){var c=this;this.previousValue=a,b&&(b.sequenceNumberHandler=function(a){return c.t(a)},this.i=function(a){return b.writeSequenceNumber(a)})}return a.prototype.t=function(a){return this.previousValue=Math.max(a,this.previousValue),this.previousValue},a.prototype.next=function(){var a=++this.previousValue;return this.i&&this.i(a),a},a}();i.o=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var j={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},k=function(a){function b(b,c){var d=this;return(d=a.call(this,c)||this).code=b,d.message=c,d.name="FirebaseError",d.toString=function(){return d.name+": [code="+d.code+"]: "+d.message},d}return(0,d.__extends)(b,a),b}(Error),l=new f.Logger("@firebase/firestore");function m(){return l.logLevel}function n(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];if(l.logLevel<=f.LogLevel.DEBUG){var e=b.map(q);l.debug.apply(l,(0,d.__spreadArray)(["Firestore (8.8.0): "+a],e))}}function o(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];if(l.logLevel<=f.LogLevel.ERROR){var e=b.map(q);l.error.apply(l,(0,d.__spreadArray)(["Firestore (8.8.0): "+a],e))}}function p(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];if(l.logLevel<=f.LogLevel.WARN){var e=b.map(q);l.warn.apply(l,(0,d.__spreadArray)(["Firestore (8.8.0): "+a],e))}}function q(a){var b;if("string"==typeof a)return a;try{return b=a,JSON.stringify(b)}catch(c){return a}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Unconditionally fails, throwing an Error with the given message.
 * Messages are stripped in production builds.
 *
 * Returns `never` and can be used in expressions:
 * @example
 * let futureVar = fail('not implemented yet');
 */ function r(a){void 0===a&&(a="Unexpected state");var b="FIRESTORE (8.8.0) INTERNAL ASSERTION FAILED: "+a;throw o(b),Error(b)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Generates `nBytes` of random bytes.
 *
 * If `nBytes < 0` , an error will be thrown.
 */ function s(a){var b="undefined"!=typeof self&&(self.crypto||self.msCrypto),c=new Uint8Array(a);if(b&&"function"==typeof b.getRandomValues)b.getRandomValues(c);else for(var d=0;d<a;d++)c[d]=Math.floor(256*Math.random());return c}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var t=function(){function a(){}return a.u=function(){for(var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",b=Math.floor(256/a.length)*a.length,c="";c.length<20;)for(var d=s(40),e=0;e<d.length;++e)c.length<20&&d[e]<b&&(c+=a.charAt(d[e]%a.length));return c},a}();function u(a,b){return a<b?-1:a>b?1:0}function v(a,b,c){return a.length===b.length&&a.every(function(a,d){return c(a,b[d])})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ // The earliest date supported by Firestore timestamps (0001-01-01T00:00:00Z).
/**
 * A `Timestamp` represents a point in time independent of any time zone or
 * calendar, represented as seconds and fractions of seconds at nanosecond
 * resolution in UTC Epoch time.
 *
 * It is encoded using the Proleptic Gregorian Calendar which extends the
 * Gregorian calendar backwards to year one. It is encoded assuming all minutes
 * are 60 seconds long, i.e. leap seconds are "smeared" so that no leap second
 * table is needed for interpretation. Range is from 0001-01-01T00:00:00Z to
 * 9999-12-31T23:59:59.999999999Z.
 *
 * For examples and further specifications, refer to the
 * {@link https://github.com/google/protobuf/blob/master/src/google/protobuf/timestamp.proto | Timestamp definition}.
 */ var w=function(){function a(a,b){if(this.seconds=a,this.nanoseconds=b,b<0||b>=1e9)throw new k(j.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+b);if(a< -62135596800||a>=253402300800)throw new k(j.INVALID_ARGUMENT,"Timestamp seconds out of range: "+a)}return a.now=function(){return a.fromMillis(Date.now())},a.fromDate=function(b){return a.fromMillis(b.getTime())},a.fromMillis=function(b){var c=Math.floor(b/1e3);return new a(c,Math.floor(1e6*(b-1e3*c)))},a.prototype.toDate=function(){return new Date(this.toMillis())},a.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},a.prototype._compareTo=function(a){return this.seconds===a.seconds?u(this.nanoseconds,a.nanoseconds):u(this.seconds,a.seconds)},a.prototype.isEqual=function(a){return a.seconds===this.seconds&&a.nanoseconds===this.nanoseconds},a.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},a.prototype.toJSON=function(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}},a.prototype.valueOf=function(){return String(this.seconds- -62135596800).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")},a}(),x=function(){function a(a){this.timestamp=a}return a.fromTimestamp=function(b){return new a(b)},a.min=function(){return new a(new w(0,0))},a.prototype.compareTo=function(a){return this.timestamp._compareTo(a.timestamp)},a.prototype.isEqual=function(a){return this.timestamp.isEqual(a.timestamp)},a.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},a.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},a.prototype.toTimestamp=function(){return this.timestamp},a}();/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A version of a document in Firestore. This corresponds to the version
 * timestamp, such as update_time or read_time.
 */ /**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ function y(a){var b=0;for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b++;return b}function z(a,b){for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b(c,a[c])}function A(a){for(var b in a)if(Object.prototype.hasOwnProperty.call(a,b))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Path represents an ordered sequence of string segments.
 */ var B=function(){function a(a,b,c){void 0===b?b=0:b>a.length&&r(),void 0===c?c=a.length-b:c>a.length-b&&r(),this.segments=a,this.offset=b,this.len=c}return Object.defineProperty(a.prototype,"length",{get:function(){return this.len},enumerable:!1,configurable:!0}),a.prototype.isEqual=function(b){return 0===a.comparator(this,b)},a.prototype.child=function(b){var c=this.segments.slice(this.offset,this.limit());return b instanceof a?b.forEach(function(a){c.push(a)}):c.push(b),this.construct(c)},a.prototype.limit=function(){return this.offset+this.length},a.prototype.popFirst=function(a){return a=void 0===a?1:a,this.construct(this.segments,this.offset+a,this.length-a)},a.prototype.popLast=function(){return this.construct(this.segments,this.offset,this.length-1)},a.prototype.firstSegment=function(){return this.segments[this.offset]},a.prototype.lastSegment=function(){return this.get(this.length-1)},a.prototype.get=function(a){return this.segments[this.offset+a]},a.prototype.isEmpty=function(){return 0===this.length},a.prototype.isPrefixOf=function(a){if(a.length<this.length)return!1;for(var b=0;b<this.length;b++)if(this.get(b)!==a.get(b))return!1;return!0},a.prototype.isImmediateParentOf=function(a){if(this.length+1!==a.length)return!1;for(var b=0;b<this.length;b++)if(this.get(b)!==a.get(b))return!1;return!0},a.prototype.forEach=function(a){for(var b=this.offset,c=this.limit();b<c;b++)a(this.segments[b])},a.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},a.comparator=function(a,b){for(var c=Math.min(a.length,b.length),d=0;d<c;d++){var e=a.get(d),f=b.get(d);if(e<f)return -1;if(e>f)return 1}return a.length<b.length?-1:a.length>b.length?1:0},a}(),C=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return(0,d.__extends)(b,a),b.prototype.construct=function(a,c,d){return new b(a,c,d)},b.prototype.canonicalString=function(){return this.toArray().join("/")},b.prototype.toString=function(){return this.canonicalString()},b.fromString=function(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];for(var d=[],e=0,f=a;e<f.length;e++){var g=f[e];if(g.indexOf("//")>=0)throw new k(j.INVALID_ARGUMENT,"Invalid segment ("+g+"). Paths must not contain // in them.");d.push.apply(d,g.split("/").filter(function(a){return a.length>0}))}return new b(d)},b.emptyPath=function(){return new b([])},b}(B),D=/^[_a-zA-Z][_a-zA-Z0-9]*$/,E=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return(0,d.__extends)(b,a),b.prototype.construct=function(a,c,d){return new b(a,c,d)},b.isValidIdentifier=function(a){return D.test(a)},b.prototype.canonicalString=function(){return this.toArray().map(function(a){return a=a.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),b.isValidIdentifier(a)||(a="`"+a+"`"),a}).join(".")},b.prototype.toString=function(){return this.canonicalString()},b.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)},b.keyField=function(){return new b(["__name__"])},b.fromServerFormat=function(a){for(var c=[],d="",e=0,f=function(){if(0===d.length)throw new k(j.INVALID_ARGUMENT,"Invalid field path ("+a+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");c.push(d),d=""},g=!1;e<a.length;){var h=a[e];if("\\"===h){if(e+1===a.length)throw new k(j.INVALID_ARGUMENT,"Path has trailing escape character: "+a);var i=a[e+1];if("\\"!==i&&"."!==i&&"`"!==i)throw new k(j.INVALID_ARGUMENT,"Path has invalid escape sequence: "+a);d+=i,e+=2}else"`"===h?(g=!g,e++):"."!==h||g?(d+=h,e++):(f(),e++)}if(f(),g)throw new k(j.INVALID_ARGUMENT,"Unterminated ` in path: "+a);return new b(c)},b.emptyPath=function(){return new b([])},b}(B),F=function(){function a(a){this.fields=a,a.sort(E.comparator)}return a.prototype.covers=function(a){for(var b=0,c=this.fields;b<c.length;b++)if(c[b].isPrefixOf(a))return!0;return!1},a.prototype.isEqual=function(a){return v(this.fields,a.fields,function(a,b){return a.isEqual(b)})},a}(),G=function(){function a(a){this.binaryString=a}return a.fromBase64String=function(b){return new a(atob(b))},a.fromUint8Array=function(b){return new a(function(a){for(var b="",c=0;c<a.length;++c)b+=String.fromCharCode(a[c]);return b}(b))},a.prototype.toBase64=function(){var a;return btoa(this.binaryString)},a.prototype.toUint8Array=function(){return function(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return b}(this.binaryString)},a.prototype.approximateByteSize=function(){return 2*this.binaryString.length},a.prototype.compareTo=function(a){return u(this.binaryString,a.binaryString)},a.prototype.isEqual=function(a){return this.binaryString===a.binaryString},a}();G.EMPTY_BYTE_STRING=new G("");var H=RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function I(a){var b;if(!a&&r(),"string"==typeof a){var c,d=0,e=H.exec(a);if(!e&&r(),e[1]){var f=e[1];d=Number(f=(f+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(a).getTime()/1e3),nanos:d}}return{seconds:J(a.seconds),nanos:J(a.nanos)}}function J(a){return"number"==typeof a?a:"string"==typeof a?Number(a):0}function K(a){return"string"==typeof a?G.fromBase64String(a):G.fromUint8Array(a)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Represents a locally-applied ServerTimestamp.
 *
 * Server Timestamps are backed by MapValues that contain an internal field
 * `__type__` with a value of `server_timestamp`. The previous value and local
 * write time are stored in its `__previous_value__` and `__local_write_time__`
 * fields respectively.
 *
 * Notes:
 * - ServerTimestampValue instances are created as the result of applying a
 *   transform. They can only exist in the local view of a document. Therefore
 *   they do not need to be parsed or serialized.
 * - When evaluated locally (e.g. for snapshot.data()), they by default
 *   evaluate to `null`. This behavior can be configured by passing custom
 *   FieldValueOptions to value().
 * - With respect to other ServerTimestampValues, they sort by their
 *   localWriteTime.
 */ function L(a){var b,c;return"server_timestamp"===(null===(c=((null===(b=null==a?void 0:a.mapValue)|| void 0===b?void 0:b.fields)||{}).__type__)|| void 0===c?void 0:c.stringValue)}function M(a){var b=a.mapValue.fields.__previous_value__;return L(b)?M(b):b}function N(a){var b=I(a.mapValue.fields.__local_write_time__.timestampValue);return new w(b.seconds,b.nanos)}function O(a){return 0===a&&1/a== -1/0}function P(a){return"number"==typeof a&&Number.isInteger(a)&&!O(a)&&a<=Number.MAX_SAFE_INTEGER&&a>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var Q=function(){function a(a){this.path=a}return a.fromPath=function(b){return new a(C.fromString(b))},a.fromName=function(b){return new a(C.fromString(b).popFirst(5))},a.prototype.hasCollectionId=function(a){return this.path.length>=2&&this.path.get(this.path.length-2)===a},a.prototype.isEqual=function(a){return null!==a&&0===C.comparator(this.path,a.path)},a.prototype.toString=function(){return this.path.toString()},a.comparator=function(a,b){return C.comparator(a.path,b.path)},a.isDocumentKey=function(a){return a.length%2==0},a.fromSegments=function(b){return new a(new C(b.slice()))},a}();/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** Extracts the backend's type order for the provided value. */ function R(a){return"nullValue"in a?0:"booleanValue"in a?1:"integerValue"in a||"doubleValue"in a?2:"timestampValue"in a?3:"stringValue"in a?5:"bytesValue"in a?6:"referenceValue"in a?7:"geoPointValue"in a?8:"arrayValue"in a?9:"mapValue"in a?L(a)?4:10:r()}function S(a,b){var c,d,e,f,g=R(a);if(g!==R(b))return!1;switch(g){case 0:return!0;case 1:return a.booleanValue===b.booleanValue;case 4:return N(a).isEqual(N(b));case 3:return function(a,b){if("string"==typeof a.timestampValue&&"string"==typeof b.timestampValue&&a.timestampValue.length===b.timestampValue.length)return a.timestampValue===b.timestampValue;var c=I(a.timestampValue),d=I(b.timestampValue);return c.seconds===d.seconds&&c.nanos===d.nanos}(a,b);case 5:return a.stringValue===b.stringValue;case 6:return c=a,d=b,K(c.bytesValue).isEqual(K(d.bytesValue));case 7:return a.referenceValue===b.referenceValue;case 8:return e=a,f=b,J(e.geoPointValue.latitude)===J(f.geoPointValue.latitude)&&J(e.geoPointValue.longitude)===J(f.geoPointValue.longitude);case 2:return function(a,b){if("integerValue"in a&&"integerValue"in b)return J(a.integerValue)===J(b.integerValue);if("doubleValue"in a&&"doubleValue"in b){var c=J(a.doubleValue),d=J(b.doubleValue);return c===d?O(c)===O(d):isNaN(c)&&isNaN(d)}return!1}(a,b);case 9:return v(a.arrayValue.values||[],b.arrayValue.values||[],S);case 10:return function(a,b){var c=a.mapValue.fields||{},d=b.mapValue.fields||{};if(y(c)!==y(d))return!1;for(var e in c)if(c.hasOwnProperty(e)&&(void 0===d[e]||!S(c[e],d[e])))return!1;return!0}(a,b);default:return r()}}function T(a,b){return void 0!==(a.values||[]).find(function(a){return S(a,b)})}function U(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=R(a),o=R(b);if(n!==o)return u(n,o);switch(n){case 0:return 0;case 1:return u(a.booleanValue,b.booleanValue);case 2:return c=a,d=b,e=J(c.integerValue||c.doubleValue),f=J(d.integerValue||d.doubleValue),e<f?-1:e>f?1:e===f?0:isNaN(e)?isNaN(f)?0:-1:1;case 3:return V(a.timestampValue,b.timestampValue);case 4:return V(N(a),N(b));case 5:return u(a.stringValue,b.stringValue);case 6:return g=a.bytesValue,h=b.bytesValue,i=K(g),j=K(h),i.compareTo(j);case 7:return function(a,b){for(var c=a.split("/"),d=b.split("/"),e=0;e<c.length&&e<d.length;e++){var f=u(c[e],d[e]);if(0!==f)return f}return u(c.length,d.length)}(a.referenceValue,b.referenceValue);case 8:return k=a.geoPointValue,l=b.geoPointValue,0!==(m=u(J(k.latitude),J(l.latitude)))?m:u(J(k.longitude),J(l.longitude));case 9:return function(a,b){for(var c=a.values||[],d=b.values||[],e=0;e<c.length&&e<d.length;++e){var f=U(c[e],d[e]);if(f)return f}return u(c.length,d.length)}(a.arrayValue,b.arrayValue);case 10:return function(a,b){var c=a.fields||{},d=Object.keys(c),e=b.fields||{},f=Object.keys(e);d.sort(),f.sort();for(var g=0;g<d.length&&g<f.length;++g){var h=u(d[g],f[g]);if(0!==h)return h;var i=U(c[d[g]],e[f[g]]);if(0!==i)return i}return u(d.length,f.length)}(a.mapValue,b.mapValue);default:throw r()}}function V(a,b){if("string"==typeof a&&"string"==typeof b&&a.length===b.length)return u(a,b);var c=I(a),d=I(b),e=u(c.seconds,d.seconds);return 0!==e?e:u(c.nanos,d.nanos)}function W(a){return X(a)}function X(a){var b,c,d,e;return"nullValue"in a?"null":"booleanValue"in a?""+a.booleanValue:"integerValue"in a?""+a.integerValue:"doubleValue"in a?""+a.doubleValue:"timestampValue"in a?"time("+(e=I(d=a.timestampValue)).seconds+","+e.nanos+")":"stringValue"in a?a.stringValue:"bytesValue"in a?K(a.bytesValue).toBase64():"referenceValue"in a?(c=a.referenceValue,Q.fromName(c).toString()):"geoPointValue"in a?"geo("+(b=a.geoPointValue).latitude+","+b.longitude+")":"arrayValue"in a?function(a){for(var b="[",c=!0,d=0,e=a.values||[];d<e.length;d++)c?c=!1:b+=",",b+=X(e[d]);return b+"]"}(a.arrayValue):"mapValue"in a?function(a){for(var b="{",c=!0,d=0,e=Object.keys(a.fields||{}).sort();d<e.length;d++){var f=e[d];c?c=!1:b+=",",b+=f+":"+X(a.fields[f])}return b+"}"}(a.mapValue):r()}function Y(a,b){return{referenceValue:"projects/"+a.projectId+"/databases/"+a.database+"/documents/"+b.path.canonicalString()}}function Z(a){return!!a&&"integerValue"in a}function $(a){return!!a&&"arrayValue"in a}function _(a){return!!a&&"nullValue"in a}function aa(a){return!!a&&"doubleValue"in a&&isNaN(Number(a.doubleValue))}function ab(a){return!!a&&"mapValue"in a}function ac(a){if(a.geoPointValue)return{geoPointValue:Object.assign({},a.geoPointValue)};if(a.timestampValue&&"object"==typeof a.timestampValue)return{timestampValue:Object.assign({},a.timestampValue)};if(a.mapValue){var b={mapValue:{fields:{}}};return z(a.mapValue.fields,function(a,c){return b.mapValue.fields[a]=ac(c)}),b}if(a.arrayValue){for(var c={arrayValue:{values:[]}},d=0;d<(a.arrayValue.values||[]).length;++d)c.arrayValue.values[d]=ac(a.arrayValue.values[d]);return c}return Object.assign({},a)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * An ObjectValue represents a MapValue in the Firestore Proto and offers the
 * ability to add and remove fields (via the ObjectValueBuilder).
 */ var ad=function(){function a(a){this.value=a}return a.empty=function(){return new a({mapValue:{}})},a.prototype.field=function(a){if(a.isEmpty())return this.value;for(var b=this.value,c=0;c<a.length-1;++c)if(!ab(b=(b.mapValue.fields||{})[a.get(c)]))return null;return(b=(b.mapValue.fields||{})[a.lastSegment()])||null},a.prototype.set=function(a,b){this.getFieldsMap(a.popLast())[a.lastSegment()]=ac(b)},a.prototype.setAll=function(a){var b=this,c=E.emptyPath(),d={},e=[];a.forEach(function(a,f){if(!c.isImmediateParentOf(f)){var g=b.getFieldsMap(c);b.applyChanges(g,d,e),d={},e=[],c=f.popLast()}a?d[f.lastSegment()]=ac(a):e.push(f.lastSegment())});var f=this.getFieldsMap(c);this.applyChanges(f,d,e)},a.prototype.delete=function(a){var b=this.field(a.popLast());ab(b)&&b.mapValue.fields&&delete b.mapValue.fields[a.lastSegment()]},a.prototype.isEqual=function(a){return S(this.value,a.value)},a.prototype.getFieldsMap=function(a){var b=this.value;b.mapValue.fields||(b.mapValue={fields:{}});for(var c=0;c<a.length;++c){var d=b.mapValue.fields[a.get(c)];ab(d)&&d.mapValue.fields||(d={mapValue:{fields:{}}},b.mapValue.fields[a.get(c)]=d),b=d}return b.mapValue.fields},a.prototype.applyChanges=function(a,b,c){z(b,function(b,c){return a[b]=c});for(var d=0,e=c;d<e.length;d++)delete a[e[d]]},a.prototype.clone=function(){return new a(ac(this.value))},a}();function ae(a){var b=[];return z(a.fields,function(a,c){var d=new E([a]);if(ab(c)){var e=ae(c.mapValue).fields;if(0===e.length)b.push(d);else for(var f=0,g=e;f<g.length;f++){var h=g[f];b.push(d.child(h))}}else b.push(d)}),new F(b)}var af=function(){function a(a,b,c,d,e){this.key=a,this.documentType=b,this.version=c,this.data=d,this.documentState=e}return a.newInvalidDocument=function(b){return new a(b,0,x.min(),ad.empty(),0)},a.newFoundDocument=function(b,c,d){return new a(b,1,c,d,0)},a.newNoDocument=function(b,c){return new a(b,2,c,ad.empty(),0)},a.newUnknownDocument=function(b,c){return new a(b,3,c,ad.empty(),2)},a.prototype.convertToFoundDocument=function(a,b){return this.version=a,this.documentType=1,this.data=b,this.documentState=0,this},a.prototype.convertToNoDocument=function(a){return this.version=a,this.documentType=2,this.data=ad.empty(),this.documentState=0,this},a.prototype.convertToUnknownDocument=function(a){return this.version=a,this.documentType=3,this.data=ad.empty(),this.documentState=2,this},a.prototype.setHasCommittedMutations=function(){return this.documentState=2,this},a.prototype.setHasLocalMutations=function(){return this.documentState=1,this},Object.defineProperty(a.prototype,"hasLocalMutations",{get:function(){return 1===this.documentState},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"hasCommittedMutations",{get:function(){return 2===this.documentState},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!1,configurable:!0}),a.prototype.isValidDocument=function(){return 0!==this.documentType},a.prototype.isFoundDocument=function(){return 1===this.documentType},a.prototype.isNoDocument=function(){return 2===this.documentType},a.prototype.isUnknownDocument=function(){return 3===this.documentType},a.prototype.isEqual=function(b){return b instanceof a&&this.key.isEqual(b.key)&&this.version.isEqual(b.version)&&this.documentType===b.documentType&&this.documentState===b.documentState&&this.data.isEqual(b.data)},a.prototype.clone=function(){return new a(this.key,this.documentType,this.version,this.data.clone(),this.documentState)},a.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+JSON.stringify(this.data.value)+", {documentType: "+this.documentType+"}), {documentState: "+this.documentState+"})"},a}(),ag=function(a,b,c,d,e,f,g){void 0===b&&(b=null),void 0===c&&(c=[]),void 0===d&&(d=[]),void 0===e&&(e=null),void 0===f&&(f=null),void 0===g&&(g=null),this.path=a,this.collectionGroup=b,this.orderBy=c,this.filters=d,this.limit=e,this.startAt=f,this.endAt=g,this.h=null};/**
 * Compares the value for field `field` in the provided documents. Throws if
 * the field does not exist in both documents.
 */ /**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ // Visible for testing
/**
 * Initializes a Target with a path and optional additional query constraints.
 * Path must currently be empty if this is a collection group query.
 *
 * NOTE: you should always construct `Target` from `Query.toTarget` instead of
 * using this factory method, because `Query` provides an implicit `orderBy`
 * property.
 */ function ah(a,b,c,d,e,f,g){return void 0===b&&(b=null),void 0===c&&(c=[]),void 0===d&&(d=[]),void 0===e&&(e=null),void 0===f&&(f=null),void 0===g&&(g=null),new ag(a,b,c,d,e,f,g)}function ai(a){var b,c=b=a;if(null===c.h){var d,e=c.path.canonicalString();null!==c.collectionGroup&&(e+="|cg:"+c.collectionGroup),e+="|f:",e+=c.filters.map(function(a){var b;return(b=a).field.canonicalString()+b.op.toString()+W(b.value)}).join(","),e+="|ob:",e+=c.orderBy.map(function(a){var b;return(b=a).field.canonicalString()+b.dir}).join(","),d=c.limit,null==d||(e+="|l:",e+=c.limit),c.startAt&&(e+="|lb:",e+=av(c.startAt)),c.endAt&&(e+="|ub:",e+=av(c.endAt)),c.h=e}return c.h}function aj(a,b){if(a.limit!==b.limit||a.orderBy.length!==b.orderBy.length)return!1;for(var c,d,e=0;e<a.orderBy.length;e++)if(!ax(a.orderBy[e],b.orderBy[e]))return!1;if(a.filters.length!==b.filters.length)return!1;for(var f=0;f<a.filters.length;f++)if(c=a.filters[f],d=b.filters[f],c.op!==d.op||!c.field.isEqual(d.field)||!S(c.value,d.value))return!1;return a.collectionGroup===b.collectionGroup&&!!a.path.isEqual(b.path)&&!!az(a.startAt,b.startAt)&&az(a.endAt,b.endAt)}function ak(a){return Q.isDocumentKey(a.path)&&null===a.collectionGroup&&0===a.filters.length}var al=function(a){function b(b,c,d){var e=this;return(e=a.call(this)||this).field=b,e.op=c,e.value=d,e}return(0,d.__extends)(b,a),b.create=function(a,c,d){return a.isKeyField()?"in"===c||"not-in"===c?this.l(a,c,d):new am(a,c,d):"array-contains"===c?new aq(a,d):"in"===c?new ar(a,d):"not-in"===c?new as(a,d):"array-contains-any"===c?new at(a,d):new b(a,c,d)},b.l=function(a,b,c){return"in"===b?new an(a,c):new ao(a,c)},b.prototype.matches=function(a){var b=a.data.field(this.field);return"!="===this.op?null!==b&&this.m(U(b,this.value)):null!==b&&R(this.value)===R(b)&&this.m(U(b,this.value))},b.prototype.m=function(a){switch(this.op){case"<":return a<0;case"<=":return a<=0;case"==":return 0===a;case"!=":return 0!==a;case">":return a>0;case">=":return a>=0;default:return r()}},b.prototype.g=function(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0},b}(function(){}),am=function(a){function b(b,c,d){var e=this;return(e=a.call(this,b,c,d)||this).key=Q.fromName(d.referenceValue),e}return(0,d.__extends)(b,a),b.prototype.matches=function(a){var b=Q.comparator(a.key,this.key);return this.m(b)},b}(al),an=function(a){function b(b,c){var d=this;return(d=a.call(this,b,"in",c)||this).keys=ap("in",c),d}return(0,d.__extends)(b,a),b.prototype.matches=function(a){return this.keys.some(function(b){return b.isEqual(a.key)})},b}(al),ao=function(a){function b(b,c){var d=this;return(d=a.call(this,b,"not-in",c)||this).keys=ap("not-in",c),d}return(0,d.__extends)(b,a),b.prototype.matches=function(a){return!this.keys.some(function(b){return b.isEqual(a.key)})},b}(al);function ap(a,b){var c;return((null===(c=b.arrayValue)|| void 0===c?void 0:c.values)||[]).map(function(a){return Q.fromName(a.referenceValue)})}var aq=function(a){function b(b,c){return a.call(this,b,"array-contains",c)||this}return(0,d.__extends)(b,a),b.prototype.matches=function(a){var b=a.data.field(this.field);return $(b)&&T(b.arrayValue,this.value)},b}(al),ar=function(a){function b(b,c){return a.call(this,b,"in",c)||this}return(0,d.__extends)(b,a),b.prototype.matches=function(a){var b=a.data.field(this.field);return null!==b&&T(this.value.arrayValue,b)},b}(al),as=function(a){function b(b,c){return a.call(this,b,"not-in",c)||this}return(0,d.__extends)(b,a),b.prototype.matches=function(a){if(T(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var b=a.data.field(this.field);return null!==b&&!T(this.value.arrayValue,b)},b}(al),at=function(a){function b(b,c){return a.call(this,b,"array-contains-any",c)||this}return(0,d.__extends)(b,a),b.prototype.matches=function(a){var b=this,c=a.data.field(this.field);return!(!$(c)||!c.arrayValue.values)&&c.arrayValue.values.some(function(a){return T(b.value.arrayValue,a)})},b}(al),au=function(a,b){this.position=a,this.before=b};function av(a){return(a.before?"b":"a")+":"+a.position.map(function(a){return W(a)}).join(",")}var aw=function(a,b){void 0===b&&(b="asc"),this.field=a,this.dir=b};function ax(a,b){return a.dir===b.dir&&a.field.isEqual(b.field)}function ay(a,b,c){for(var d=0,e=0;e<a.position.length;e++){var f=b[e],g=a.position[e];if(d=f.field.isKeyField()?Q.comparator(Q.fromName(g.referenceValue),c.key):U(g,c.data.field(f.field)),"desc"===f.dir&&(d*=-1),0!==d)break}return a.before?d<=0:d<0}function az(a,b){if(null===a)return null===b;if(null===b||a.before!==b.before||a.position.length!==b.position.length)return!1;for(var c=0;c<a.position.length;c++)if(!S(a.position[c],b.position[c]))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Query encapsulates all the query attributes we support in the SDK. It can
 * be run against the LocalStore, as well as be converted to a `Target` to
 * query the RemoteStore results.
 *
 * Visible for testing.
 */ var aA=function(a,b,c,d,e,f,g,h){void 0===b&&(b=null),void 0===c&&(c=[]),void 0===d&&(d=[]),void 0===e&&(e=null),void 0===f&&(f="F"),void 0===g&&(g=null),void 0===h&&(h=null),this.path=a,this.collectionGroup=b,this.explicitOrderBy=c,this.filters=d,this.limit=e,this.limitType=f,this.startAt=g,this.endAt=h,this.p=null,this.T=null,this.startAt,this.endAt};function aB(a,b,c,d,e,f,g,h){return new aA(a,b,c,d,e,f,g,h)}function aC(a){return new aA(a)}function aD(a){var b;return null!=(b=a.limit)&&"F"===a.limitType}function aE(a){var b;return null!=(b=a.limit)&&"L"===a.limitType}function aF(a){return a.explicitOrderBy.length>0?a.explicitOrderBy[0].field:null}function aG(a){for(var b=0,c=a.filters;b<c.length;b++){var d=c[b];if(d.g())return d.field}return null}function aH(a){return null!==a.collectionGroup}function aI(a){var b,c=b=a;if(null===c.p){c.p=[];var d=aG(c),e=aF(c);if(null!==d&&null===e)d.isKeyField()||c.p.push(new aw(d)),c.p.push(new aw(E.keyField(),"asc"));else{for(var f=!1,g=0,h=c.explicitOrderBy;g<h.length;g++){var i=h[g];c.p.push(i),i.field.isKeyField()&&(f=!0)}if(!f){var j=c.explicitOrderBy.length>0?c.explicitOrderBy[c.explicitOrderBy.length-1].dir:"asc";c.p.push(new aw(E.keyField(),j))}}}return c.p}function aJ(a){var b,c=b=a;if(!c.T){if("F"===c.limitType)c.T=ah(c.path,c.collectionGroup,aI(c),c.filters,c.limit,c.startAt,c.endAt);else{for(var d=[],e=0,f=aI(c);e<f.length;e++){var g=f[e],h="desc"===g.dir?"asc":"desc";d.push(new aw(g.field,h))}var i=c.endAt?new au(c.endAt.position,!c.endAt.before):null,j=c.startAt?new au(c.startAt.position,!c.startAt.before):null;c.T=ah(c.path,c.collectionGroup,d,c.filters,c.limit,i,j)}}return c.T}function aK(a,b,c){return new aA(a.path,a.collectionGroup,a.explicitOrderBy.slice(),a.filters.slice(),b,c,a.startAt,a.endAt)}function aL(a,b){return aj(aJ(a),aJ(b))&&a.limitType===b.limitType}function aM(a){return ai(aJ(a))+"|lt:"+a.limitType}function aN(a){var b,c,d;return"Query(target="+(c=(b=aJ(a)).path.canonicalString(),null!==b.collectionGroup&&(c+=" collectionGroup="+b.collectionGroup),b.filters.length>0&&(c+=", filters: ["+b.filters.map(function(a){var b;return(b=a).field.canonicalString()+" "+b.op+" "+W(b.value)}).join(", ")+"]"),d=b.limit,null==d||(c+=", limit: "+b.limit),b.orderBy.length>0&&(c+=", orderBy: ["+b.orderBy.map(function(a){var b;return(b=a).field.canonicalString()+" ("+b.dir+")"}).join(", ")+"]"),b.startAt&&(c+=", startAt: "+av(b.startAt)),b.endAt&&(c+=", endAt: "+av(b.endAt)),"Target("+c+")")+"; limitType="+a.limitType+")"}function aO(a,b){var c,d,e,f,g;return b.isFoundDocument()&&(c=a,e=(d=b).key.path,null!==c.collectionGroup?d.key.hasCollectionId(c.collectionGroup)&&c.path.isPrefixOf(e):Q.isDocumentKey(c.path)?c.path.isEqual(e):c.path.isImmediateParentOf(e))&&function(a,b){for(var c=0,d=a.explicitOrderBy;c<d.length;c++){var e=d[c];if(!e.field.isKeyField()&&null===b.data.field(e.field))return!1}return!0}(a,b)&&function(a,b){for(var c=0,d=a.filters;c<d.length;c++)if(!d[c].matches(b))return!1;return!0}(a,b)&&(f=a,g=b,!(f.startAt&&!ay(f.startAt,aI(f),g))&&(!f.endAt||!ay(f.endAt,aI(f),g)))}function aP(a){return function(b,c){for(var d=!1,e=0,f=aI(a);e<f.length;e++){var g=f[e],h=aQ(g,b,c);if(0!==h)return h;d=d||g.field.isKeyField()}return 0}}function aQ(a,b,c){var d,e,f,g,h,i=a.field.isKeyField()?Q.comparator(b.key,c.key):(d=a.field,e=b,f=c,g=e.data.field(d),h=f.data.field(d),null!==g&&null!==h?U(g,h):r());switch(a.dir){case"asc":return i;case"desc":return -1*i;default:return r()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Returns an DoubleValue for `value` that is encoded based the serializer's
 * `useProto3Json` setting.
 */ function aR(a,b){if(a.I){if(isNaN(b))return{doubleValue:"NaN"};if(b===1/0)return{doubleValue:"Infinity"};if(b=== -1/0)return{doubleValue:"-Infinity"}}return{doubleValue:O(b)?"-0":b}}function aS(a){return{integerValue:""+a}}function aT(a,b){return P(b)?aS(b):aR(a,b)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** Used to represent a field transform on a mutation. */ var aU=function(){this._=void 0};function aV(a,b,c){var d,e,f,g,h,i,j;return a instanceof aY?(d=c,e=b,f={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:d.seconds,nanos:d.nanoseconds}}}},e&&(f.fields.__previous_value__=e),{mapValue:f}):a instanceof aZ?a$(a,b):a instanceof a_?a0(a,b):(g=a,i=aX(g,h=b),j=a2(i)+a2(g.A),Z(i)&&Z(g.A)?aS(j):aR(g.R,j))}function aW(a,b,c){return a instanceof aZ?a$(a,b):a instanceof a_?a0(a,b):c}function aX(a,b){var c,d;return a instanceof a1?Z(c=b)||(d=c)&&"doubleValue"in d?b:{integerValue:0}:null}var aY=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return(0,d.__extends)(b,a),b}(aU),aZ=function(a){function b(b){var c=this;return(c=a.call(this)||this).elements=b,c}return(0,d.__extends)(b,a),b}(aU);function a$(a,b){for(var c=a3(b),d=function(a){c.some(function(b){return S(b,a)})||c.push(a)},e=0,f=a.elements;e<f.length;e++)d(f[e]);return{arrayValue:{values:c}}}var a_=function(a){function b(b){var c=this;return(c=a.call(this)||this).elements=b,c}return(0,d.__extends)(b,a),b}(aU);function a0(a,b){for(var c=a3(b),d=function(a){c=c.filter(function(b){return!S(b,a)})},e=0,f=a.elements;e<f.length;e++)d(f[e]);return{arrayValue:{values:c}}}var a1=function(a){function b(b,c){var d=this;return(d=a.call(this)||this).R=b,d.A=c,d}return(0,d.__extends)(b,a),b}(aU);function a2(a){return J(a.integerValue||a.doubleValue)}function a3(a){return $(a)&&a.arrayValue.values?a.arrayValue.values.slice():[]}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** A field path and the TransformOperation to perform upon it. */ var a4=function(a,b){this.field=a,this.transform=b},a5=function(a,b){this.version=a,this.transformResults=b},a6=function(){function a(a,b){this.updateTime=a,this.exists=b}return a.none=function(){return new a},a.exists=function(b){return new a(void 0,b)},a.updateTime=function(b){return new a(b)},Object.defineProperty(a.prototype,"isNone",{get:function(){return void 0===this.updateTime&& void 0===this.exists},enumerable:!1,configurable:!0}),a.prototype.isEqual=function(a){return this.exists===a.exists&&(this.updateTime?!!a.updateTime&&this.updateTime.isEqual(a.updateTime):!a.updateTime)},a}();function a7(a,b){return void 0!==a.updateTime?b.isFoundDocument()&&b.version.isEqual(a.updateTime):void 0===a.exists||a.exists===b.isFoundDocument()}var a8=function(){};function a9(a,b,c){var d,e,f,g,h;a instanceof be?(d=a,e=b,f=c,g=d.value.clone(),h=bh(d.fieldTransforms,e,f.transformResults),g.setAll(h),e.convertToFoundDocument(f.version,g).setHasCommittedMutations()):a instanceof bf?function(a,b,c){if(a7(a.precondition,b)){var d=bh(a.fieldTransforms,b,c.transformResults),e=b.data;e.setAll(bg(a)),e.setAll(d),b.convertToFoundDocument(c.version,e).setHasCommittedMutations()}else b.convertToUnknownDocument(c.version)}(a,b,c):function(a,b,c){b.convertToNoDocument(c.version).setHasCommittedMutations()}(0,b,c)}function ba(a,b,c){var d,e;a instanceof be?function(a,b,c){if(a7(a.precondition,b)){var d=a.value.clone(),e=bi(a.fieldTransforms,c,b);d.setAll(e),b.convertToFoundDocument(bd(b),d).setHasLocalMutations()}}(a,b,c):a instanceof bf?function(a,b,c){if(a7(a.precondition,b)){var d=bi(a.fieldTransforms,c,b),e=b.data;e.setAll(bg(a)),e.setAll(d),b.convertToFoundDocument(bd(b),e).setHasLocalMutations()}}(a,b,c):(d=a,e=b,a7(d.precondition,e)&&e.convertToNoDocument(x.min()))}function bb(a,b){for(var c=null,d=0,e=a.fieldTransforms;d<e.length;d++){var f=e[d],g=b.data.field(f.field),h=aX(f.transform,g||null);null!=h&&(null==c&&(c=ad.empty()),c.set(f.field,h))}return c||null}function bc(a,b){var c,d;return a.type===b.type&&!!a.key.isEqual(b.key)&&!!a.precondition.isEqual(b.precondition)&&(c=a.fieldTransforms,d=b.fieldTransforms,!!(void 0===c&& void 0===d|| !(!c||!d)&&v(c,d,function(a,b){var c,d,e,f;return c=a,d=b,c.field.isEqual(d.field)&&(e=c.transform,f=d.transform,e instanceof aZ&&f instanceof aZ||e instanceof a_&&f instanceof a_?v(e.elements,f.elements,S):e instanceof a1&&f instanceof a1?S(e.A,f.A):e instanceof aY&&f instanceof aY)})))&&(0===a.type?a.value.isEqual(b.value):1!==a.type||a.data.isEqual(b.data)&&a.fieldMask.isEqual(b.fieldMask))}function bd(a){return a.isFoundDocument()?a.version:x.min()}var be=function(a){function b(b,c,d,e){void 0===e&&(e=[]);var f=this;return(f=a.call(this)||this).key=b,f.value=c,f.precondition=d,f.fieldTransforms=e,f.type=0,f}return(0,d.__extends)(b,a),b}(a8),bf=function(a){function b(b,c,d,e,f){void 0===f&&(f=[]);var g=this;return(g=a.call(this)||this).key=b,g.data=c,g.fieldMask=d,g.precondition=e,g.fieldTransforms=f,g.type=1,g}return(0,d.__extends)(b,a),b}(a8);function bg(a){var b=new Map;return a.fieldMask.fields.forEach(function(c){if(!c.isEmpty()){var d=a.data.field(c);b.set(c,d)}}),b}function bh(a,b,c){var d,e=new Map;(d=a.length===c.length)||r();for(var f=0;f<c.length;f++){var g=a[f],h=g.transform,i=b.data.field(g.field);e.set(g.field,aW(h,i,c[f]))}return e}function bi(a,b,c){for(var d=new Map,e=0,f=a;e<f.length;e++){var g=f[e],h=g.transform,i=c.data.field(g.field);d.set(g.field,aV(h,i,b))}return d}var bj,bk,bl=function(a){function b(b,c){var d=this;return(d=a.call(this)||this).key=b,d.precondition=c,d.type=2,d.fieldTransforms=[],d}return(0,d.__extends)(b,a),b}(a8),bm=function(a){function b(b,c){var d=this;return(d=a.call(this)||this).key=b,d.precondition=c,d.type=3,d.fieldTransforms=[],d}return(0,d.__extends)(b,a),b}(a8),bn=function(a){this.count=a};function bo(a){switch(a){case j.OK:return r();case j.CANCELLED:case j.UNKNOWN:case j.DEADLINE_EXCEEDED:case j.RESOURCE_EXHAUSTED:case j.INTERNAL:case j.UNAVAILABLE:case j.UNAUTHENTICATED:return!1;case j.INVALID_ARGUMENT:case j.NOT_FOUND:case j.ALREADY_EXISTS:case j.PERMISSION_DENIED:case j.FAILED_PRECONDITION:case j.ABORTED:case j.OUT_OF_RANGE:case j.UNIMPLEMENTED:case j.DATA_LOSS:return!0;default:return r()}}function bp(a){if(void 0===a)return o("GRPC error has no .code"),j.UNKNOWN;switch(a){case bj.OK:return j.OK;case bj.CANCELLED:return j.CANCELLED;case bj.UNKNOWN:return j.UNKNOWN;case bj.DEADLINE_EXCEEDED:return j.DEADLINE_EXCEEDED;case bj.RESOURCE_EXHAUSTED:return j.RESOURCE_EXHAUSTED;case bj.INTERNAL:return j.INTERNAL;case bj.UNAVAILABLE:return j.UNAVAILABLE;case bj.UNAUTHENTICATED:return j.UNAUTHENTICATED;case bj.INVALID_ARGUMENT:return j.INVALID_ARGUMENT;case bj.NOT_FOUND:return j.NOT_FOUND;case bj.ALREADY_EXISTS:return j.ALREADY_EXISTS;case bj.PERMISSION_DENIED:return j.PERMISSION_DENIED;case bj.FAILED_PRECONDITION:return j.FAILED_PRECONDITION;case bj.ABORTED:return j.ABORTED;case bj.OUT_OF_RANGE:return j.OUT_OF_RANGE;case bj.UNIMPLEMENTED:return j.UNIMPLEMENTED;case bj.DATA_LOSS:return j.DATA_LOSS;default:return r()}}(bk=bj||(bj={}))[bk.OK=0]="OK",bk[bk.CANCELLED=1]="CANCELLED",bk[bk.UNKNOWN=2]="UNKNOWN",bk[bk.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",bk[bk.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",bk[bk.NOT_FOUND=5]="NOT_FOUND",bk[bk.ALREADY_EXISTS=6]="ALREADY_EXISTS",bk[bk.PERMISSION_DENIED=7]="PERMISSION_DENIED",bk[bk.UNAUTHENTICATED=16]="UNAUTHENTICATED",bk[bk.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",bk[bk.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",bk[bk.ABORTED=10]="ABORTED",bk[bk.OUT_OF_RANGE=11]="OUT_OF_RANGE",bk[bk.UNIMPLEMENTED=12]="UNIMPLEMENTED",bk[bk.INTERNAL=13]="INTERNAL",bk[bk.UNAVAILABLE=14]="UNAVAILABLE",bk[bk.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ // An immutable sorted map implementation, based on a Left-leaning Red-Black
// tree.
var bq=function(){function a(a,b){this.comparator=a,this.root=b||bs.EMPTY}return a.prototype.insert=function(b,c){return new a(this.comparator,this.root.insert(b,c,this.comparator).copy(null,null,bs.BLACK,null,null))},a.prototype.remove=function(b){return new a(this.comparator,this.root.remove(b,this.comparator).copy(null,null,bs.BLACK,null,null))},a.prototype.get=function(a){for(var b=this.root;!b.isEmpty();){var c=this.comparator(a,b.key);if(0===c)return b.value;c<0?b=b.left:c>0&&(b=b.right)}return null},a.prototype.indexOf=function(a){for(var b=0,c=this.root;!c.isEmpty();){var d=this.comparator(a,c.key);if(0===d)return b+c.left.size;d<0?c=c.left:(b+=c.left.size+1,c=c.right)}return -1},a.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(a.prototype,"size",{get:function(){return this.root.size},enumerable:!1,configurable:!0}),a.prototype.minKey=function(){return this.root.minKey()},a.prototype.maxKey=function(){return this.root.maxKey()},a.prototype.inorderTraversal=function(a){return this.root.inorderTraversal(a)},a.prototype.forEach=function(a){this.inorderTraversal(function(b,c){return a(b,c),!1})},a.prototype.toString=function(){var a=[];return this.inorderTraversal(function(b,c){return a.push(b+":"+c),!1}),"{"+a.join(", ")+"}"},a.prototype.reverseTraversal=function(a){return this.root.reverseTraversal(a)},a.prototype.getIterator=function(){return new br(this.root,null,this.comparator,!1)},a.prototype.getIteratorFrom=function(a){return new br(this.root,a,this.comparator,!1)},a.prototype.getReverseIterator=function(){return new br(this.root,null,this.comparator,!0)},a.prototype.getReverseIteratorFrom=function(a){return new br(this.root,a,this.comparator,!0)},a}(),br=function(){function a(a,b,c,d){this.isReverse=d,this.nodeStack=[];for(var e=1;!a.isEmpty();)if(e=b?c(a.key,b):1,d&&(e*=-1),e<0)a=this.isReverse?a.left:a.right;else{if(0===e){this.nodeStack.push(a);break}this.nodeStack.push(a),a=this.isReverse?a.right:a.left}}return a.prototype.getNext=function(){var a=this.nodeStack.pop(),b={key:a.key,value:a.value};if(this.isReverse)for(a=a.left;!a.isEmpty();)this.nodeStack.push(a),a=a.right;else for(a=a.right;!a.isEmpty();)this.nodeStack.push(a),a=a.left;return b},a.prototype.hasNext=function(){return this.nodeStack.length>0},a.prototype.peek=function(){if(0===this.nodeStack.length)return null;var a=this.nodeStack[this.nodeStack.length-1];return{key:a.key,value:a.value}},a}(),bs=function(){function a(b,c,d,e,f){this.key=b,this.value=c,this.color=null!=d?d:a.RED,this.left=null!=e?e:a.EMPTY,this.right=null!=f?f:a.EMPTY,this.size=this.left.size+1+this.right.size}return a.prototype.copy=function(b,c,d,e,f){return new a(null!=b?b:this.key,null!=c?c:this.value,null!=d?d:this.color,null!=e?e:this.left,null!=f?f:this.right)},a.prototype.isEmpty=function(){return!1},a.prototype.inorderTraversal=function(a){return this.left.inorderTraversal(a)||a(this.key,this.value)||this.right.inorderTraversal(a)},a.prototype.reverseTraversal=function(a){return this.right.reverseTraversal(a)||a(this.key,this.value)||this.left.reverseTraversal(a)},a.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},a.prototype.minKey=function(){return this.min().key},a.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},a.prototype.insert=function(a,b,c){var d=this,e=c(a,d.key);return(d=e<0?d.copy(null,null,null,d.left.insert(a,b,c),null):0===e?d.copy(null,b,null,null,null):d.copy(null,null,null,null,d.right.insert(a,b,c))).fixUp()},a.prototype.removeMin=function(){if(this.left.isEmpty())return a.EMPTY;var b=this;return b.left.isRed()||b.left.left.isRed()||(b=b.moveRedLeft()),(b=b.copy(null,null,null,b.left.removeMin(),null)).fixUp()},a.prototype.remove=function(b,c){var d,e=this;if(0>c(b,e.key))e.left.isEmpty()||e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.remove(b,c),null);else{if(e.left.isRed()&&(e=e.rotateRight()),e.right.isEmpty()||e.right.isRed()||e.right.left.isRed()||(e=e.moveRedRight()),0===c(b,e.key)){if(e.right.isEmpty())return a.EMPTY;d=e.right.min(),e=e.copy(d.key,d.value,null,null,e.right.removeMin())}e=e.copy(null,null,null,null,e.right.remove(b,c))}return e.fixUp()},a.prototype.isRed=function(){return this.color},a.prototype.fixUp=function(){var a=this;return a.right.isRed()&&!a.left.isRed()&&(a=a.rotateLeft()),a.left.isRed()&&a.left.left.isRed()&&(a=a.rotateRight()),a.left.isRed()&&a.right.isRed()&&(a=a.colorFlip()),a},a.prototype.moveRedLeft=function(){var a=this.colorFlip();return a.right.left.isRed()&&(a=(a=(a=a.copy(null,null,null,null,a.right.rotateRight())).rotateLeft()).colorFlip()),a},a.prototype.moveRedRight=function(){var a=this.colorFlip();return a.left.left.isRed()&&(a=(a=a.rotateRight()).colorFlip()),a},a.prototype.rotateLeft=function(){var b=this.copy(null,null,a.RED,null,this.right.left);return this.right.copy(null,null,this.color,b,null)},a.prototype.rotateRight=function(){var b=this.copy(null,null,a.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,b)},a.prototype.colorFlip=function(){var a=this.left.copy(null,null,!this.left.color,null,null),b=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,a,b)},a.prototype.checkMaxDepth=function(){return Math.pow(2,this.check())<=this.size+1},a.prototype.check=function(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw r();var a=this.left.check();if(a!==this.right.check())throw r();return a+(this.isRed()?0:1)},a}();bs.EMPTY=null,bs.RED=!0,bs.BLACK=!1,bs.EMPTY=new(function(){function a(){this.size=0}return Object.defineProperty(a.prototype,"key",{get:function(){throw r()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"value",{get:function(){throw r()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"color",{get:function(){throw r()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"left",{get:function(){throw r()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"right",{get:function(){throw r()},enumerable:!1,configurable:!0}),a.prototype.copy=function(a,b,c,d,e){return this},a.prototype.insert=function(a,b,c){return new bs(a,b)},a.prototype.remove=function(a,b){return this},a.prototype.isEmpty=function(){return!0},a.prototype.inorderTraversal=function(a){return!1},a.prototype.reverseTraversal=function(a){return!1},a.prototype.minKey=function(){return null},a.prototype.maxKey=function(){return null},a.prototype.isRed=function(){return!1},a.prototype.checkMaxDepth=function(){return!0},a.prototype.check=function(){return 0},a}());/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * SortedSet is an immutable (copy-on-write) collection that holds elements
 * in order specified by the provided comparator.
 *
 * NOTE: if provided comparator returns 0 for two elements, we consider them to
 * be equal!
 */ var bt=function(){function a(a){this.comparator=a,this.data=new bq(this.comparator)}return a.prototype.has=function(a){return null!==this.data.get(a)},a.prototype.first=function(){return this.data.minKey()},a.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(a.prototype,"size",{get:function(){return this.data.size},enumerable:!1,configurable:!0}),a.prototype.indexOf=function(a){return this.data.indexOf(a)},a.prototype.forEach=function(a){this.data.inorderTraversal(function(b,c){return a(b),!1})},a.prototype.forEachInRange=function(a,b){for(var c=this.data.getIteratorFrom(a[0]);c.hasNext();){var d=c.getNext();if(this.comparator(d.key,a[1])>=0)return;b(d.key)}},a.prototype.forEachWhile=function(a,b){var c;for(c=void 0!==b?this.data.getIteratorFrom(b):this.data.getIterator();c.hasNext();)if(!a(c.getNext().key))return},a.prototype.firstAfterOrEqual=function(a){var b=this.data.getIteratorFrom(a);return b.hasNext()?b.getNext().key:null},a.prototype.getIterator=function(){return new bu(this.data.getIterator())},a.prototype.getIteratorFrom=function(a){return new bu(this.data.getIteratorFrom(a))},a.prototype.add=function(a){return this.copy(this.data.remove(a).insert(a,!0))},a.prototype.delete=function(a){return this.has(a)?this.copy(this.data.remove(a)):this},a.prototype.isEmpty=function(){return this.data.isEmpty()},a.prototype.unionWith=function(a){var b=this;return b.size<a.size&&(b=a,a=this),a.forEach(function(a){b=b.add(a)}),b},a.prototype.isEqual=function(b){if(!(b instanceof a)||this.size!==b.size)return!1;for(var c=this.data.getIterator(),d=b.data.getIterator();c.hasNext();){var e=c.getNext().key,f=d.getNext().key;if(0!==this.comparator(e,f))return!1}return!0},a.prototype.toArray=function(){var a=[];return this.forEach(function(b){a.push(b)}),a},a.prototype.toString=function(){var a=[];return this.forEach(function(b){return a.push(b)}),"SortedSet("+a.toString()+")"},a.prototype.copy=function(b){var c=new a(this.comparator);return c.data=b,c},a}(),bu=function(){function a(a){this.iter=a}return a.prototype.getNext=function(){return this.iter.getNext().key},a.prototype.hasNext=function(){return this.iter.hasNext()},a}(),bv=new bq(Q.comparator),bw=new bq(Q.comparator),bx=new bq(Q.comparator),by=new bt(Q.comparator);function bz(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];for(var c=by,d=0,e=a;d<e.length;d++){var f=e[d];c=c.add(f)}return c}var bA=new bt(u),bB=function(){function a(a,b,c,d,e){this.snapshotVersion=a,this.targetChanges=b,this.targetMismatches=c,this.documentUpdates=d,this.resolvedLimboDocuments=e}return a.createSynthesizedRemoteEventForCurrentChange=function(b,c){var d=new Map;return d.set(b,bC.createSynthesizedTargetChangeForCurrentChange(b,c)),new a(x.min(),d,bA,bv,bz())},a}(),bC=function(){function a(a,b,c,d,e){this.resumeToken=a,this.current=b,this.addedDocuments=c,this.modifiedDocuments=d,this.removedDocuments=e}return a.createSynthesizedTargetChangeForCurrentChange=function(b,c){return new a(G.EMPTY_BYTE_STRING,c,bz(),bz(),bz())},a}(),bD=function(a,b,c,d){this.v=a,this.removedTargetIds=b,this.key=c,this.P=d},bE=function(a,b){this.targetId=a,this.V=b},bF=function(a,b,c,d){void 0===c&&(c=G.EMPTY_BYTE_STRING),void 0===d&&(d=null),this.state=a,this.targetIds=b,this.resumeToken=c,this.cause=d},bG=function(){function a(){this.S=0,this.D=bJ(),this.C=G.EMPTY_BYTE_STRING,this.N=!1,this.F=!0}return Object.defineProperty(a.prototype,"current",{get:function(){return this.N},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"resumeToken",{get:function(){return this.C},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"k",{get:function(){return 0!==this.S},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"$",{get:function(){return this.F},enumerable:!1,configurable:!0}),a.prototype.O=function(a){a.approximateByteSize()>0&&(this.F=!0,this.C=a)},a.prototype.M=function(){var a=bz(),b=bz(),c=bz();return this.D.forEach(function(d,e){switch(e){case 0:a=a.add(d);break;case 2:b=b.add(d);break;case 1:c=c.add(d);break;default:r()}}),new bC(this.C,this.N,a,b,c)},a.prototype.L=function(){this.F=!1,this.D=bJ()},a.prototype.B=function(a,b){this.F=!0,this.D=this.D.insert(a,b)},a.prototype.q=function(a){this.F=!0,this.D=this.D.remove(a)},a.prototype.U=function(){this.S+=1},a.prototype.K=function(){this.S-=1},a.prototype.j=function(){this.F=!0,this.N=!0},a}(),bH=function(){function a(a){this.W=a,this.G=new Map,this.H=bv,this.J=bI(),this.Y=new bt(u)}return a.prototype.X=function(a){for(var b=0,c=a.v;b<c.length;b++){var d=c[b];a.P&&a.P.isFoundDocument()?this.Z(d,a.P):this.tt(d,a.key,a.P)}for(var e=0,f=a.removedTargetIds;e<f.length;e++)d=f[e],this.tt(d,a.key,a.P)},a.prototype.et=function(a){var b=this;this.forEachTarget(a,function(c){var d=b.nt(c);switch(a.state){case 0:b.st(c)&&d.O(a.resumeToken);break;case 1:d.K(),d.k||d.L(),d.O(a.resumeToken);break;case 2:d.K(),d.k||b.removeTarget(c);break;case 3:b.st(c)&&(d.j(),d.O(a.resumeToken));break;case 4:b.st(c)&&(b.it(c),d.O(a.resumeToken));break;default:r()}})},a.prototype.forEachTarget=function(a,b){var c=this;a.targetIds.length>0?a.targetIds.forEach(b):this.G.forEach(function(a,d){c.st(d)&&b(d)})},a.prototype.rt=function(a){var b=a.targetId,c=a.V.count,d=this.ot(b);if(d){var e=d.target;if(ak(e)){if(0===c){var f,g=new Q(e.path);this.tt(b,g,af.newNoDocument(g,x.min()))}else(f=1===c)||r()}else this.ct(b)!==c&&(this.it(b),this.Y=this.Y.add(b))}},a.prototype.ut=function(a){var b=this,c=new Map;this.G.forEach(function(d,e){var f=b.ot(e);if(f){if(d.current&&ak(f.target)){var g=new Q(f.target.path);null!==b.H.get(g)||b.at(e,g)||b.tt(e,g,af.newNoDocument(g,a))}d.$&&(c.set(e,d.M()),d.L())}});var d=bz();this.J.forEach(function(a,c){var e=!0;c.forEachWhile(function(a){var c=b.ot(a);return!c||2===c.purpose||(e=!1,!1)}),e&&(d=d.add(a))});var e=new bB(a,c,this.Y,this.H,d);return this.H=bv,this.J=bI(),this.Y=new bt(u),e},a.prototype.Z=function(a,b){if(this.st(a)){var c=this.at(a,b.key)?2:0;this.nt(a).B(b.key,c),this.H=this.H.insert(b.key,b),this.J=this.J.insert(b.key,this.ht(b.key).add(a))}},a.prototype.tt=function(a,b,c){if(this.st(a)){var d=this.nt(a);this.at(a,b)?d.B(b,1):d.q(b),this.J=this.J.insert(b,this.ht(b).delete(a)),c&&(this.H=this.H.insert(b,c))}},a.prototype.removeTarget=function(a){this.G.delete(a)},a.prototype.ct=function(a){var b=this.nt(a).M();return this.W.getRemoteKeysForTarget(a).size+b.addedDocuments.size-b.removedDocuments.size},a.prototype.U=function(a){this.nt(a).U()},a.prototype.nt=function(a){var b=this.G.get(a);return b||(b=new bG,this.G.set(a,b)),b},a.prototype.ht=function(a){var b=this.J.get(a);return b||(b=new bt(u),this.J=this.J.insert(a,b)),b},a.prototype.st=function(a){var b=null!==this.ot(a);return b||n("WatchChangeAggregator","Detected inactive target",a),b},a.prototype.ot=function(a){var b=this.G.get(a);return b&&b.k?null:this.W.lt(a)},a.prototype.it=function(a){var b=this;this.G.set(a,new bG),this.W.getRemoteKeysForTarget(a).forEach(function(c){b.tt(a,c,null)})},a.prototype.at=function(a,b){return this.W.getRemoteKeysForTarget(a).has(b)},a}();function bI(){return new bq(Q.comparator)}function bJ(){return new bq(Q.comparator)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var bK={asc:"ASCENDING",desc:"DESCENDING"},bL={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},bM=function(a,b){this.databaseId=a,this.I=b};function bN(a,b){return a.I?new Date(1e3*b.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")+"."+("000000000"+b.nanoseconds).slice(-9)+"Z":{seconds:""+b.seconds,nanos:b.nanoseconds}}function bO(a,b){return a.I?b.toBase64():b.toUint8Array()}function bP(a){var b,c,d;return!a&&r(),x.fromTimestamp((d=I(c=a),new w(d.seconds,d.nanos)))}function bQ(a,b){var c;return(c=a,new C(["projects",c.projectId,"databases",c.database])).child("documents").child(b).canonicalString()}function bR(a){var b,c=C.fromString(a);return cd(c)||r(),c}function bS(a,b){return bQ(a.databaseId,b.path)}function bT(a,b){var c=bR(b);if(c.get(1)!==a.databaseId.projectId)throw new k(j.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+c.get(1)+" vs "+a.databaseId.projectId);if(c.get(3)!==a.databaseId.database)throw new k(j.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+c.get(3)+" vs "+a.databaseId.database);return new Q(bX(c))}function bU(a,b){return bQ(a.databaseId,b)}function bV(a){var b=bR(a);return 4===b.length?C.emptyPath():bX(b)}function bW(a){return new C(["projects",a.databaseId.projectId,"databases",a.databaseId.database]).canonicalString()}function bX(a){var b;return a.length>4&&"documents"===a.get(4)||r(),a.popFirst(5)}function bY(a,b,c){return{name:bS(a,b),fields:c.value.mapValue.fields}}function bZ(a,b,c){var d=bT(a,b.name),e=bP(b.updateTime),f=new ad({mapValue:{fields:b.fields}}),g=af.newFoundDocument(d,e,f);return c&&g.setHasCommittedMutations(),c?g.setHasCommittedMutations():g}function b$(a,b){var c,d,e,f,g;if(b instanceof be)c={update:bY(a,b.key,b.value)};else if(b instanceof bl)c={delete:bS(a,b.key)};else if(b instanceof bf)c={update:bY(a,b.key,b.data),updateMask:cc(b.fieldMask)};else{if(!(b instanceof bm))return r();c={verify:bS(a,b.key)}}return b.fieldTransforms.length>0&&(c.updateTransforms=b.fieldTransforms.map(function(a){return function(a,b){var c=b.transform;if(c instanceof aY)return{fieldPath:b.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(c instanceof aZ)return{fieldPath:b.field.canonicalString(),appendMissingElements:{values:c.elements}};if(c instanceof a_)return{fieldPath:b.field.canonicalString(),removeAllFromArray:{values:c.elements}};if(c instanceof a1)return{fieldPath:b.field.canonicalString(),increment:c.A};throw r()}(0,a)})),b.precondition.isNone||(c.currentDocument=(d=a,void 0!==(e=b.precondition).updateTime?{updateTime:(f=d,bN(f,(g=e.updateTime).toTimestamp()))}:void 0!==e.exists?{exists:e.exists}:r())),c}function b_(a,b){var c,d=b.currentDocument?void 0!==(c=b.currentDocument).updateTime?a6.updateTime(bP(c.updateTime)):void 0!==c.exists?a6.exists(c.exists):a6.none():a6.none(),e=b.updateTransforms?b.updateTransforms.map(function(b){return function(a,b){var c,d=null;if("setToServerValue"in b)"REQUEST_TIME"===b.setToServerValue||r(),d=new aY;else if("appendMissingElements"in b){var e=b.appendMissingElements.values||[];d=new aZ(e)}else if("removeAllFromArray"in b){var f=b.removeAllFromArray.values||[];d=new a_(f)}else"increment"in b?d=new a1(a,b.increment):r();var g=E.fromServerFormat(b.fieldPath);return new a4(g,d)}(a,b)}):[];if(b.update){b.update.name;var f=bT(a,b.update.name),g=new ad({mapValue:{fields:b.update.fields}});if(b.updateMask){var h,i,j=(i=(h=b.updateMask).fieldPaths||[],new F(i.map(function(a){return E.fromServerFormat(a)})));return new bf(f,g,j,d,e)}return new be(f,g,d,e)}if(b.delete){var k=bT(a,b.delete);return new bl(k,d)}if(b.verify){var l=bT(a,b.verify);return new bm(l,d)}return r()}function b0(a,b){return{documents:[bU(a,b.path)]}}function b1(a,b){var c={structuredQuery:{}},d=b.path;null!==b.collectionGroup?(c.parent=bU(a,d),c.structuredQuery.from=[{collectionId:b.collectionGroup,allDescendants:!0}]):(c.parent=bU(a,d.popLast()),c.structuredQuery.from=[{collectionId:d.lastSegment()}]);var e=function(a){if(0!==a.length){var b=a.map(function(a){return function(a){if("=="===a.op){if(aa(a.value))return{unaryFilter:{field:b8(a.field),op:"IS_NAN"}};if(_(a.value))return{unaryFilter:{field:b8(a.field),op:"IS_NULL"}}}else if("!="===a.op){if(aa(a.value))return{unaryFilter:{field:b8(a.field),op:"IS_NOT_NAN"}};if(_(a.value))return{unaryFilter:{field:b8(a.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:b8(a.field),op:b7(a.op),value:a.value}}}(a)});return 1===b.length?b[0]:{compositeFilter:{op:"AND",filters:b}}}}(b.filters);e&&(c.structuredQuery.where=e);var f,g,h,i=function(a){if(0!==a.length)return a.map(function(a){var b;return{field:b8((b=a).field),direction:b6(b.dir)}})}(b.orderBy);i&&(c.structuredQuery.orderBy=i);var j=(f=a,g=b.limit,f.I||null==(h=g)?g:{value:g});return null!==j&&(c.structuredQuery.limit=j),b.startAt&&(c.structuredQuery.startAt=b4(b.startAt)),b.endAt&&(c.structuredQuery.endAt=b4(b.endAt)),c}function b2(a){var b=bV(a.parent),c=a.structuredQuery,d=c.from?c.from.length:0,e=null;if(d>0){(f=1===d)||r();var f,g=c.from[0];g.allDescendants?e=g.collectionId:b=b.child(g.collectionId)}var h=[];c.where&&(h=b3(c.where));var i=[];c.orderBy&&(i=c.orderBy.map(function(a){var b;return b=a,new aw(b9(b.field),function(a){switch(a){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(b.direction))}));var j,k,l,m=null;c.limit&&(m=null==(l=k="object"==typeof(j=c.limit)?j.value:j)?null:k);var n=null;c.startAt&&(n=b5(c.startAt));var o=null;return c.endAt&&(o=b5(c.endAt)),aB(b,e,i,h,m,"F",n,o)}function b3(a){return a?void 0!==a.unaryFilter?[cb(a)]:void 0!==a.fieldFilter?[ca(a)]:void 0!==a.compositeFilter?a.compositeFilter.filters.map(function(a){return b3(a)}).reduce(function(a,b){return a.concat(b)}):r():[]}function b4(a){return{before:a.before,values:a.position}}function b5(a){var b=!!a.before,c=a.values||[];return new au(c,b)}function b6(a){return bK[a]}function b7(a){return bL[a]}function b8(a){return{fieldPath:a.canonicalString()}}function b9(a){return E.fromServerFormat(a.fieldPath)}function ca(a){return al.create(b9(a.fieldFilter.field),function(a){switch(a){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return r()}}(a.fieldFilter.op),a.fieldFilter.value)}function cb(a){switch(a.unaryFilter.op){case"IS_NAN":var b=b9(a.unaryFilter.field);return al.create(b,"==",{doubleValue:NaN});case"IS_NULL":var c=b9(a.unaryFilter.field);return al.create(c,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var d=b9(a.unaryFilter.field);return al.create(d,"!=",{doubleValue:NaN});case"IS_NOT_NULL":var e=b9(a.unaryFilter.field);return al.create(e,"!=",{nullValue:"NULL_VALUE"});default:return r()}}function cc(a){var b=[];return a.fields.forEach(function(a){return b.push(a.canonicalString())}),{fieldPaths:b}}function cd(a){return a.length>=4&&"projects"===a.get(0)&&"databases"===a.get(2)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Encodes a resource path into a IndexedDb-compatible string form.
 */ function ce(a){for(var b,c,d="",e=0;e<a.length;e++){d.length>0&&(d=(b=d,b+"\x01\x01")),d=cf(a.get(e),d)}return c=d,c+"\x01\x01"}function cf(a,b){for(var c=b,d=a.length,e=0;e<d;e++){var f=a.charAt(e);switch(f){case"\0":c+="\x01\x10";break;case"\x01":c+="\x01\x11";break;default:c+=f}}return c}function cg(a){var b,c,d=a.length;if(d>=2||r(),2===d)return"\x01"===a.charAt(0)&&"\x01"===a.charAt(1)||r(),C.emptyPath();for(var e=d-2,f=[],g="",h=0;h<d;){var i=a.indexOf("\x01",h);switch((i<0||i>e)&&r(),a.charAt(i+1)){case"\x01":var j=a.substring(h,i),k=void 0;0===g.length?k=j:(k=g+=j,g=""),f.push(k);break;case"\x10":g+=a.substring(h,i),g+="\0";break;case"\x11":g+=a.substring(h,i+1);break;default:r()}h=i+2}return new C(f)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Schema Version for the Web client:
 * 1.  Initial version including Mutation Queue, Query Cache, and Remote
 *     Document Cache
 * 2.  Used to ensure a targetGlobal object exists and add targetCount to it. No
 *     longer required because migration 3 unconditionally clears it.
 * 3.  Dropped and re-created Query Cache to deal with cache corruption related
 *     to limbo resolution. Addresses
 *     https://github.com/firebase/firebase-ios-sdk/issues/1548
 * 4.  Multi-Tab Support.
 * 5.  Removal of held write acks.
 * 6.  Create document global for tracking document cache size.
 * 7.  Ensure every cached document has a sentinel row with a sequence number.
 * 8.  Add collection-parent index for Collection Group queries.
 * 9.  Change RemoteDocumentChanges store to be keyed by readTime rather than
 *     an auto-incrementing ID. This is required for Index-Free queries.
 * 10. Rewrite the canonical IDs to the explicit Protobuf-based format.
 * 11. Add bundles and named_queries for bundle support.
 */ /**
 * Wrapper class to store timestamps (seconds and nanos) in IndexedDb objects.
 */ var ch=function(a,b){this.seconds=a,this.nanoseconds=b},ci=function(a,b,c){this.ownerId=a,this.allowTabSynchronization=b,this.leaseTimestampMs=c};ci.store="owner",ci.key="owner";var cj=function(a,b,c){this.userId=a,this.lastAcknowledgedBatchId=b,this.lastStreamToken=c};cj.store="mutationQueues",cj.keyPath="userId";var ck=function(a,b,c,d,e){this.userId=a,this.batchId=b,this.localWriteTimeMs=c,this.baseMutations=d,this.mutations=e};ck.store="mutations",ck.keyPath="batchId",ck.userMutationsIndex="userMutationsIndex",ck.userMutationsKeyPath=["userId","batchId"];var cl=function(){function a(){}return a.prefixForUser=function(a){return[a]},a.prefixForPath=function(a,b){return[a,ce(b)]},a.key=function(a,b,c){return[a,ce(b),c]},a}();cl.store="documentMutations",cl.PLACEHOLDER=new cl;var cm=function(a,b){this.path=a,this.readTime=b},cn=function(a,b){this.path=a,this.version=b},co=function(a,b,c,d,e,f){this.unknownDocument=a,this.noDocument=b,this.document=c,this.hasCommittedMutations=d,this.readTime=e,this.parentPath=f};co.store="remoteDocuments",co.readTimeIndex="readTimeIndex",co.readTimeIndexPath="readTime",co.collectionReadTimeIndex="collectionReadTimeIndex",co.collectionReadTimeIndexPath=["parentPath","readTime"];var cp=function(a){this.byteSize=a};cp.store="remoteDocumentGlobal",cp.key="remoteDocumentGlobalKey";var cq=function(a,b,c,d,e,f,g){this.targetId=a,this.canonicalId=b,this.readTime=c,this.resumeToken=d,this.lastListenSequenceNumber=e,this.lastLimboFreeSnapshotVersion=f,this.query=g};cq.store="targets",cq.keyPath="targetId",cq.queryTargetsIndexName="queryTargetsIndex",cq.queryTargetsKeyPath=["canonicalId","targetId"];var cr=function(a,b,c){this.targetId=a,this.path=b,this.sequenceNumber=c};cr.store="targetDocuments",cr.keyPath=["targetId","path"],cr.documentTargetsIndex="documentTargetsIndex",cr.documentTargetsKeyPath=["path","targetId"];var cs=function(a,b,c,d){this.highestTargetId=a,this.highestListenSequenceNumber=b,this.lastRemoteSnapshotVersion=c,this.targetCount=d};cs.key="targetGlobalKey",cs.store="targetGlobal";var ct=function(a,b){this.collectionId=a,this.parent=b};ct.store="collectionParents",ct.keyPath=["collectionId","parent"];var cu=function(a,b,c,d){this.clientId=a,this.updateTimeMs=b,this.networkEnabled=c,this.inForeground=d};cu.store="clientMetadata",cu.keyPath="clientId";var cv=function(a,b,c){this.bundleId=a,this.createTime=b,this.version=c};cv.store="bundles",cv.keyPath="bundleId";var cw=function(a,b,c){this.name=a,this.readTime=b,this.bundledQuery=c};cw.store="namedQueries",cw.keyPath="name";var cx=(0,d.__spreadArray)((0,d.__spreadArray)([],(0,d.__spreadArray)((0,d.__spreadArray)([],(0,d.__spreadArray)((0,d.__spreadArray)([],(0,d.__spreadArray)((0,d.__spreadArray)([],[cj.store,ck.store,cl.store,co.store,cq.store,ci.store,cs.store,cr.store]),[cu.store])),[cp.store])),[ct.store])),[cv.store,cw.store]),cy="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",cz=function(){function a(){this.onCommittedListeners=[]}return a.prototype.addOnCommittedListener=function(a){this.onCommittedListeners.push(a)},a.prototype.raiseOnCommittedEvent=function(){this.onCommittedListeners.forEach(function(a){return a()})},a}(),cA=function(){var a=this;this.promise=new Promise(function(b,c){a.resolve=b,a.reject=c})},cB=function(){function a(a){var b=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,a(function(a){b.isDone=!0,b.result=a,b.nextCallback&&b.nextCallback(a)},function(a){b.isDone=!0,b.error=a,b.catchCallback&&b.catchCallback(a)})}return a.prototype.catch=function(a){return this.next(void 0,a)},a.prototype.next=function(b,c){var d=this;return this.callbackAttached&&r(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(c,this.error):this.wrapSuccess(b,this.result):new a(function(a,e){d.nextCallback=function(c){d.wrapSuccess(b,c).next(a,e)},d.catchCallback=function(b){d.wrapFailure(c,b).next(a,e)}})},a.prototype.toPromise=function(){var a=this;return new Promise(function(b,c){a.next(b,c)})},a.prototype.wrapUserFunction=function(b){try{var c=b();return c instanceof a?c:a.resolve(c)}catch(d){return a.reject(d)}},a.prototype.wrapSuccess=function(b,c){return b?this.wrapUserFunction(function(){return b(c)}):a.resolve(c)},a.prototype.wrapFailure=function(b,c){return b?this.wrapUserFunction(function(){return b(c)}):a.reject(c)},a.resolve=function(b){return new a(function(a,c){a(b)})},a.reject=function(b){return new a(function(a,c){c(b)})},a.waitFor=function(b){return new a(function(a,c){var d=0,e=0,f=!1;b.forEach(function(b){++d,b.next(function(){++e,f&&e===d&&a()},function(a){return c(a)})}),f=!0,e===d&&a()})},a.or=function(b){for(var c=a.resolve(!1),d=function(b){c=c.next(function(c){return c?a.resolve(c):b()})},e=0,f=b;e<f.length;e++)d(f[e]);return c},a.forEach=function(a,b){var c=this,d=[];return a.forEach(function(a,e){d.push(b.call(c,a,e))}),this.waitFor(d)},a}(),cC=function(){function a(a,b){var c=this;this.action=a,this.transaction=b,this.aborted=!1,this.ft=new cA,this.transaction.oncomplete=function(){c.ft.resolve()},this.transaction.onabort=function(){b.error?c.ft.reject(new cF(a,b.error)):c.ft.resolve()},this.transaction.onerror=function(b){var d=cK(b.target.error);c.ft.reject(new cF(a,d))}}return a.open=function(b,c,d,e){try{return new a(c,b.transaction(e,d))}catch(f){throw new cF(c,f)}},Object.defineProperty(a.prototype,"dt",{get:function(){return this.ft.promise},enumerable:!1,configurable:!0}),a.prototype.abort=function(a){a&&this.ft.reject(a),this.aborted||(n("SimpleDb","Aborting transaction:",a?a.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},a.prototype.store=function(a){var b=this.transaction.objectStore(a);return new cH(b)},a}(),cD=function(){function a(b,c,d){this.name=b,this.version=c,this.wt=d,12.2===a._t((0,e.getUA)())&&o("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}return a.delete=function(a){return n("SimpleDb","Removing database:",a),cI(window.indexedDB.deleteDatabase(a)).toPromise()},a.yt=function(){if("undefined"==typeof indexedDB)return!1;if(a.gt())return!0;var b=(0,e.getUA)(),c=a._t(b),d=0<c&&c<10,f=a.Et(b),g=0<f&&f<4.5;return!(b.indexOf("MSIE ")>0||b.indexOf("Trident/")>0||b.indexOf("Edge/")>0||d||g)},a.gt=function(){var a;return void 0!==h&&"YES"===(null===(a=h.env)|| void 0===a?void 0:a.Tt)},a.It=function(a,b){return a.store(b)},a._t=function(a){var b=a.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(b?b[1].split("_").slice(0,2).join("."):"-1")},a.Et=function(a){var b=a.match(/Android ([\d.]+)/i);return Number(b?b[1].split(".").slice(0,2).join("."):"-1")},a.prototype.At=function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b,c=this;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return this.db?[3,2]:(n("SimpleDb","Opening database:",this.name),b=this,[4,new Promise(function(b,d){var e=indexedDB.open(c.name,c.version);e.onsuccess=function(a){b(a.target.result)},e.onblocked=function(){d(new cF(a,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},e.onerror=function(b){var c=b.target.error;"VersionError"===c.name?d(new k(j.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):d(new cF(a,c))},e.onupgradeneeded=function(a){n("SimpleDb",'Database "'+c.name+'" requires upgrade from version:',a.oldVersion);var b=a.target.result;c.wt.Rt(b,e.transaction,a.oldVersion,c.version).next(function(){n("SimpleDb","Database upgrade to version "+c.version+" complete")})}})]);case 1:b.db=d.sent(),d.label=2;case 2:return[2,(this.bt&&(this.db.onversionchange=function(a){return c.bt(a)}),this.db)]}})})},a.prototype.vt=function(a){this.bt=a,this.db&&(this.db.onversionchange=function(b){return a(b)})},a.prototype.runTransaction=function(a,b,c,e){return(0,d.__awaiter)(this,void 0,void 0,function(){var f,g,h,i,j;return(0,d.__generator)(this,function(k){switch(k.label){case 0:f="readonly"===b,g=0,h=function(){var b,h,j,k,l;return(0,d.__generator)(this,function(d){switch(d.label){case 0:++g,d.label=1;case 1:return d.trys.push([1,4,,5]),[4,i.At(a)];case 2:return i.db=d.sent(),h=e(b=cC.open(i.db,a,f?"readonly":"readwrite",c)).catch(function(a){return b.abort(a),cB.reject(a)}).toPromise(),j={},h.catch(function(){}),[4,b.dt];case 3:return[2,(j.value=(d.sent(),h),j)];case 4:return l="FirebaseError"!==(k=d.sent()).name&&g<3,n("SimpleDb","Transaction failed with error:",k.message,"Retrying:",l),i.close(),l?[3,5]:[2,{value:Promise.reject(k)}];case 5:return[2]}})},i=this,k.label=1;case 1:return[5,h()];case 2:if("object"==typeof(j=k.sent()))return[2,j.value];k.label=3;case 3:return[3,1];case 4:return[2]}})})},a.prototype.close=function(){this.db&&this.db.close(),this.db=void 0},a}(),cE=function(){function a(a){this.Pt=a,this.Vt=!1,this.St=null}return Object.defineProperty(a.prototype,"isDone",{get:function(){return this.Vt},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"Dt",{get:function(){return this.St},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"cursor",{set:function(a){this.Pt=a},enumerable:!1,configurable:!0}),a.prototype.done=function(){this.Vt=!0},a.prototype.Ct=function(a){this.St=a},a.prototype.delete=function(){return cI(this.Pt.delete())},a}(),cF=function(a){function b(b,c){var d=this;return(d=a.call(this,j.UNAVAILABLE,"IndexedDB transaction '"+b+"' failed: "+c)||this).name="IndexedDbTransactionError",d}return(0,d.__extends)(b,a),b}(k);function cG(a){return"IndexedDbTransactionError"===a.name}var cH=function(){function a(a){this.store=a}return a.prototype.put=function(a,b){var c;return void 0!==b?(n("SimpleDb","PUT",this.store.name,a,b),c=this.store.put(b,a)):(n("SimpleDb","PUT",this.store.name,"<auto-key>",a),c=this.store.put(a)),cI(c)},a.prototype.add=function(a){return n("SimpleDb","ADD",this.store.name,a,a),cI(this.store.add(a))},a.prototype.get=function(a){var b=this;return cI(this.store.get(a)).next(function(c){return void 0===c&&(c=null),n("SimpleDb","GET",b.store.name,a,c),c})},a.prototype.delete=function(a){return n("SimpleDb","DELETE",this.store.name,a),cI(this.store.delete(a))},a.prototype.count=function(){return n("SimpleDb","COUNT",this.store.name),cI(this.store.count())},a.prototype.Nt=function(a,b){var c=this.cursor(this.options(a,b)),d=[];return this.xt(c,function(a,b){d.push(b)}).next(function(){return d})},a.prototype.Ft=function(a,b){n("SimpleDb","DELETE ALL",this.store.name);var c=this.options(a,b);c.kt=!1;var d=this.cursor(c);return this.xt(d,function(a,b,c){return c.delete()})},a.prototype.$t=function(a,b){b?c=a:(c={},b=a);var c,d=this.cursor(c);return this.xt(d,b)},a.prototype.Ot=function(a){var b=this.cursor({});return new cB(function(c,d){b.onerror=function(a){var b=cK(a.target.error);d(b)},b.onsuccess=function(b){var d=b.target.result;d?a(d.primaryKey,d.value).next(function(a){a?d.continue():c()}):c()}})},a.prototype.xt=function(a,b){var c=[];return new cB(function(d,e){a.onerror=function(a){e(a.target.error)},a.onsuccess=function(a){var e=a.target.result;if(e){var f=new cE(e),g=b(e.primaryKey,e.value,f);if(g instanceof cB){var h=g.catch(function(a){return f.done(),cB.reject(a)});c.push(h)}f.isDone?d():null===f.Dt?e.continue():e.continue(f.Dt)}else d()}}).next(function(){return cB.waitFor(c)})},a.prototype.options=function(a,b){var c;return void 0!==a&&("string"==typeof a?c=a:b=a),{index:c,range:b}},a.prototype.cursor=function(a){var b="next";if(a.reverse&&(b="prev"),a.index){var c=this.store.index(a.index);return a.kt?c.openKeyCursor(a.range,b):c.openCursor(a.range,b)}return this.store.openCursor(a.range,b)},a}();function cI(a){return new cB(function(b,c){a.onsuccess=function(a){b(a.target.result)},a.onerror=function(a){var b=cK(a.target.error);c(b)}})}var cJ=!1;function cK(a){var b=cD._t((0,e.getUA)());if(b>=12.2&&b<13){var c="An internal error was encountered in the Indexed Database server";if(a.message.indexOf(c)>=0){var d=new k("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+c+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return cJ||(cJ=!0,setTimeout(function(){throw d},0)),d}}return a}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var cL=function(a){function b(b,c){var d=this;return(d=a.call(this)||this).Mt=b,d.currentSequenceNumber=c,d}return(0,d.__extends)(b,a),b}(cz);function cM(a,b){var c,d=c=a;return cD.It(d.Mt,b)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A batch of mutations that will be sent as one unit to the backend.
 */ var cN=function(){function a(a,b,c,d){this.batchId=a,this.localWriteTime=b,this.baseMutations=c,this.mutations=d}return a.prototype.applyToRemoteDocument=function(a,b){for(var c=b.mutationResults,d=0;d<this.mutations.length;d++){var e=this.mutations[d];e.key.isEqual(a.key)&&a9(e,a,c[d])}},a.prototype.applyToLocalView=function(a){for(var b,c=0,d=this.baseMutations;c<d.length;c++)(b=d[c]).key.isEqual(a.key)&&ba(b,a,this.localWriteTime);for(var e=0,f=this.mutations;e<f.length;e++)(b=f[e]).key.isEqual(a.key)&&ba(b,a,this.localWriteTime)},a.prototype.applyToLocalDocumentSet=function(a){var b=this;this.mutations.forEach(function(c){var d=a.get(c.key),e=d;b.applyToLocalView(e),d.isValidDocument()||e.convertToNoDocument(x.min())})},a.prototype.keys=function(){return this.mutations.reduce(function(a,b){return a.add(b.key)},bz())},a.prototype.isEqual=function(a){return this.batchId===a.batchId&&v(this.mutations,a.mutations,function(a,b){return bc(a,b)})&&v(this.baseMutations,a.baseMutations,function(a,b){return bc(a,b)})},a}(),cO=function(){function a(a,b,c,d){this.batch=a,this.commitVersion=b,this.mutationResults=c,this.docVersions=d}return a.from=function(b,c,d){var e;(e=b.mutations.length===d.length)||r();for(var f=bx,g=b.mutations,h=0;h<g.length;h++)f=f.insert(g[h].key,d[h].version);return new a(b,c,d,f)},a}(),cP=function(){function a(a,b,c,d,e,f,g){void 0===e&&(e=x.min()),void 0===f&&(f=x.min()),void 0===g&&(g=G.EMPTY_BYTE_STRING),this.target=a,this.targetId=b,this.purpose=c,this.sequenceNumber=d,this.snapshotVersion=e,this.lastLimboFreeSnapshotVersion=f,this.resumeToken=g}return a.prototype.withSequenceNumber=function(b){return new a(this.target,this.targetId,this.purpose,b,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)},a.prototype.withResumeToken=function(b,c){return new a(this.target,this.targetId,this.purpose,this.sequenceNumber,c,this.lastLimboFreeSnapshotVersion,b)},a.prototype.withLastLimboFreeSnapshotVersion=function(b){return new a(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,b,this.resumeToken)},a}(),cQ=function(a){this.Lt=a};function cR(a,b){if(b.document)return bZ(a.Lt,b.document,!!b.hasCommittedMutations);if(b.noDocument){var c=Q.fromSegments(b.noDocument.path),d=cW(b.noDocument.readTime),e=af.newNoDocument(c,d);return b.hasCommittedMutations?e.setHasCommittedMutations():e}if(b.unknownDocument){var f=Q.fromSegments(b.unknownDocument.path);return d=cW(b.unknownDocument.version),af.newUnknownDocument(f,d)}return r()}function cS(a,b,c){var d=cT(c),e=b.key.path.popLast().toArray();if(b.isFoundDocument()){var f,g,h=(f=a.Lt,{name:bS(f,(g=b).key),fields:g.data.value.mapValue.fields,updateTime:bN(f,g.version.toTimestamp())}),i=b.hasCommittedMutations;return new co(null,null,h,i,d,e)}if(b.isNoDocument()){var j=b.key.path.toArray(),k=cV(b.version);return i=b.hasCommittedMutations,new co(null,new cm(j,k),null,i,d,e)}if(b.isUnknownDocument()){var l=b.key.path.toArray(),m=cV(b.version);return new co(new cn(l,m),null,null,!0,d,e)}return r()}function cT(a){var b=a.toTimestamp();return[b.seconds,b.nanoseconds]}function cU(a){var b=new w(a[0],a[1]);return x.fromTimestamp(b)}function cV(a){var b=a.toTimestamp();return new ch(b.seconds,b.nanoseconds)}function cW(a){var b=new w(a.seconds,a.nanoseconds);return x.fromTimestamp(b)}function cX(a,b){for(var c=(b.baseMutations||[]).map(function(b){return b_(a.Lt,b)}),d=0;d<b.mutations.length-1;++d){var e=b.mutations[d];if(d+1<b.mutations.length&& void 0!==b.mutations[d+1].transform){var f=b.mutations[d+1];e.updateTransforms=f.transform.fieldTransforms,b.mutations.splice(d+1,1),++d}}var g=b.mutations.map(function(b){return b_(a.Lt,b)}),h=w.fromMillis(b.localWriteTimeMs);return new cN(b.batchId,h,c,g)}function cY(a){var b,c,d,e,f=cW(a.readTime),g=void 0!==a.lastLimboFreeSnapshotVersion?cW(a.lastLimboFreeSnapshotVersion):x.min();return void 0!==a.query.documents?(1===(c=a.query).documents.length||r(),b=aJ(aC(bV(c.documents[0])))):b=aJ(b2(e=a.query)),new cP(b,a.targetId,0,a.lastListenSequenceNumber,f,g,G.fromBase64String(a.resumeToken))}function cZ(a,b){var c,d=cV(b.snapshotVersion),e=cV(b.lastLimboFreeSnapshotVersion);c=ak(b.target)?b0(a.Lt,b.target):b1(a.Lt,b.target);var f=b.resumeToken.toBase64();return new cq(b.targetId,ai(b.target),d,f,b.sequenceNumber,e,c)}function c$(a){var b=b2({parent:a.parent,structuredQuery:a.structuredQuery});return"LAST"===a.limitType?aK(b,b.limit,"L"):b}/** Encodes a NamedQuery proto object to a NamedQuery model object. */ /**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var c_=function(){function a(){}return a.prototype.getBundleMetadata=function(a,b){return c0(a).get(b).next(function(a){var b;if(a)return{id:(b=a).bundleId,createTime:cW(b.createTime),version:b.version}})},a.prototype.saveBundleMetadata=function(a,b){var c;return c0(a).put({bundleId:(c=b).id,createTime:cV(bP(c.createTime)),version:c.version})},a.prototype.getNamedQuery=function(a,b){return c1(a).get(b).next(function(a){var b;if(a)return{name:(b=a).name,query:c$(b.bundledQuery),readTime:cW(b.readTime)}})},a.prototype.saveNamedQuery=function(a,b){var c;return c1(a).put({name:(c=b).name,readTime:cV(bP(c.readTime)),bundledQuery:c.bundledQuery})},a}();function c0(a){return cM(a,cv.store)}function c1(a){return cM(a,cw.store)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * An in-memory implementation of IndexManager.
 */ var c2=function(){function a(){this.Bt=new c3}return a.prototype.addToCollectionParentIndex=function(a,b){return this.Bt.add(b),cB.resolve()},a.prototype.getCollectionParents=function(a,b){return cB.resolve(this.Bt.getEntries(b))},a}(),c3=function(){function a(){this.index={}}return a.prototype.add=function(a){var b=a.lastSegment(),c=a.popLast(),d=this.index[b]||new bt(C.comparator),e=!d.has(c);return this.index[b]=d.add(c),e},a.prototype.has=function(a){var b=a.lastSegment(),c=a.popLast(),d=this.index[b];return d&&d.has(c)},a.prototype.getEntries=function(a){return(this.index[a]||new bt(C.comparator)).toArray()},a}(),c4=function(){function a(){this.qt=new c3}return a.prototype.addToCollectionParentIndex=function(a,b){var c=this;if(!this.qt.has(b)){var d=b.lastSegment(),e=b.popLast();a.addOnCommittedListener(function(){c.qt.add(b)});var f={collectionId:d,parent:ce(e)};return c5(a).put(f)}return cB.resolve()},a.prototype.getCollectionParents=function(a,b){var c,d=[],e=IDBKeyRange.bound([b,""],[(c=b)+"\0",""],!1,!0);return c5(a).Nt(e).next(function(a){for(var c=0,e=a;c<e.length;c++){var f=e[c];if(f.collectionId!==b)break;d.push(cg(f.parent))}return d})},a}();function c5(a){return cM(a,ct.store)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var c6={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},c7=function(){function a(a,b,c){this.cacheSizeCollectionThreshold=a,this.percentileToCollect=b,this.maximumSequenceNumbersToCollect=c}return a.withCacheSize=function(b){return new a(b,a.DEFAULT_COLLECTION_PERCENTILE,a.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},a}();/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Delete a mutation batch and the associated document mutations.
 * @returns A PersistencePromise of the document mutations that were removed.
 */ function c8(a,b,c){var d=a.store(ck.store),e=a.store(cl.store),f=[],g=IDBKeyRange.only(c.batchId),h=0,i=d.$t({range:g},function(a,b,c){return h++,c.delete()});f.push(i.next(function(){var a;(a=1===h)||r()}));for(var j=[],k=0,l=c.mutations;k<l.length;k++){var m=l[k],n=cl.key(b,m.key.path,c.batchId);f.push(e.delete(n)),j.push(m.key)}return cB.waitFor(f).next(function(){return j})}function c9(a){var b;if(!a)return 0;if(a.document)b=a.document;else if(a.unknownDocument)b=a.unknownDocument;else{if(!a.noDocument)throw r();b=a.noDocument}return JSON.stringify(b).length}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** A mutation queue for a specific user, backed by IndexedDB. */ c7.DEFAULT_COLLECTION_PERCENTILE=10,c7.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,c7.DEFAULT=new c7(41943040,c7.DEFAULT_COLLECTION_PERCENTILE,c7.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),c7.DISABLED=new c7(-1,0,0);var da=function(){function a(a,b,c,d){this.userId=a,this.R=b,this.Ut=c,this.referenceDelegate=d,this.Kt={}}return a.Qt=function(b,c,d,e){var f;return""!==b.uid||r(),new a(b.isAuthenticated()?b.uid:"",c,d,e)},a.prototype.checkEmpty=function(a){var b=!0,c=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return dc(a).$t({index:ck.userMutationsIndex,range:c},function(a,c,d){b=!1,d.done()}).next(function(){return b})},a.prototype.addMutationBatch=function(a,b,c,d){var e=this,f=dd(a),g=dc(a);return g.add({}).next(function(h){var i,j,k,l,m,n;(i="number"==typeof h)||r();for(var o=new cN(h,b,c,d),p=(j=e.R,k=e.userId,l=o,m=l.baseMutations.map(function(a){return b$(j.Lt,a)}),n=l.mutations.map(function(a){return b$(j.Lt,a)}),new ck(k,l.batchId,l.localWriteTime.toMillis(),m,n)),q=[],s=new bt(function(a,b){return u(a.canonicalString(),b.canonicalString())}),t=0,v=d;t<v.length;t++){var w=v[t],x=cl.key(e.userId,w.key.path,h);s=s.add(w.key.path.popLast()),q.push(g.put(p)),q.push(f.put(x,cl.PLACEHOLDER))}return s.forEach(function(b){q.push(e.Ut.addToCollectionParentIndex(a,b))}),a.addOnCommittedListener(function(){e.Kt[h]=o.keys()}),cB.waitFor(q).next(function(){return o})})},a.prototype.lookupMutationBatch=function(a,b){var c=this;return dc(a).get(b).next(function(a){var b;return a?(a.userId===c.userId||r(),cX(c.R,a)):null})},a.prototype.jt=function(a,b){var c=this;return this.Kt[b]?cB.resolve(this.Kt[b]):this.lookupMutationBatch(a,b).next(function(a){if(a){var d=a.keys();return c.Kt[b]=d,d}return null})},a.prototype.getNextMutationBatchAfterBatchId=function(a,b){var c=this,d=b+1,e=IDBKeyRange.lowerBound([this.userId,d]),f=null;return dc(a).$t({index:ck.userMutationsIndex,range:e},function(a,b,e){var g;b.userId===c.userId&&(b.batchId>=d||r(),f=cX(c.R,b)),e.done()}).next(function(){return f})},a.prototype.getHighestUnacknowledgedBatchId=function(a){var b=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),c=-1;return dc(a).$t({index:ck.userMutationsIndex,range:b,reverse:!0},function(a,b,d){c=b.batchId,d.done()}).next(function(){return c})},a.prototype.getAllMutationBatches=function(a){var b=this,c=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return dc(a).Nt(ck.userMutationsIndex,c).next(function(a){return a.map(function(a){return cX(b.R,a)})})},a.prototype.getAllMutationBatchesAffectingDocumentKey=function(a,b){var c=this,d=cl.prefixForPath(this.userId,b.path),e=IDBKeyRange.lowerBound(d),f=[];return dd(a).$t({range:e},function(d,e,g){var h=d[0],i=d[1],j=d[2],k=cg(i);if(h===c.userId&&b.path.isEqual(k))return dc(a).get(j).next(function(a){var b;if(!a)throw r();a.userId===c.userId||r(),f.push(cX(c.R,a))});g.done()}).next(function(){return f})},a.prototype.getAllMutationBatchesAffectingDocumentKeys=function(a,b){var c=this,d=new bt(u),e=[];return b.forEach(function(b){var f=cl.prefixForPath(c.userId,b.path),g=IDBKeyRange.lowerBound(f),h=dd(a).$t({range:g},function(a,e,f){var g=a[0],h=a[1],i=a[2],j=cg(h);g===c.userId&&b.path.isEqual(j)?d=d.add(i):f.done()});e.push(h)}),cB.waitFor(e).next(function(){return c.Wt(a,d)})},a.prototype.getAllMutationBatchesAffectingQuery=function(a,b){var c=this,d=b.path,e=d.length+1,f=cl.prefixForPath(this.userId,d),g=IDBKeyRange.lowerBound(f),h=new bt(u);return dd(a).$t({range:g},function(a,b,f){var g=a[0],i=a[1],j=a[2],k=cg(i);g===c.userId&&d.isPrefixOf(k)?k.length===e&&(h=h.add(j)):f.done()}).next(function(){return c.Wt(a,h)})},a.prototype.Wt=function(a,b){var c=this,d=[],e=[];return b.forEach(function(b){e.push(dc(a).get(b).next(function(a){var b;if(null===a)throw r();a.userId===c.userId||r(),d.push(cX(c.R,a))}))}),cB.waitFor(e).next(function(){return d})},a.prototype.removeMutationBatch=function(a,b){var c=this;return c8(a.Mt,this.userId,b).next(function(d){return a.addOnCommittedListener(function(){c.Gt(b.batchId)}),cB.forEach(d,function(b){return c.referenceDelegate.markPotentiallyOrphaned(a,b)})})},a.prototype.Gt=function(a){delete this.Kt[a]},a.prototype.performConsistencyCheck=function(a){var b=this;return this.checkEmpty(a).next(function(c){if(!c)return cB.resolve();var d=IDBKeyRange.lowerBound(cl.prefixForUser(b.userId)),e=[];return dd(a).$t({range:d},function(a,c,d){if(a[0]===b.userId){var f=cg(a[1]);e.push(f)}else d.done()}).next(function(){var a;(a=0===e.length)||r()})})},a.prototype.containsKey=function(a,b){return db(a,this.userId,b)},a.prototype.zt=function(a){var b=this;return de(a).get(this.userId).next(function(a){return a||new cj(b.userId,-1,"")})},a}();function db(a,b,c){var d=cl.prefixForPath(b,c.path),e=d[1],f=IDBKeyRange.lowerBound(d),g=!1;return dd(a).$t({range:f,kt:!0},function(a,c,d){var f=a[0],h=a[1];a[2],f===b&&h===e&&(g=!0),d.done()}).next(function(){return g})}function dc(a){return cM(a,ck.store)}function dd(a){return cM(a,cl.store)}function de(a){return cM(a,cj.store)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** Offset to ensure non-overlapping target ids. */ /**
 * Generates monotonically increasing target IDs for sending targets to the
 * watch stream.
 *
 * The client constructs two generators, one for the target cache, and one for
 * for the sync engine (to generate limbo documents targets). These
 * generators produce non-overlapping IDs (by using even and odd IDs
 * respectively).
 *
 * By separating the target ID space, the query cache can generate target IDs
 * that persist across client restarts, while sync engine can independently
 * generate in-memory target IDs that are transient and can be reused after a
 * restart.
 */ var df=function(){function a(a){this.Ht=a}return a.prototype.next=function(){return this.Ht+=2,this.Ht},a.Jt=function(){return new a(0)},a.Yt=function(){return new a(-1)},a}(),dg=function(){function a(a,b){this.referenceDelegate=a,this.R=b}return a.prototype.allocateTargetId=function(a){var b=this;return this.Xt(a).next(function(c){var d=new df(c.highestTargetId);return c.highestTargetId=d.next(),b.Zt(a,c).next(function(){return c.highestTargetId})})},a.prototype.getLastRemoteSnapshotVersion=function(a){return this.Xt(a).next(function(a){return x.fromTimestamp(new w(a.lastRemoteSnapshotVersion.seconds,a.lastRemoteSnapshotVersion.nanoseconds))})},a.prototype.getHighestSequenceNumber=function(a){return this.Xt(a).next(function(a){return a.highestListenSequenceNumber})},a.prototype.setTargetsMetadata=function(a,b,c){var d=this;return this.Xt(a).next(function(e){return e.highestListenSequenceNumber=b,c&&(e.lastRemoteSnapshotVersion=c.toTimestamp()),b>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=b),d.Zt(a,e)})},a.prototype.addTargetData=function(a,b){var c=this;return this.te(a,b).next(function(){return c.Xt(a).next(function(d){return d.targetCount+=1,c.ee(b,d),c.Zt(a,d)})})},a.prototype.updateTargetData=function(a,b){return this.te(a,b)},a.prototype.removeTargetData=function(a,b){var c=this;return this.removeMatchingKeysForTargetId(a,b.targetId).next(function(){return dh(a).delete(b.targetId)}).next(function(){return c.Xt(a)}).next(function(b){var d;return b.targetCount>0||r(),b.targetCount-=1,c.Zt(a,b)})},a.prototype.removeTargets=function(a,b,c){var d=this,e=0,f=[];return dh(a).$t(function(g,h){var i=cY(h);i.sequenceNumber<=b&&null===c.get(i.targetId)&&(e++,f.push(d.removeTargetData(a,i)))}).next(function(){return cB.waitFor(f)}).next(function(){return e})},a.prototype.forEachTarget=function(a,b){return dh(a).$t(function(a,c){var d=cY(c);b(d)})},a.prototype.Xt=function(a){return di(a).get(cs.key).next(function(a){var b;return null!==a||r(),a})},a.prototype.Zt=function(a,b){return di(a).put(cs.key,b)},a.prototype.te=function(a,b){return dh(a).put(cZ(this.R,b))},a.prototype.ee=function(a,b){var c=!1;return a.targetId>b.highestTargetId&&(b.highestTargetId=a.targetId,c=!0),a.sequenceNumber>b.highestListenSequenceNumber&&(b.highestListenSequenceNumber=a.sequenceNumber,c=!0),c},a.prototype.getTargetCount=function(a){return this.Xt(a).next(function(a){return a.targetCount})},a.prototype.getTargetData=function(a,b){var c=ai(b),d=IDBKeyRange.bound([c,Number.NEGATIVE_INFINITY],[c,Number.POSITIVE_INFINITY]),e=null;return dh(a).$t({range:d,index:cq.queryTargetsIndexName},function(a,c,d){var f=cY(c);aj(b,f.target)&&(e=f,d.done())}).next(function(){return e})},a.prototype.addMatchingKeys=function(a,b,c){var d=this,e=[],f=dj(a);return b.forEach(function(b){var g=ce(b.path);e.push(f.put(new cr(c,g))),e.push(d.referenceDelegate.addReference(a,c,b))}),cB.waitFor(e)},a.prototype.removeMatchingKeys=function(a,b,c){var d=this,e=dj(a);return cB.forEach(b,function(b){var f=ce(b.path);return cB.waitFor([e.delete([c,f]),d.referenceDelegate.removeReference(a,c,b)])})},a.prototype.removeMatchingKeysForTargetId=function(a,b){var c=dj(a),d=IDBKeyRange.bound([b],[b+1],!1,!0);return c.delete(d)},a.prototype.getMatchingKeysForTargetId=function(a,b){var c=IDBKeyRange.bound([b],[b+1],!1,!0),d=dj(a),e=bz();return d.$t({range:c,kt:!0},function(a,b,c){var d=cg(a[1]),f=new Q(d);e=e.add(f)}).next(function(){return e})},a.prototype.containsKey=function(a,b){var c,d=ce(b.path),e=IDBKeyRange.bound([d],[(c=d)+"\0"],!1,!0),f=0;return dj(a).$t({index:cr.documentTargetsIndex,kt:!0,range:e},function(a,b,c){var d=a[0];a[1],0!==d&&(f++,c.done())}).next(function(){return f>0})},a.prototype.lt=function(a,b){return dh(a).get(b).next(function(a){return a?cY(a):null})},a}();/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Helper to get a typed SimpleDbStore for the queries object store.
 */ function dh(a){return cM(a,cq.store)}function di(a){return cM(a,cs.store)}function dj(a){return cM(a,cr.store)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Verifies the error thrown by a LocalStore operation. If a LocalStore
 * operation fails because the primary lease has been taken by another client,
 * we ignore the error (the persistence layer will immediately call
 * `applyPrimaryLease` to propagate the primary state change). All other errors
 * are re-thrown.
 *
 * @param err - An error returned by a LocalStore operation.
 * @returns A Promise that resolves after we recovered, or the original error.
 */ function dk(a){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(b){if(a.code!==j.FAILED_PRECONDITION||a.message!==cy)throw a;return n("LocalStore","Unexpectedly lost primary lease"),[2]})})}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ function dl(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=u(c,e);return 0===g?u(d,f):g}var dm=function(){function a(a){this.ne=a,this.buffer=new bt(dl),this.se=0}return a.prototype.ie=function(){return++this.se},a.prototype.re=function(a){var b=[a,this.ie()];if(this.buffer.size<this.ne)this.buffer=this.buffer.add(b);else{var c=this.buffer.last();0>dl(b,c)&&(this.buffer=this.buffer.delete(c).add(b))}},Object.defineProperty(a.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!1,configurable:!0}),a}(),dn=function(){function a(a,b){this.garbageCollector=a,this.asyncQueue=b,this.oe=!1,this.ce=null}return a.prototype.start=function(a){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.ue(a)},a.prototype.stop=function(){this.ce&&(this.ce.cancel(),this.ce=null)},Object.defineProperty(a.prototype,"started",{get:function(){return null!==this.ce},enumerable:!1,configurable:!0}),a.prototype.ue=function(a){var b=this,c=this.oe?3e5:6e4;n("LruGarbageCollector","Garbage collection scheduled in "+c+"ms"),this.ce=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",c,function(){return(0,d.__awaiter)(b,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:this.ce=null,this.oe=!0,c.label=1;case 1:return c.trys.push([1,3,,7]),[4,a.collectGarbage(this.garbageCollector)];case 2:return c.sent(),[3,7];case 3:return cG(b=c.sent())?(n("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",b),[3,6]):[3,4];case 4:return[4,dk(b)];case 5:c.sent(),c.label=6;case 6:return[3,7];case 7:return[4,this.ue(a)];case 8:return c.sent(),[2]}})})})},a}(),dp=function(){function a(a,b){this.ae=a,this.params=b}return a.prototype.calculateTargetCount=function(a,b){return this.ae.he(a).next(function(a){return Math.floor(b/100*a)})},a.prototype.nthSequenceNumber=function(a,b){var c=this;if(0===b)return cB.resolve(i.o);var d=new dm(b);return this.ae.forEachTarget(a,function(a){return d.re(a.sequenceNumber)}).next(function(){return c.ae.le(a,function(a){return d.re(a)})}).next(function(){return d.maxValue})},a.prototype.removeTargets=function(a,b,c){return this.ae.removeTargets(a,b,c)},a.prototype.removeOrphanedDocuments=function(a,b){return this.ae.removeOrphanedDocuments(a,b)},a.prototype.collect=function(a,b){var c=this;return -1===this.params.cacheSizeCollectionThreshold?(n("LruGarbageCollector","Garbage collection skipped; disabled"),cB.resolve(c6)):this.getCacheSize(a).next(function(d){return d<c.params.cacheSizeCollectionThreshold?(n("LruGarbageCollector","Garbage collection skipped; Cache size "+d+" is lower than threshold "+c.params.cacheSizeCollectionThreshold),c6):c.fe(a,b)})},a.prototype.getCacheSize=function(a){return this.ae.getCacheSize(a)},a.prototype.fe=function(a,b){var c,d,e,g,h,i,j,k=this,l=Date.now();return this.calculateTargetCount(a,this.params.percentileToCollect).next(function(b){return b>k.params.maximumSequenceNumbersToCollect?(n("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+k.params.maximumSequenceNumbersToCollect+" from "+b),d=k.params.maximumSequenceNumbersToCollect):d=b,g=Date.now(),k.nthSequenceNumber(a,d)}).next(function(d){return c=d,h=Date.now(),k.removeTargets(a,c,b)}).next(function(b){return e=b,i=Date.now(),k.removeOrphanedDocuments(a,c)}).next(function(a){return j=Date.now(),m()<=f.LogLevel.DEBUG&&n("LruGarbageCollector","LRU Garbage Collection\n	Counted targets in "+(g-l)+"ms\n	Determined least recently used "+d+" in "+(h-g)+"ms\n	Removed "+e+" targets in "+(i-h)+"ms\n	Removed "+a+" documents in "+(j-i)+"ms\nTotal Duration: "+(j-l)+"ms"),cB.resolve({didRun:!0,sequenceNumbersCollected:d,targetsRemoved:e,documentsRemoved:a})})},a}(),dq=function(){function a(a,b){var c,d;this.db=a,this.garbageCollector=(c=this,d=b,new dp(c,d))}return a.prototype.he=function(a){var b=this.de(a);return this.db.getTargetCache().getTargetCount(a).next(function(a){return b.next(function(b){return a+b})})},a.prototype.de=function(a){var b=0;return this.le(a,function(a){b++}).next(function(){return b})},a.prototype.forEachTarget=function(a,b){return this.db.getTargetCache().forEachTarget(a,b)},a.prototype.le=function(a,b){return this.we(a,function(a,c){return b(c)})},a.prototype.addReference=function(a,b,c){return dr(a,c)},a.prototype.removeReference=function(a,b,c){return dr(a,c)},a.prototype.removeTargets=function(a,b,c){return this.db.getTargetCache().removeTargets(a,b,c)},a.prototype.markPotentiallyOrphaned=function(a,b){return dr(a,b)},a.prototype._e=function(a,b){var c,d,e;return c=a,d=b,e=!1,de(c).Ot(function(a){return db(c,a,d).next(function(a){return a&&(e=!0),cB.resolve(!a)})}).next(function(){return e})},a.prototype.removeOrphanedDocuments=function(a,b){var c=this,d=this.db.getRemoteDocumentCache().newChangeBuffer(),e=[],f=0;return this.we(a,function(g,h){if(h<=b){var i=c._e(a,g).next(function(b){if(!b)return f++,d.getEntry(a,g).next(function(){return d.removeEntry(g),dj(a).delete([0,ce(g.path)])})});e.push(i)}}).next(function(){return cB.waitFor(e)}).next(function(){return d.apply(a)}).next(function(){return f})},a.prototype.removeTarget=function(a,b){var c=b.withSequenceNumber(a.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(a,c)},a.prototype.updateLimboDocument=function(a,b){return dr(a,b)},a.prototype.we=function(a,b){var c,d=dj(a),e=i.o;return d.$t({index:cr.documentTargetsIndex},function(a,d){var f=a[0];a[1];var g=d.path,h=d.sequenceNumber;0===f?(e!==i.o&&b(new Q(cg(c)),e),e=h,c=g):e=i.o}).next(function(){e!==i.o&&b(new Q(cg(c)),e)})},a.prototype.getCacheSize=function(a){return this.db.getRemoteDocumentCache().getSize(a)},a}();function dr(a,b){var c,d;return dj(a).put((c=b,d=a.currentSequenceNumber,new cr(0,ce(c.path),d)))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A map implementation that uses objects as keys. Objects must have an
 * associated equals function and must be immutable. Entries in the map are
 * stored together with the key being produced from the mapKeyFn. This map
 * automatically handles collisions of keys.
 */ var ds=function(){function a(a,b){this.mapKeyFn=a,this.equalsFn=b,this.inner={}}return a.prototype.get=function(a){var b=this.mapKeyFn(a),c=this.inner[b];if(void 0!==c)for(var d=0,e=c;d<e.length;d++){var f=e[d],g=f[0],h=f[1];if(this.equalsFn(g,a))return h}},a.prototype.has=function(a){return void 0!==this.get(a)},a.prototype.set=function(a,b){var c=this.mapKeyFn(a),d=this.inner[c];if(void 0!==d){for(var e=0;e<d.length;e++)if(this.equalsFn(d[e][0],a))return void(d[e]=[a,b]);d.push([a,b])}else this.inner[c]=[[a,b]]},a.prototype.delete=function(a){var b=this.mapKeyFn(a),c=this.inner[b];if(void 0===c)return!1;for(var d=0;d<c.length;d++)if(this.equalsFn(c[d][0],a))return 1===c.length?delete this.inner[b]:c.splice(d,1),!0;return!1},a.prototype.forEach=function(a){z(this.inner,function(b,c){for(var d=0,e=c;d<e.length;d++){var f=e[d],g=f[0],h=f[1];a(g,h)}})},a.prototype.isEmpty=function(){return A(this.inner)},a}(),dt=function(){function a(){this.changes=new ds(function(a){return a.toString()},function(a,b){return a.isEqual(b)}),this.changesApplied=!1}return a.prototype.getReadTime=function(a){var b=this.changes.get(a);return b?b.readTime:x.min()},a.prototype.addEntry=function(a,b){this.assertNotApplied(),this.changes.set(a.key,{document:a,readTime:b})},a.prototype.removeEntry=function(a,b){void 0===b&&(b=null),this.assertNotApplied(),this.changes.set(a,{document:af.newInvalidDocument(a),readTime:b})},a.prototype.getEntry=function(a,b){this.assertNotApplied();var c=this.changes.get(b);return void 0!==c?cB.resolve(c.document):this.getFromCache(a,b)},a.prototype.getEntries=function(a,b){return this.getAllFromCache(a,b)},a.prototype.apply=function(a){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(a)},a.prototype.assertNotApplied=function(){},a}(),du=function(){function a(a,b){this.R=a,this.Ut=b}return a.prototype.addEntry=function(a,b,c){return dx(a).put(dy(b),c)},a.prototype.removeEntry=function(a,b){var c=dx(a),d=dy(b);return c.delete(d)},a.prototype.updateMetadata=function(a,b){var c=this;return this.getMetadata(a).next(function(d){return d.byteSize+=b,c.me(a,d)})},a.prototype.getEntry=function(a,b){var c=this;return dx(a).get(dy(b)).next(function(a){return c.ye(b,a)})},a.prototype.ge=function(a,b){var c=this;return dx(a).get(dy(b)).next(function(a){return{document:c.ye(b,a),size:c9(a)}})},a.prototype.getEntries=function(a,b){var c=this,d=bv;return this.pe(a,b,function(a,b){var e=c.ye(a,b);d=d.insert(a,e)}).next(function(){return d})},a.prototype.Ee=function(a,b){var c=this,d=bv,e=new bq(Q.comparator);return this.pe(a,b,function(a,b){var f=c.ye(a,b);d=d.insert(a,f),e=e.insert(a,c9(b))}).next(function(){return{documents:d,Te:e}})},a.prototype.pe=function(a,b,c){if(b.isEmpty())return cB.resolve();var d=IDBKeyRange.bound(b.first().path.toArray(),b.last().path.toArray()),e=b.getIterator(),f=e.getNext();return dx(a).$t({range:d},function(a,b,d){for(var g=Q.fromSegments(a);f&&0>Q.comparator(f,g);)c(f,null),f=e.getNext();f&&f.isEqual(g)&&(c(f,b),f=e.hasNext()?e.getNext():null),f?d.Ct(f.path.toArray()):d.done()}).next(function(){for(;f;)c(f,null),f=e.hasNext()?e.getNext():null})},a.prototype.getDocumentsMatchingQuery=function(a,b,c){var d=this,e=bv,f=b.path.length+1,g={};if(c.isEqual(x.min())){var h=b.path.toArray();g.range=IDBKeyRange.lowerBound(h)}else{var i=b.path.toArray(),j=cT(c);g.range=IDBKeyRange.lowerBound([i,j],!0),g.index=co.collectionReadTimeIndex}return dx(a).$t(g,function(a,c,g){if(a.length===f){var h=cR(d.R,c);b.path.isPrefixOf(h.key.path)?aO(b,h)&&(e=e.insert(h.key,h)):g.done()}}).next(function(){return e})},a.prototype.newChangeBuffer=function(a){return new dv(this,!!a&&a.trackRemovals)},a.prototype.getSize=function(a){return this.getMetadata(a).next(function(a){return a.byteSize})},a.prototype.getMetadata=function(a){return dw(a).get(cp.key).next(function(a){var b;return!a&&r(),a})},a.prototype.me=function(a,b){return dw(a).put(cp.key,b)},a.prototype.ye=function(a,b){if(b){var c=cR(this.R,b);if(!c.isNoDocument()||!c.version.isEqual(x.min()))return c}return af.newInvalidDocument(a)},a}(),dv=function(a){function b(b,c){var d=this;return(d=a.call(this)||this).Ie=b,d.trackRemovals=c,d.Ae=new ds(function(a){return a.toString()},function(a,b){return a.isEqual(b)}),d}return(0,d.__extends)(b,a),b.prototype.applyChanges=function(a){var b=this,c=[],d=0,e=new bt(function(a,b){return u(a.canonicalString(),b.canonicalString())});return this.changes.forEach(function(f,g){var h=b.Ae.get(f);if(g.document.isValidDocument()){var i=cS(b.Ie.R,g.document,b.getReadTime(f));e=e.add(f.path.popLast());var j=c9(i);d+=j-h,c.push(b.Ie.addEntry(a,f,i))}else if(d-=h,b.trackRemovals){var k=cS(b.Ie.R,af.newNoDocument(f,x.min()),b.getReadTime(f));c.push(b.Ie.addEntry(a,f,k))}else c.push(b.Ie.removeEntry(a,f))}),e.forEach(function(d){c.push(b.Ie.Ut.addToCollectionParentIndex(a,d))}),c.push(this.Ie.updateMetadata(a,d)),cB.waitFor(c)},b.prototype.getFromCache=function(a,b){var c=this;return this.Ie.ge(a,b).next(function(a){return c.Ae.set(b,a.size),a.document})},b.prototype.getAllFromCache=function(a,b){var c=this;return this.Ie.Ee(a,b).next(function(a){var b=a.documents;return a.Te.forEach(function(a,b){c.Ae.set(a,b)}),b})},b}(dt);/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * An in-memory buffer of entries to be written to a RemoteDocumentCache.
 * It can be used to batch up a set of changes to be written to the cache, but
 * additionally supports reading entries back with the `getEntry()` method,
 * falling back to the underlying RemoteDocumentCache if no entry is
 * buffered.
 *
 * Entries added to the cache *must* be read first. This is to facilitate
 * calculating the size delta of the pending changes.
 *
 * PORTING NOTE: This class was implemented then removed from other platforms.
 * If byte-counting ends up being needed on the other platforms, consider
 * porting this class as part of that implementation work.
 */ function dw(a){return cM(a,cp.store)}function dx(a){return cM(a,co.store)}function dy(a){return a.path.toArray()}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** Performs database creation and schema upgrades. */ var dz=function(){function a(a){this.R=a}return a.prototype.Rt=function(a,b,c,d){var e,f=this;(e=c<d&&c>=0&&d<=11)||r();var g,h=new cC("createOrUpgrade",b);c<1&&d>=1&&(function(a){a.createObjectStore(ci.store)}(a),(g=a).createObjectStore(cj.store,{keyPath:cj.keyPath}),g.createObjectStore(ck.store,{keyPath:ck.keyPath,autoIncrement:!0}).createIndex(ck.userMutationsIndex,ck.userMutationsKeyPath,{unique:!0}),g.createObjectStore(cl.store),dA(a),function(a){a.createObjectStore(co.store)}(a));var i,j=cB.resolve();return c<3&&d>=3&&(0!==c&&((i=a).deleteObjectStore(cr.store),i.deleteObjectStore(cq.store),i.deleteObjectStore(cs.store),dA(a)),j=j.next(function(){var a,b,c;return b=(a=h).store(cs.store),c=new cs(0,0,x.min().toTimestamp(),0),b.put(cs.key,c)})),c<4&&d>=4&&(0!==c&&(j=j.next(function(){var b,c;return b=a,(c=h).store(ck.store).Nt().next(function(a){b.deleteObjectStore(ck.store),b.createObjectStore(ck.store,{keyPath:ck.keyPath,autoIncrement:!0}).createIndex(ck.userMutationsIndex,ck.userMutationsKeyPath,{unique:!0});var d=c.store(ck.store),e=a.map(function(a){return d.put(a)});return cB.waitFor(e)})})),j=j.next(function(){!function(a){a.createObjectStore(cu.store,{keyPath:cu.keyPath})}(a)})),c<5&&d>=5&&(j=j.next(function(){return f.Re(h)})),c<6&&d>=6&&(j=j.next(function(){return function(a){a.createObjectStore(cp.store)}(a),f.be(h)})),c<7&&d>=7&&(j=j.next(function(){return f.ve(h)})),c<8&&d>=8&&(j=j.next(function(){return f.Pe(a,h)})),c<9&&d>=9&&(j=j.next(function(){var c,d,e;(c=a).objectStoreNames.contains("remoteDocumentChanges")&&c.deleteObjectStore("remoteDocumentChanges"),(e=b.objectStore(co.store)).createIndex(co.readTimeIndex,co.readTimeIndexPath,{unique:!1}),e.createIndex(co.collectionReadTimeIndex,co.collectionReadTimeIndexPath,{unique:!1})})),c<10&&d>=10&&(j=j.next(function(){return f.Ve(h)})),c<11&&d>=11&&(j=j.next(function(){(function(a){a.createObjectStore(cv.store,{keyPath:cv.keyPath})})(a),function(a){a.createObjectStore(cw.store,{keyPath:cw.keyPath})}(a)})),j},a.prototype.be=function(a){var b=0;return a.store(co.store).$t(function(a,c){b+=c9(c)}).next(function(){var c=new cp(b);return a.store(cp.store).put(cp.key,c)})},a.prototype.Re=function(a){var b=this,c=a.store(cj.store),d=a.store(ck.store);return c.Nt().next(function(c){return cB.forEach(c,function(c){var e=IDBKeyRange.bound([c.userId,-1],[c.userId,c.lastAcknowledgedBatchId]);return d.Nt(ck.userMutationsIndex,e).next(function(d){return cB.forEach(d,function(d){(e=d.userId===c.userId)||r();var e,f=cX(b.R,d);return c8(a,c.userId,f).next(function(){})})})})})},a.prototype.ve=function(a){var b=a.store(cr.store),c=a.store(co.store);return a.store(cs.store).get(cs.key).next(function(a){var d=[];return c.$t(function(c,e){var f,g=new C(c),h=[0,ce(f=g)];d.push(b.get(h).next(function(c){var d;return c?cB.resolve():(d=g,b.put(new cr(0,ce(d),a.highestListenSequenceNumber)))}))}).next(function(){return cB.waitFor(d)})})},a.prototype.Pe=function(a,b){a.createObjectStore(ct.store,{keyPath:ct.keyPath});var c=b.store(ct.store),d=new c3,e=function(a){if(d.add(a)){var b=a.lastSegment(),e=a.popLast();return c.put({collectionId:b,parent:ce(e)})}};return b.store(co.store).$t({kt:!0},function(a,b){var c=new C(a);return e(c.popLast())}).next(function(){return b.store(cl.store).$t({kt:!0},function(a,b){a[0];var c=a[1];a[2];var d=cg(c);return e(d.popLast())})})},a.prototype.Ve=function(a){var b=this,c=a.store(cq.store);return c.$t(function(a,d){var e=cY(d),f=cZ(b.R,e);return c.put(f)})},a}();function dA(a){a.createObjectStore(cr.store,{keyPath:cr.keyPath}).createIndex(cr.documentTargetsIndex,cr.documentTargetsKeyPath,{unique:!0}),a.createObjectStore(cq.store,{keyPath:cq.keyPath}).createIndex(cq.queryTargetsIndexName,cq.queryTargetsKeyPath,{unique:!0}),a.createObjectStore(cs.store)}var dB="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",dC=function(){function a(b,c,d,e,f,g,h,i,l,m){var n,p;if(this.allowTabSynchronization=b,this.persistenceKey=c,this.clientId=d,this.Se=f,this.window=g,this.document=h,this.De=l,this.Ce=m,this.Ne=null,this.xe=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Fe=null,this.inForeground=!1,this.ke=null,this.$e=null,this.Oe=Number.NEGATIVE_INFINITY,this.Me=function(a){return Promise.resolve()},!a.yt())throw new k(j.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new dq(this,e),this.Le=c+"main",this.R=new cQ(i),this.Be=new cD(this.Le,11,new dz(this.R)),this.qe=new dg(this.referenceDelegate,this.R),this.Ut=new c4,this.Ue=(n=this.R,p=this.Ut,new du(n,p)),this.Ke=new c_,this.window&&this.window.localStorage?this.Qe=this.window.localStorage:(this.Qe=null,!1===m&&o("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}return a.prototype.start=function(){var a=this;return this.je().then(function(){if(!a.isPrimary&&!a.allowTabSynchronization)throw new k(j.FAILED_PRECONDITION,dB);return a.We(),a.Ge(),a.ze(),a.runTransaction("getHighestListenSequenceNumber","readonly",function(b){return a.qe.getHighestSequenceNumber(b)})}).then(function(b){a.Ne=new i(b,a.De)}).then(function(){a.xe=!0}).catch(function(b){return a.Be&&a.Be.close(),Promise.reject(b)})},a.prototype.He=function(a){var b=this;return this.Me=function(c){return(0,d.__awaiter)(b,void 0,void 0,function(){return(0,d.__generator)(this,function(b){return this.started?[2,a(c)]:[2]})})},a(this.isPrimary)},a.prototype.setDatabaseDeletedListener=function(a){var b=this;this.Be.vt(function(c){return(0,d.__awaiter)(b,void 0,void 0,function(){return(0,d.__generator)(this,function(b){switch(b.label){case 0:return null===c.newVersion?[4,a()]:[3,2];case 1:b.sent(),b.label=2;case 2:return[2]}})})})},a.prototype.setNetworkEnabled=function(a){var b=this;this.networkEnabled!==a&&(this.networkEnabled=a,this.Se.enqueueAndForget(function(){return(0,d.__awaiter)(b,void 0,void 0,function(){return(0,d.__generator)(this,function(a){switch(a.label){case 0:return this.started?[4,this.je()]:[3,2];case 1:a.sent(),a.label=2;case 2:return[2]}})})}))},a.prototype.je=function(){var a=this;return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",function(b){return dE(b).put(new cu(a.clientId,Date.now(),a.networkEnabled,a.inForeground)).next(function(){if(a.isPrimary)return a.Je(b).next(function(b){b||(a.isPrimary=!1,a.Se.enqueueRetryable(function(){return a.Me(!1)}))})}).next(function(){return a.Ye(b)}).next(function(c){return a.isPrimary&&!c?a.Xe(b).next(function(){return!1}):!!c&&a.Ze(b).next(function(){return!0})})}).catch(function(b){if(cG(b))return n("IndexedDbPersistence","Failed to extend owner lease: ",b),a.isPrimary;if(!a.allowTabSynchronization)throw b;return n("IndexedDbPersistence","Releasing owner lease after error during lease refresh",b),!1}).then(function(b){a.isPrimary!==b&&a.Se.enqueueRetryable(function(){return a.Me(b)}),a.isPrimary=b})},a.prototype.Je=function(a){var b=this;return dD(a).get(ci.key).next(function(a){return cB.resolve(b.tn(a))})},a.prototype.en=function(a){return dE(a).delete(this.clientId)},a.prototype.nn=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a,b,c,e,f=this;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return!this.isPrimary||this.sn(this.Oe,18e5)?[3,2]:(this.Oe=Date.now(),[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(a){var b=cM(a,cu.store);return b.Nt().next(function(a){var c=f.rn(a,18e5),d=a.filter(function(a){return -1===c.indexOf(a)});return cB.forEach(d,function(a){return b.delete(a.clientId)}).next(function(){return d})})}).catch(function(){return[]})]);case 1:if(a=d.sent(),this.Qe)for(b=0,c=a;b<c.length;b++)e=c[b],this.Qe.removeItem(this.on(e.clientId));d.label=2;case 2:return[2]}})})},a.prototype.ze=function(){var a=this;this.$e=this.Se.enqueueAfterDelay("client_metadata_refresh",4e3,function(){return a.je().then(function(){return a.nn()}).then(function(){return a.ze()})})},a.prototype.tn=function(a){return!!a&&a.ownerId===this.clientId},a.prototype.Ye=function(a){var b=this;return this.Ce?cB.resolve(!0):dD(a).get(ci.key).next(function(c){if(null!==c&&b.sn(c.leaseTimestampMs,5e3)&&!b.cn(c.ownerId)){if(b.tn(c)&&b.networkEnabled)return!0;if(!b.tn(c)){if(!c.allowTabSynchronization)throw new k(j.FAILED_PRECONDITION,dB);return!1}}return!(!b.networkEnabled||!b.inForeground)||dE(a).Nt().next(function(a){return void 0===b.rn(a,5e3).find(function(a){if(b.clientId!==a.clientId){var c=!b.networkEnabled&&a.networkEnabled,d=!b.inForeground&&a.inForeground,e=b.networkEnabled===a.networkEnabled;if(c||d&&e)return!0}return!1})})}).next(function(a){return b.isPrimary!==a&&n("IndexedDbPersistence","Client "+(a?"is":"is not")+" eligible for a primary lease."),a})},a.prototype.shutdown=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a=this;return(0,d.__generator)(this,function(b){switch(b.label){case 0:return this.xe=!1,this.un(),this.$e&&(this.$e.cancel(),this.$e=null),this.an(),this.hn(),[4,this.Be.runTransaction("shutdown","readwrite",[ci.store,cu.store],function(b){var c=new cL(b,i.o);return a.Xe(c).next(function(){return a.en(c)})})];case 1:return b.sent(),this.Be.close(),this.ln(),[2]}})})},a.prototype.rn=function(a,b){var c=this;return a.filter(function(a){return c.sn(a.updateTimeMs,b)&&!c.cn(a.clientId)})},a.prototype.fn=function(){var a=this;return this.runTransaction("getActiveClients","readonly",function(b){return dE(b).Nt().next(function(b){return a.rn(b,18e5).map(function(a){return a.clientId})})})},Object.defineProperty(a.prototype,"started",{get:function(){return this.xe},enumerable:!1,configurable:!0}),a.prototype.getMutationQueue=function(a){return da.Qt(a,this.R,this.Ut,this.referenceDelegate)},a.prototype.getTargetCache=function(){return this.qe},a.prototype.getRemoteDocumentCache=function(){return this.Ue},a.prototype.getIndexManager=function(){return this.Ut},a.prototype.getBundleCache=function(){return this.Ke},a.prototype.runTransaction=function(a,b,c){var d,e=this;return n("IndexedDbPersistence","Starting transaction:",a),this.Be.runTransaction(a,"readonly"===b?"readonly":"readwrite",cx,function(f){return d=new cL(f,e.Ne?e.Ne.next():i.o),"readwrite-primary"===b?e.Je(d).next(function(a){return!!a||e.Ye(d)}).next(function(b){if(!b)throw o("Failed to obtain primary lease for action '"+a+"'."),e.isPrimary=!1,e.Se.enqueueRetryable(function(){return e.Me(!1)}),new k(j.FAILED_PRECONDITION,cy);return c(d)}).next(function(a){return e.Ze(d).next(function(){return a})}):e.dn(d).next(function(){return c(d)})}).then(function(a){return d.raiseOnCommittedEvent(),a})},a.prototype.dn=function(a){var b=this;return dD(a).get(ci.key).next(function(a){if(null!==a&&b.sn(a.leaseTimestampMs,5e3)&&!b.cn(a.ownerId)&&!b.tn(a)&&!(b.Ce||b.allowTabSynchronization&&a.allowTabSynchronization))throw new k(j.FAILED_PRECONDITION,dB)})},a.prototype.Ze=function(a){var b=new ci(this.clientId,this.allowTabSynchronization,Date.now());return dD(a).put(ci.key,b)},a.yt=function(){return cD.yt()},a.prototype.Xe=function(a){var b=this,c=dD(a);return c.get(ci.key).next(function(a){return b.tn(a)?(n("IndexedDbPersistence","Releasing primary lease."),c.delete(ci.key)):cB.resolve()})},a.prototype.sn=function(a,b){var c=Date.now();return!(a<c-b||a>c&&(o("Detected an update time that is in the future: "+a+" > "+c),1))},a.prototype.We=function(){var a=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ke=function(){a.Se.enqueueAndForget(function(){return a.inForeground="visible"===a.document.visibilityState,a.je()})},this.document.addEventListener("visibilitychange",this.ke),this.inForeground="visible"===this.document.visibilityState)},a.prototype.an=function(){this.ke&&(this.document.removeEventListener("visibilitychange",this.ke),this.ke=null)},a.prototype.Ge=function(){var a,b=this;"function"==typeof(null===(a=this.window)|| void 0===a?void 0:a.addEventListener)&&(this.Fe=function(){b.un(),(0,e.isSafari)()&&navigator.appVersion.match("Version/14")&&b.Se.enterRestrictedMode(!0),b.Se.enqueueAndForget(function(){return b.shutdown()})},this.window.addEventListener("pagehide",this.Fe))},a.prototype.hn=function(){this.Fe&&(this.window.removeEventListener("pagehide",this.Fe),this.Fe=null)},a.prototype.cn=function(a){var b;try{var c=null!==(null===(b=this.Qe)|| void 0===b?void 0:b.getItem(this.on(a)));return n("IndexedDbPersistence","Client '"+a+"' "+(c?"is":"is not")+" zombied in LocalStorage"),c}catch(d){return o("IndexedDbPersistence","Failed to get zombied client id.",d),!1}},a.prototype.un=function(){if(this.Qe)try{this.Qe.setItem(this.on(this.clientId),String(Date.now()))}catch(a){o("Failed to set zombie client id.",a)}},a.prototype.ln=function(){if(this.Qe)try{this.Qe.removeItem(this.on(this.clientId))}catch(a){}},a.prototype.on=function(a){return"firestore_zombie_"+this.persistenceKey+"_"+a},a}();function dD(a){return cM(a,ci.store)}function dE(a){return cM(a,cu.store)}function dF(a,b){var c=a.projectId;return a.isDefaultDatabase||(c+="."+a.database),"firestore/"+b+"/"+c+"/" /**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ }var dG=function(a,b){this.progress=a,this.wn=b},dH=function(){function a(a,b,c){this.Ue=a,this._n=b,this.Ut=c}return a.prototype.mn=function(a,b){var c=this;return this._n.getAllMutationBatchesAffectingDocumentKey(a,b).next(function(d){return c.yn(a,b,d)})},a.prototype.yn=function(a,b,c){return this.Ue.getEntry(a,b).next(function(a){for(var b=0,d=c;b<d.length;b++)d[b].applyToLocalView(a);return a})},a.prototype.gn=function(a,b){a.forEach(function(a,c){for(var d=0,e=b;d<e.length;d++)e[d].applyToLocalView(c)})},a.prototype.pn=function(a,b){var c=this;return this.Ue.getEntries(a,b).next(function(b){return c.En(a,b).next(function(){return b})})},a.prototype.En=function(a,b){var c=this;return this._n.getAllMutationBatchesAffectingDocumentKeys(a,b).next(function(a){return c.gn(b,a)})},a.prototype.getDocumentsMatchingQuery=function(a,b,c){var d;return(d=b,Q.isDocumentKey(d.path)&&null===d.collectionGroup&&0===d.filters.length)?this.Tn(a,b.path):aH(b)?this.In(a,b,c):this.An(a,b,c)},a.prototype.Tn=function(a,b){return this.mn(a,new Q(b)).next(function(a){var b=bw;return a.isFoundDocument()&&(b=b.insert(a.key,a)),b})},a.prototype.In=function(a,b,c){var d=this,e=b.collectionGroup,f=bw;return this.Ut.getCollectionParents(a,e).next(function(g){return cB.forEach(g,function(g){var h,i,j=(h=b,i=g.child(e),new aA(i,null,h.explicitOrderBy.slice(),h.filters.slice(),h.limit,h.limitType,h.startAt,h.endAt));return d.An(a,j,c).next(function(a){a.forEach(function(a,b){f=f.insert(a,b)})})}).next(function(){return f})})},a.prototype.An=function(a,b,c){var d,e,f=this;return this.Ue.getDocumentsMatchingQuery(a,b,c).next(function(c){return d=c,f._n.getAllMutationBatchesAffectingQuery(a,b)}).next(function(b){return e=b,f.Rn(a,e,d).next(function(a){d=a;for(var b=0,c=e;b<c.length;b++)for(var f=c[b],g=0,h=f.mutations;g<h.length;g++){var i=h[g],j=i.key,k=d.get(j);null==k&&(k=af.newInvalidDocument(j),d=d.insert(j,k)),ba(i,k,f.localWriteTime),k.isFoundDocument()||(d=d.remove(j))}})}).next(function(){return d.forEach(function(a,c){aO(b,c)||(d=d.remove(a))}),d})},a.prototype.Rn=function(a,b,c){for(var d=bz(),e=0,f=b;e<f.length;e++)for(var g=0,h=f[e].mutations;g<h.length;g++){var i=h[g];i instanceof bf&&null===c.get(i.key)&&(d=d.add(i.key))}var j=c;return this.Ue.getEntries(a,d).next(function(a){return a.forEach(function(a,b){b.isFoundDocument()&&(j=j.insert(a,b))}),j})},a}(),dI=function(){function a(a,b,c,d){this.targetId=a,this.fromCache=b,this.bn=c,this.vn=d}return a.Pn=function(b,c){for(var d=bz(),e=bz(),f=0,g=c.docChanges;f<g.length;f++){var h=g[f];switch(h.type){case 0:d=d.add(h.doc.key);break;case 1:e=e.add(h.doc.key)}}return new a(b,c.fromCache,d,e)},a}(),dJ=function(){function a(){}return a.prototype.Vn=function(a){this.Sn=a},a.prototype.getDocumentsMatchingQuery=function(a,b,c,d){var e,g=this;return 0===(e=b).filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())||c.isEqual(x.min())?this.Dn(a,b):this.Sn.pn(a,d).next(function(e){var h=g.Cn(b,e);return(aD(b)||aE(b))&&g.Nn(b.limitType,h,d,c)?g.Dn(a,b):(m()<=f.LogLevel.DEBUG&&n("QueryEngine","Re-using previous result from %s to execute query: %s",c.toString(),aN(b)),g.Sn.getDocumentsMatchingQuery(a,b,c).next(function(a){return h.forEach(function(b){a=a.insert(b.key,b)}),a}))})},a.prototype.Cn=function(a,b){var c=new bt(aP(a));return b.forEach(function(b,d){aO(a,d)&&(c=c.add(d))}),c},a.prototype.Nn=function(a,b,c,d){if(c.size!==b.size)return!0;var e="F"===a?b.last():b.first();return!!e&&(e.hasPendingWrites||e.version.compareTo(d)>0)},a.prototype.Dn=function(a,b){return m()<=f.LogLevel.DEBUG&&n("QueryEngine","Using full collection scan to execute query:",aN(b)),this.Sn.getDocumentsMatchingQuery(a,b,x.min())},a}(),dK=function(){function a(a,b,c,d){this.persistence=a,this.xn=b,this.R=d,this.Fn=new bq(u),this.kn=new ds(function(a){return ai(a)},aj),this.$n=x.min(),this._n=a.getMutationQueue(c),this.On=a.getRemoteDocumentCache(),this.qe=a.getTargetCache(),this.Mn=new dH(this.On,this._n,this.persistence.getIndexManager()),this.Ke=a.getBundleCache(),this.xn.Vn(this.Mn)}return a.prototype.collectGarbage=function(a){var b=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(c){return a.collect(c,b.Fn)})},a}();/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A readonly view of the local state of all documents we're tracking (i.e. we
 * have a cached version in remoteDocumentCache or local mutations for the
 * document). The view is computed by applying the mutations in the
 * MutationQueue to the RemoteDocumentCache.
 */ function dL(a,b,c,d){return new dK(a,b,c,d)}function dM(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var h;return e=(c=h=a)._n,f=c.Mn,[4,c.persistence.runTransaction("Handle user change","readonly",function(a){var d;return c._n.getAllMutationBatches(a).next(function(g){return d=g,e=c.persistence.getMutationQueue(b),f=new dH(c.On,e,c.persistence.getIndexManager()),e.getAllMutationBatches(a)}).next(function(b){for(var c=[],e=[],g=bz(),h=0,i=d;h<i.length;h++){var j=i[h];c.push(j.batchId);for(var k=0,l=j.mutations;k<l.length;k++){var m=l[k];g=g.add(m.key)}}for(var n=0,o=b;n<o.length;n++){var p=o[n];e.push(p.batchId);for(var q=0,r=p.mutations;q<r.length;q++){var s=r[q];g=g.add(s.key)}}return f.pn(a,g).next(function(a){return{Ln:a,removedBatchIds:c,addedBatchIds:e}})})})];case 1:return g=d.sent(),[2,(c._n=e,c.Mn=f,c.xn.Vn(c.Mn),g)]}})})}function dN(a){var b,c=b=a;return c.persistence.runTransaction("Get last remote snapshot version","readonly",function(a){return c.qe.getLastRemoteSnapshotVersion(a)})}function dO(a,b,c,d,e){var f=bz();return c.forEach(function(a){return f=f.add(a)}),b.getEntries(a,f).next(function(a){var f=bv;return c.forEach(function(c,g){var h=a.get(c),i=(null==e?void 0:e.get(c))||d;g.isNoDocument()&&g.version.isEqual(x.min())?(b.removeEntry(c,i),f=f.insert(c,g)):!h.isValidDocument()||g.version.compareTo(h.version)>0||0===g.version.compareTo(h.version)&&h.hasPendingWrites?(b.addEntry(g,i),f=f.insert(c,g)):n("LocalStore","Ignoring outdated watch update for ",c,". Current version:",h.version," Watch version:",g.version)}),f})}function dP(a,b){var c,d=c=a;return d.persistence.runTransaction("Allocate target","readwrite",function(a){var c;return d.qe.getTargetData(a,b).next(function(e){return e?(c=e,cB.resolve(c)):d.qe.allocateTargetId(a).next(function(e){return c=new cP(b,e,0,a.currentSequenceNumber),d.qe.addTargetData(a,c).next(function(){return c})})})}).then(function(a){var c=d.Fn.get(a.targetId);return(null===c||a.snapshotVersion.compareTo(c.snapshotVersion)>0)&&(d.Fn=d.Fn.insert(a.targetId,a),d.kn.set(b,a.targetId)),a})}function dQ(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f,g,h;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var i;f=(e=i=a).Fn.get(b),g=c?"readwrite":"readwrite-primary",d.label=1;case 1:return d.trys.push([1,4,,5]),c?[3,3]:[4,e.persistence.runTransaction("Release target",g,function(a){return e.persistence.referenceDelegate.removeTarget(a,f)})];case 2:d.sent(),d.label=3;case 3:return[3,5];case 4:if(!cG(h=d.sent()))throw h;return n("LocalStore","Failed to update sequence numbers for target "+b+": "+h),[3,5];case 5:return e.Fn=e.Fn.remove(b),e.kn.delete(f.target),[2]}})})}function dR(a,b,c){var d,e=d=a,f=x.min(),g=bz();return e.persistence.runTransaction("Execute query","readonly",function(a){var d,h,i,j,k,l;return(d=e,h=a,i=aJ(b),void 0!==(l=(k=j=d).kn.get(i))?cB.resolve(k.Fn.get(l)):k.qe.getTargetData(h,i)).next(function(b){if(b)return f=b.lastLimboFreeSnapshotVersion,e.qe.getMatchingKeysForTargetId(a,b.targetId).next(function(a){g=a})}).next(function(){return e.xn.getDocumentsMatchingQuery(a,b,c?f:x.min(),c?g:bz())}).next(function(a){return{documents:a,Bn:g}})})}function dS(a,b){var c,d,e=c=a,f=d=e.qe,g=e.Fn.get(b);return g?Promise.resolve(g.target):e.persistence.runTransaction("Get target data","readonly",function(a){return f.lt(a,b).next(function(a){return a?a.target:null})})}function dT(a){var b,c=b=a;return c.persistence.runTransaction("Get new document changes","readonly",function(a){var b,d,e,f,g,h,i,j,k;return b=c.On,d=a,e=c.$n,g=f=b,h=bv,i=cT(e),j=dx(d),k=IDBKeyRange.lowerBound(i,!0),j.$t({index:co.readTimeIndex,range:k},function(a,b){var c=cR(g.R,b);h=h.insert(c.key,c),i=b.readTime}).next(function(){return{wn:h,readTime:cU(i)}})}).then(function(a){var b=a.wn,d=a.readTime;return c.$n=d,b})}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var dU=function(){function a(a){this.R=a,this.Qn=new Map,this.jn=new Map}return a.prototype.getBundleMetadata=function(a,b){return cB.resolve(this.Qn.get(b))},a.prototype.saveBundleMetadata=function(a,b){var c;return this.Qn.set(b.id,{id:(c=b).id,version:c.version,createTime:bP(c.createTime)}),cB.resolve()},a.prototype.getNamedQuery=function(a,b){return cB.resolve(this.jn.get(b))},a.prototype.saveNamedQuery=function(a,b){var c;return this.jn.set(b.name,{name:(c=b).name,query:c$(c.bundledQuery),readTime:bP(c.readTime)}),cB.resolve()},a}(),dV=function(){function a(){this.Wn=new bt(dW.Gn),this.zn=new bt(dW.Hn)}return a.prototype.isEmpty=function(){return this.Wn.isEmpty()},a.prototype.addReference=function(a,b){var c=new dW(a,b);this.Wn=this.Wn.add(c),this.zn=this.zn.add(c)},a.prototype.Jn=function(a,b){var c=this;a.forEach(function(a){return c.addReference(a,b)})},a.prototype.removeReference=function(a,b){this.Yn(new dW(a,b))},a.prototype.Xn=function(a,b){var c=this;a.forEach(function(a){return c.removeReference(a,b)})},a.prototype.Zn=function(a){var b=this,c=new Q(new C([])),d=new dW(c,a),e=new dW(c,a+1),f=[];return this.zn.forEachInRange([d,e],function(a){b.Yn(a),f.push(a.key)}),f},a.prototype.ts=function(){var a=this;this.Wn.forEach(function(b){return a.Yn(b)})},a.prototype.Yn=function(a){this.Wn=this.Wn.delete(a),this.zn=this.zn.delete(a)},a.prototype.es=function(a){var b=new Q(new C([])),c=new dW(b,a),d=new dW(b,a+1),e=bz();return this.zn.forEachInRange([c,d],function(a){e=e.add(a.key)}),e},a.prototype.containsKey=function(a){var b=new dW(a,0),c=this.Wn.firstAfterOrEqual(b);return null!==c&&a.isEqual(c.key)},a}(),dW=function(){function a(a,b){this.key=a,this.ns=b}return a.Gn=function(a,b){return Q.comparator(a.key,b.key)||u(a.ns,b.ns)},a.Hn=function(a,b){return u(a.ns,b.ns)||Q.comparator(a.key,b.key)},a}(),dX=function(){function a(a,b){this.Ut=a,this.referenceDelegate=b,this._n=[],this.ss=1,this.rs=new bt(dW.Gn)}return a.prototype.checkEmpty=function(a){return cB.resolve(0===this._n.length)},a.prototype.addMutationBatch=function(a,b,c,d){var e=this.ss;this.ss++,this._n.length>0&&this._n[this._n.length-1];var f=new cN(e,b,c,d);this._n.push(f);for(var g=0,h=d;g<h.length;g++){var i=h[g];this.rs=this.rs.add(new dW(i.key,e)),this.Ut.addToCollectionParentIndex(a,i.key.path.popLast())}return cB.resolve(f)},a.prototype.lookupMutationBatch=function(a,b){return cB.resolve(this.os(b))},a.prototype.getNextMutationBatchAfterBatchId=function(a,b){var c=this.cs(b+1),d=c<0?0:c;return cB.resolve(this._n.length>d?this._n[d]:null)},a.prototype.getHighestUnacknowledgedBatchId=function(){return cB.resolve(0===this._n.length?-1:this.ss-1)},a.prototype.getAllMutationBatches=function(a){return cB.resolve(this._n.slice())},a.prototype.getAllMutationBatchesAffectingDocumentKey=function(a,b){var c=this,d=new dW(b,0),e=new dW(b,Number.POSITIVE_INFINITY),f=[];return this.rs.forEachInRange([d,e],function(a){var b=c.os(a.ns);f.push(b)}),cB.resolve(f)},a.prototype.getAllMutationBatchesAffectingDocumentKeys=function(a,b){var c=this,d=new bt(u);return b.forEach(function(a){var b=new dW(a,0),e=new dW(a,Number.POSITIVE_INFINITY);c.rs.forEachInRange([b,e],function(a){d=d.add(a.ns)})}),cB.resolve(this.us(d))},a.prototype.getAllMutationBatchesAffectingQuery=function(a,b){var c=b.path,d=c.length+1,e=c;Q.isDocumentKey(e)||(e=e.child(""));var f=new dW(new Q(e),0),g=new bt(u);return this.rs.forEachWhile(function(a){var b=a.key.path;return!!c.isPrefixOf(b)&&(b.length===d&&(g=g.add(a.ns)),!0)},f),cB.resolve(this.us(g))},a.prototype.us=function(a){var b=this,c=[];return a.forEach(function(a){var d=b.os(a);null!==d&&c.push(d)}),c},a.prototype.removeMutationBatch=function(a,b){var c,d=this;0===this.hs(b.batchId,"removed")||r(),this._n.shift();var e=this.rs;return cB.forEach(b.mutations,function(c){var f=new dW(c.key,b.batchId);return e=e.delete(f),d.referenceDelegate.markPotentiallyOrphaned(a,c.key)}).next(function(){d.rs=e})},a.prototype.Gt=function(a){},a.prototype.containsKey=function(a,b){var c=new dW(b,0),d=this.rs.firstAfterOrEqual(c);return cB.resolve(b.isEqual(d&&d.key))},a.prototype.performConsistencyCheck=function(a){return this._n.length,cB.resolve()},a.prototype.hs=function(a,b){return this.cs(a)},a.prototype.cs=function(a){return 0===this._n.length?0:a-this._n[0].batchId},a.prototype.os=function(a){var b=this.cs(a);return b<0||b>=this._n.length?null:this._n[b]},a}(),dY=function(){function a(a,b){this.Ut=a,this.ls=b,this.docs=new bq(Q.comparator),this.size=0}return a.prototype.addEntry=function(a,b,c){var d=b.key,e=this.docs.get(d),f=e?e.size:0,g=this.ls(b);return this.docs=this.docs.insert(d,{document:b.clone(),size:g,readTime:c}),this.size+=g-f,this.Ut.addToCollectionParentIndex(a,d.path.popLast())},a.prototype.removeEntry=function(a){var b=this.docs.get(a);b&&(this.docs=this.docs.remove(a),this.size-=b.size)},a.prototype.getEntry=function(a,b){var c=this.docs.get(b);return cB.resolve(c?c.document.clone():af.newInvalidDocument(b))},a.prototype.getEntries=function(a,b){var c=this,d=bv;return b.forEach(function(a){var b=c.docs.get(a);d=d.insert(a,b?b.document.clone():af.newInvalidDocument(a))}),cB.resolve(d)},a.prototype.getDocumentsMatchingQuery=function(a,b,c){for(var d=bv,e=new Q(b.path.child("")),f=this.docs.getIteratorFrom(e);f.hasNext();){var g=f.getNext(),h=g.key,i=g.value,j=i.document,k=i.readTime;if(!b.path.isPrefixOf(h.path))break;0>=k.compareTo(c)||aO(b,j)&&(d=d.insert(j.key,j.clone()))}return cB.resolve(d)},a.prototype.fs=function(a,b){return cB.forEach(this.docs,function(a){return b(a)})},a.prototype.newChangeBuffer=function(a){return new dZ(this)},a.prototype.getSize=function(a){return cB.resolve(this.size)},a}(),dZ=function(a){function b(b){var c=this;return(c=a.call(this)||this).Ie=b,c}return(0,d.__extends)(b,a),b.prototype.applyChanges=function(a){var b=this,c=[];return this.changes.forEach(function(d,e){e.document.isValidDocument()?c.push(b.Ie.addEntry(a,e.document,b.getReadTime(d))):b.Ie.removeEntry(d)}),cB.waitFor(c)},b.prototype.getFromCache=function(a,b){return this.Ie.getEntry(a,b)},b.prototype.getAllFromCache=function(a,b){return this.Ie.getEntries(a,b)},b}(dt),d$=function(){function a(a){this.persistence=a,this.ds=new ds(function(a){return ai(a)},aj),this.lastRemoteSnapshotVersion=x.min(),this.highestTargetId=0,this.ws=0,this._s=new dV,this.targetCount=0,this.ys=df.Jt()}return a.prototype.forEachTarget=function(a,b){return this.ds.forEach(function(a,c){return b(c)}),cB.resolve()},a.prototype.getLastRemoteSnapshotVersion=function(a){return cB.resolve(this.lastRemoteSnapshotVersion)},a.prototype.getHighestSequenceNumber=function(a){return cB.resolve(this.ws)},a.prototype.allocateTargetId=function(a){return this.highestTargetId=this.ys.next(),cB.resolve(this.highestTargetId)},a.prototype.setTargetsMetadata=function(a,b,c){return c&&(this.lastRemoteSnapshotVersion=c),b>this.ws&&(this.ws=b),cB.resolve()},a.prototype.te=function(a){this.ds.set(a.target,a);var b=a.targetId;b>this.highestTargetId&&(this.ys=new df(b),this.highestTargetId=b),a.sequenceNumber>this.ws&&(this.ws=a.sequenceNumber)},a.prototype.addTargetData=function(a,b){return this.te(b),this.targetCount+=1,cB.resolve()},a.prototype.updateTargetData=function(a,b){return this.te(b),cB.resolve()},a.prototype.removeTargetData=function(a,b){return this.ds.delete(b.target),this._s.Zn(b.targetId),this.targetCount-=1,cB.resolve()},a.prototype.removeTargets=function(a,b,c){var d=this,e=0,f=[];return this.ds.forEach(function(g,h){h.sequenceNumber<=b&&null===c.get(h.targetId)&&(d.ds.delete(g),f.push(d.removeMatchingKeysForTargetId(a,h.targetId)),e++)}),cB.waitFor(f).next(function(){return e})},a.prototype.getTargetCount=function(a){return cB.resolve(this.targetCount)},a.prototype.getTargetData=function(a,b){var c=this.ds.get(b)||null;return cB.resolve(c)},a.prototype.addMatchingKeys=function(a,b,c){return this._s.Jn(b,c),cB.resolve()},a.prototype.removeMatchingKeys=function(a,b,c){this._s.Xn(b,c);var d=this.persistence.referenceDelegate,e=[];return d&&b.forEach(function(b){e.push(d.markPotentiallyOrphaned(a,b))}),cB.waitFor(e)},a.prototype.removeMatchingKeysForTargetId=function(a,b){return this._s.Zn(b),cB.resolve()},a.prototype.getMatchingKeysForTargetId=function(a,b){var c=this._s.es(b);return cB.resolve(c)},a.prototype.containsKey=function(a,b){return cB.resolve(this._s.containsKey(b))},a}(),d_=function(){function a(a,b){var c,d=this;this.gs={},this.Ne=new i(0),this.xe=!1,this.xe=!0,this.referenceDelegate=a(this),this.qe=new d$(this),this.Ut=new c2,this.Ue=(c=this.Ut,new dY(c,function(a){return d.referenceDelegate.ps(a)})),this.R=new cQ(b),this.Ke=new dU(this.R)}return a.prototype.start=function(){return Promise.resolve()},a.prototype.shutdown=function(){return this.xe=!1,Promise.resolve()},Object.defineProperty(a.prototype,"started",{get:function(){return this.xe},enumerable:!1,configurable:!0}),a.prototype.setDatabaseDeletedListener=function(){},a.prototype.setNetworkEnabled=function(){},a.prototype.getIndexManager=function(){return this.Ut},a.prototype.getMutationQueue=function(a){var b=this.gs[a.toKey()];return b||(b=new dX(this.Ut,this.referenceDelegate),this.gs[a.toKey()]=b),b},a.prototype.getTargetCache=function(){return this.qe},a.prototype.getRemoteDocumentCache=function(){return this.Ue},a.prototype.getBundleCache=function(){return this.Ke},a.prototype.runTransaction=function(a,b,c){var d=this;n("MemoryPersistence","Starting transaction:",a);var e=new d0(this.Ne.next());return this.referenceDelegate.Es(),c(e).next(function(a){return d.referenceDelegate.Ts(e).next(function(){return a})}).toPromise().then(function(a){return e.raiseOnCommittedEvent(),a})},a.prototype.Is=function(a,b){return cB.or(Object.values(this.gs).map(function(c){return function(){return c.containsKey(a,b)}}))},a}(),d0=function(a){function b(b){var c=this;return(c=a.call(this)||this).currentSequenceNumber=b,c}return(0,d.__extends)(b,a),b}(cz),d1=function(){function a(a){this.persistence=a,this.As=new dV,this.Rs=null}return a.bs=function(b){return new a(b)},Object.defineProperty(a.prototype,"vs",{get:function(){if(this.Rs)return this.Rs;throw r()},enumerable:!1,configurable:!0}),a.prototype.addReference=function(a,b,c){return this.As.addReference(c,b),this.vs.delete(c.toString()),cB.resolve()},a.prototype.removeReference=function(a,b,c){return this.As.removeReference(c,b),this.vs.add(c.toString()),cB.resolve()},a.prototype.markPotentiallyOrphaned=function(a,b){return this.vs.add(b.toString()),cB.resolve()},a.prototype.removeTarget=function(a,b){var c=this;this.As.Zn(b.targetId).forEach(function(a){return c.vs.add(a.toString())});var d=this.persistence.getTargetCache();return d.getMatchingKeysForTargetId(a,b.targetId).next(function(a){a.forEach(function(a){return c.vs.add(a.toString())})}).next(function(){return d.removeTargetData(a,b)})},a.prototype.Es=function(){this.Rs=new Set},a.prototype.Ts=function(a){var b=this,c=this.persistence.getRemoteDocumentCache().newChangeBuffer();return cB.forEach(this.vs,function(d){var e=Q.fromPath(d);return b.Ps(a,e).next(function(a){a||c.removeEntry(e)})}).next(function(){return b.Rs=null,c.apply(a)})},a.prototype.updateLimboDocument=function(a,b){var c=this;return this.Ps(a,b).next(function(a){a?c.vs.delete(b.toString()):c.vs.add(b.toString())})},a.prototype.ps=function(a){return 0},a.prototype.Ps=function(a,b){var c=this;return cB.or([function(){return cB.resolve(c.As.containsKey(b))},function(){return c.persistence.getTargetCache().containsKey(a,b)},function(){return c.persistence.Is(a,b)}])},a}(),d2=function(){function a(a){this.uid=a}return a.prototype.isAuthenticated=function(){return null!=this.uid},a.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"},a.prototype.isEqual=function(a){return a.uid===this.uid},a}();/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A collection of references to a document from some kind of numbered entity
 * (either a target ID or batch ID). As references are added to or removed from
 * the set corresponding events are emitted to a registered garbage collector.
 *
 * Each reference is represented by a DocumentReference object. Each of them
 * contains enough information to uniquely identify the reference. They are all
 * stored primarily in a set sorted by key. A document is considered garbage if
 * there's no references in that set (this can be efficiently checked thanks to
 * sorting by key).
 *
 * ReferenceSet also keeps a secondary set that contains references sorted by
 * IDs. This one is used to efficiently implement removal of all references by
 * some target ID.
 */ /** Assembles the key for a client state in WebStorage */ function d3(a,b){return"firestore_clients_"+a+"_"+b}function d4(a,b,c){var d="firestore_mutations_"+a+"_"+c;return b.isAuthenticated()&&(d+="_"+b.uid),d}function d5(a,b){return"firestore_targets_"+a+"_"+b}d2.UNAUTHENTICATED=new d2(null),d2.GOOGLE_CREDENTIALS=new d2("google-credentials-uid"),d2.FIRST_PARTY=new d2("first-party-uid");var d6=function(){function a(a,b,c,d){this.user=a,this.batchId=b,this.state=c,this.error=d}return a.Vs=function(b,c,d){var e,f=JSON.parse(d),g="object"==typeof f&& -1!==["pending","acknowledged","rejected"].indexOf(f.state)&&(void 0===f.error||"object"==typeof f.error);return g&&f.error&&(g="string"==typeof f.error.message&&"string"==typeof f.error.code)&&(e=new k(f.error.code,f.error.message)),g?new a(b,c,f.state,e):(o("SharedClientState","Failed to parse mutation state for ID '"+c+"': "+d),null)},a.prototype.Ss=function(){var a={state:this.state,updateTimeMs:Date.now()};return this.error&&(a.error={code:this.error.code,message:this.error.message}),JSON.stringify(a)},a}(),d7=function(){function a(a,b,c){this.targetId=a,this.state=b,this.error=c}return a.Vs=function(b,c){var d,e=JSON.parse(c),f="object"==typeof e&& -1!==["not-current","current","rejected"].indexOf(e.state)&&(void 0===e.error||"object"==typeof e.error);return f&&e.error&&(f="string"==typeof e.error.message&&"string"==typeof e.error.code)&&(d=new k(e.error.code,e.error.message)),f?new a(b,e.state,d):(o("SharedClientState","Failed to parse target state for ID '"+b+"': "+c),null)},a.prototype.Ss=function(){var a={state:this.state,updateTimeMs:Date.now()};return this.error&&(a.error={code:this.error.code,message:this.error.message}),JSON.stringify(a)},a}(),d8=function(){function a(a,b){this.clientId=a,this.activeTargetIds=b}return a.Vs=function(b,c){for(var d=JSON.parse(c),e="object"==typeof d&&d.activeTargetIds instanceof Array,f=bA,g=0;e&&g<d.activeTargetIds.length;++g)e=P(d.activeTargetIds[g]),f=f.add(d.activeTargetIds[g]);return e?new a(b,f):(o("SharedClientState","Failed to parse client data for instance '"+b+"': "+c),null)},a}(),d9=function(){function a(a,b){this.clientId=a,this.onlineState=b}return a.Vs=function(b){var c=JSON.parse(b);return"object"==typeof c&& -1!==["Unknown","Online","Offline"].indexOf(c.onlineState)&&"string"==typeof c.clientId?new a(c.clientId,c.onlineState):(o("SharedClientState","Failed to parse online state: "+b),null)},a}(),ea=function(){function a(){this.activeTargetIds=bA}return a.prototype.Ds=function(a){this.activeTargetIds=this.activeTargetIds.add(a)},a.prototype.Cs=function(a){this.activeTargetIds=this.activeTargetIds.delete(a)},a.prototype.Ss=function(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})},a}(),eb=function(){function a(a,b,c,d,e){this.window=a,this.Se=b,this.persistenceKey=c,this.Ns=d,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.xs=this.Fs.bind(this),this.ks=new bq(u),this.started=!1,this.$s=[];var f,g,h,i=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=e,this.Os=d3(this.persistenceKey,this.Ns),this.Ms="firestore_sequence_number_"+(f=this.persistenceKey),this.ks=this.ks.insert(this.Ns,new ea),this.Ls=RegExp("^firestore_clients_"+i+"_([^_]*)$"),this.Bs=RegExp("^firestore_mutations_"+i+"_(\\d+)(?:_(.*))?$"),this.qs=RegExp("^firestore_targets_"+i+"_(\\d+)$"),this.Us="firestore_online_state_"+(g=this.persistenceKey),this.Ks="firestore_bundle_loaded_"+(h=this.persistenceKey),this.window.addEventListener("storage",this.xs)}return a.yt=function(a){return!(!a||!a.localStorage)},a.prototype.start=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a,b,c,e,f,g,h,i,j,k,l,m=this;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return[4,this.syncEngine.fn()];case 1:for(a=d.sent(),b=0,c=a;b<c.length;b++)(e=c[b])!==this.Ns&&(f=this.getItem(d3(this.persistenceKey,e)))&&(g=d8.Vs(e,f))&&(this.ks=this.ks.insert(g.clientId,g));for(this.Qs(),(h=this.storage.getItem(this.Us))&&(i=this.js(h))&&this.Ws(i),j=0,k=this.$s;j<k.length;j++)l=k[j],this.Fs(l);return this.$s=[],this.window.addEventListener("pagehide",function(){return m.shutdown()}),this.started=!0,[2]}})})},a.prototype.writeSequenceNumber=function(a){this.setItem(this.Ms,JSON.stringify(a))},a.prototype.getAllActiveQueryTargets=function(){return this.Gs(this.ks)},a.prototype.isActiveQueryTarget=function(a){var b=!1;return this.ks.forEach(function(c,d){d.activeTargetIds.has(a)&&(b=!0)}),b},a.prototype.addPendingMutation=function(a){this.zs(a,"pending")},a.prototype.updateMutationState=function(a,b,c){this.zs(a,b,c),this.Hs(a)},a.prototype.addLocalQueryTarget=function(a){var b="not-current";if(this.isActiveQueryTarget(a)){var c=this.storage.getItem(d5(this.persistenceKey,a));if(c){var d=d7.Vs(a,c);d&&(b=d.state)}}return this.Js.Ds(a),this.Qs(),b},a.prototype.removeLocalQueryTarget=function(a){this.Js.Cs(a),this.Qs()},a.prototype.isLocalQueryTarget=function(a){return this.Js.activeTargetIds.has(a)},a.prototype.clearQueryState=function(a){this.removeItem(d5(this.persistenceKey,a))},a.prototype.updateQueryState=function(a,b,c){this.Ys(a,b,c)},a.prototype.handleUserChange=function(a,b,c){var d=this;b.forEach(function(a){d.Hs(a)}),this.currentUser=a,c.forEach(function(a){d.addPendingMutation(a)})},a.prototype.setOnlineState=function(a){this.Xs(a)},a.prototype.notifyBundleLoaded=function(){this.Zs()},a.prototype.shutdown=function(){this.started&&(this.window.removeEventListener("storage",this.xs),this.removeItem(this.Os),this.started=!1)},a.prototype.getItem=function(a){var b=this.storage.getItem(a);return n("SharedClientState","READ",a,b),b},a.prototype.setItem=function(a,b){n("SharedClientState","SET",a,b),this.storage.setItem(a,b)},a.prototype.removeItem=function(a){n("SharedClientState","REMOVE",a),this.storage.removeItem(a)},a.prototype.Fs=function(a){var b=this,c=a;if(c.storageArea===this.storage){if(n("SharedClientState","EVENT",c.key,c.newValue),c.key===this.Os)return void o("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Se.enqueueRetryable(function(){return(0,d.__awaiter)(b,void 0,void 0,function(){var a,b,e,f,g,h;return(0,d.__generator)(this,function(d){if(this.started){if(null!==c.key){if(this.Ls.test(c.key)){if(null==c.newValue)return a=this.ti(c.key),[2,this.ei(a,null)];if(b=this.ni(c.key,c.newValue))return[2,this.ei(b.clientId,b)]}else if(this.Bs.test(c.key)){if(null!==c.newValue&&(e=this.si(c.key,c.newValue)))return[2,this.ii(e)]}else if(this.qs.test(c.key)){if(null!==c.newValue&&(f=this.ri(c.key,c.newValue)))return[2,this.oi(f)]}else if(c.key===this.Us){if(null!==c.newValue&&(g=this.js(c.newValue)))return[2,this.Ws(g)]}else if(c.key===this.Ms)(h=function(a){var b=i.o;if(null!=a)try{var c,d=JSON.parse(a);"number"==typeof d||r(),b=d}catch(e){o("SharedClientState","Failed to read sequence number from WebStorage",e)}return b}(c.newValue))!==i.o&&this.sequenceNumberHandler(h);else if(c.key===this.Ks)return[2,this.syncEngine.ci()]}}else this.$s.push(c);return[2]})})})}},Object.defineProperty(a.prototype,"Js",{get:function(){return this.ks.get(this.Ns)},enumerable:!1,configurable:!0}),a.prototype.Qs=function(){this.setItem(this.Os,this.Js.Ss())},a.prototype.zs=function(a,b,c){var d=new d6(this.currentUser,a,b,c),e=d4(this.persistenceKey,this.currentUser,a);this.setItem(e,d.Ss())},a.prototype.Hs=function(a){var b=d4(this.persistenceKey,this.currentUser,a);this.removeItem(b)},a.prototype.Xs=function(a){var b={clientId:this.Ns,onlineState:a};this.storage.setItem(this.Us,JSON.stringify(b))},a.prototype.Ys=function(a,b,c){var d=d5(this.persistenceKey,a),e=new d7(a,b,c);this.setItem(d,e.Ss())},a.prototype.Zs=function(){this.setItem(this.Ks,"value-not-used")},a.prototype.ti=function(a){var b=this.Ls.exec(a);return b?b[1]:null},a.prototype.ni=function(a,b){var c=this.ti(a);return d8.Vs(c,b)},a.prototype.si=function(a,b){var c=this.Bs.exec(a),d=Number(c[1]),e=void 0!==c[2]?c[2]:null;return d6.Vs(new d2(e),d,b)},a.prototype.ri=function(a,b){var c=this.qs.exec(a),d=Number(c[1]);return d7.Vs(d,b)},a.prototype.js=function(a){return d9.Vs(a)},a.prototype.ii=function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(b){return a.user.uid===this.currentUser.uid?[2,this.syncEngine.ui(a.batchId,a.state,a.error)]:(n("SharedClientState","Ignoring mutation for non-active user "+a.user.uid),[2])})})},a.prototype.oi=function(a){return this.syncEngine.ai(a.targetId,a.state,a.error)},a.prototype.ei=function(a,b){var c=this,d=b?this.ks.insert(a,b):this.ks.remove(a),e=this.Gs(this.ks),f=this.Gs(d),g=[],h=[];return f.forEach(function(a){e.has(a)||g.push(a)}),e.forEach(function(a){f.has(a)||h.push(a)}),this.syncEngine.hi(g,h).then(function(){c.ks=d})},a.prototype.Ws=function(a){this.ks.get(a.clientId)&&this.onlineStateHandler(a.onlineState)},a.prototype.Gs=function(a){var b=bA;return a.forEach(function(a,c){b=b.unionWith(c.activeTargetIds)}),b},a}(),ec=function(){function a(){this.li=new ea,this.fi={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}return a.prototype.addPendingMutation=function(a){},a.prototype.updateMutationState=function(a,b,c){},a.prototype.addLocalQueryTarget=function(a){return this.li.Ds(a),this.fi[a]||"not-current"},a.prototype.updateQueryState=function(a,b,c){this.fi[a]=b},a.prototype.removeLocalQueryTarget=function(a){this.li.Cs(a)},a.prototype.isLocalQueryTarget=function(a){return this.li.activeTargetIds.has(a)},a.prototype.clearQueryState=function(a){delete this.fi[a]},a.prototype.getAllActiveQueryTargets=function(){return this.li.activeTargetIds},a.prototype.isActiveQueryTarget=function(a){return this.li.activeTargetIds.has(a)},a.prototype.start=function(){return this.li=new ea,Promise.resolve()},a.prototype.handleUserChange=function(a,b,c){},a.prototype.setOnlineState=function(a){},a.prototype.shutdown=function(){},a.prototype.writeSequenceNumber=function(a){},a.prototype.notifyBundleLoaded=function(){},a}(),ed=function(){function a(){}return a.prototype.di=function(a){},a.prototype.shutdown=function(){},a}(),ee=function(){function a(){var a=this;this.wi=function(){return a._i()},this.mi=function(){return a.yi()},this.gi=[],this.pi()}return a.prototype.di=function(a){this.gi.push(a)},a.prototype.shutdown=function(){window.removeEventListener("online",this.wi),window.removeEventListener("offline",this.mi)},a.prototype.pi=function(){window.addEventListener("online",this.wi),window.addEventListener("offline",this.mi)},a.prototype._i=function(){n("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(var a=0,b=this.gi;a<b.length;a++)(0,b[a])(0)},a.prototype.yi=function(){n("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(var a=0,b=this.gi;a<b.length;a++)(0,b[a])(1)},a.yt=function(){return"undefined"!=typeof window&& void 0!==window.addEventListener&& void 0!==window.removeEventListener},a}(),ef={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"},eg=function(){function a(a){this.Ei=a.Ei,this.Ti=a.Ti}return a.prototype.Ii=function(a){this.Ai=a},a.prototype.Ri=function(a){this.bi=a},a.prototype.onMessage=function(a){this.vi=a},a.prototype.close=function(){this.Ti()},a.prototype.send=function(a){this.Ei(a)},a.prototype.Pi=function(){this.Ai()},a.prototype.Vi=function(a){this.bi(a)},a.prototype.Si=function(a){this.vi(a)},a}(),eh=function(a){function b(b){var c=this;return(c=a.call(this,b)||this).forceLongPolling=b.forceLongPolling,c.autoDetectLongPolling=b.autoDetectLongPolling,c.useFetchStreams=b.useFetchStreams,c}return(0,d.__extends)(b,a),b.prototype.ki=function(a,b,c,d){return new Promise(function(e,f){var h=new g.JJ;h.listenOnce(g.tw.COMPLETE,function(){try{switch(h.getLastErrorCode()){case g.jK.NO_ERROR:var b=h.getResponseJson();n("Connection","XHR received:",JSON.stringify(b)),e(b);break;case g.jK.TIMEOUT:n("Connection",'RPC "'+a+'" timed out'),f(new k(j.DEADLINE_EXCEEDED,"Request time out"));break;case g.jK.HTTP_ERROR:var c=h.getStatus();if(n("Connection",'RPC "'+a+'" failed with status:',c,"response text:",h.getResponseText()),c>0){var d=h.getResponseJson().error;if(d&&d.status&&d.message){var i,l,m=(l=(i=d.status).toLowerCase().replace(/_/g,"-"),Object.values(j).indexOf(l)>=0?l:j.UNKNOWN);f(new k(m,d.message))}else f(new k(j.UNKNOWN,"Server responded with status "+h.getStatus()))}else f(new k(j.UNAVAILABLE,"Connection failed."));break;default:r()}}finally{n("Connection",'RPC "'+a+'" completed.')}});var i=JSON.stringify(d);h.send(b,"POST",i,c,15)})},b.prototype.Oi=function(a,b){var c=[this.Di,"/","google.firestore.v1.Firestore","/",a,"/channel"],d=(0,g.UE)(),f=(0,g.FJ)(),h={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(h.xmlHttpFactory=new g.zI({})),this.Fi(h.initMessageHeaders,b),(0,e.isMobileCordova)()||(0,e.isReactNative)()||(0,e.isElectron)()||(0,e.isIE)()||(0,e.isUWP)()||(0,e.isBrowserExtension)()||(h.httpHeadersOverwriteParam="$httpHeaders");var i=c.join("");n("Connection","Creating WebChannel: "+i,h);var l=d.createWebChannel(i,h),m=!1,o=!1,q=new eg({Ei:function(a){o?n("Connection","Not sending because WebChannel is closed:",a):(m||(n("Connection","Opening WebChannel transport."),l.open(),m=!0),n("Connection","WebChannel sending:",a),l.send(a))},Ti:function(){return l.close()}}),s=function(a,b,c){a.listen(b,function(a){try{c(a)}catch(b){setTimeout(function(){throw b},0)}})};return s(l,g.ii.EventType.OPEN,function(){o||n("Connection","WebChannel transport opened.")}),s(l,g.ii.EventType.CLOSE,function(){o||(o=!0,n("Connection","WebChannel transport closed"),q.Vi())}),s(l,g.ii.EventType.ERROR,function(a){o||(o=!0,p("Connection","WebChannel transport errored:",a),q.Vi(new k(j.UNAVAILABLE,"The operation could not be completed")))}),s(l,g.ii.EventType.MESSAGE,function(a){var b;if(!o){var c,d=a.data[0];(c=!!d)||r();var e=d,f=e.error||(null===(b=e[0])|| void 0===b?void 0:b.error);if(f){n("Connection","WebChannel received error:",f);var g=f.status,h=function(a){var b=bj[a];if(void 0!==b)return bp(b)}(g),i=f.message;void 0===h&&(h=j.INTERNAL,i="Unknown error status: "+g+" with message "+f.message),o=!0,q.Vi(new k(h,i)),l.close()}else n("Connection","WebChannel received:",d),q.Si(d)}}),s(f,g.ju.STAT_EVENT,function(a){a.stat===g.kN.PROXY?n("Connection","Detected buffering proxy"):a.stat===g.kN.NOPROXY&&n("Connection","Detected no buffering proxy")}),setTimeout(function(){q.Pi()},0),q},b}(function(){function a(a){this.databaseInfo=a,this.databaseId=a.databaseId;var b=a.ssl?"https":"http";this.Di=b+"://"+a.host,this.Ci="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}return a.prototype.Ni=function(a,b,c,d){var e=this.xi(a,b);n("RestConnection","Sending: ",e,c);var f={};return this.Fi(f,d),this.ki(a,e,f,c).then(function(a){return n("RestConnection","Received: ",a),a},function(b){throw p("RestConnection",a+" failed with error: ",b,"url: ",e,"request:",c),b})},a.prototype.$i=function(a,b,c,d){return this.Ni(a,b,c,d)},a.prototype.Fi=function(a,b){if(a["X-Goog-Api-Client"]="gl-js/ fire/8.8.0",a["Content-Type"]="text/plain",this.databaseInfo.appId&&(a["X-Firebase-GMPID"]=this.databaseInfo.appId),b)for(var c in b.authHeaders)b.authHeaders.hasOwnProperty(c)&&(a[c]=b.authHeaders[c])},a.prototype.xi=function(a,b){var c=ef[a];return this.Di+"/v1/"+b+":"+c},a}());/**
 * Holds the state of a query target, including its target ID and whether the
 * target is 'not-current', 'current' or 'rejected'.
 */ // Visible for testing
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** Initializes the WebChannelConnection for the browser. */ /**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** The Platform's 'window' implementation or null if not available. */ function ei(){return"undefined"!=typeof window?window:null}function ej(){return"undefined"!=typeof document?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ function ek(a){return new bM(a,!0)}var el=function(){function a(a,b,c,d,e){void 0===c&&(c=1e3),void 0===d&&(d=1.5),void 0===e&&(e=6e4),this.Se=a,this.timerId=b,this.Mi=c,this.Li=d,this.Bi=e,this.qi=0,this.Ui=null,this.Ki=Date.now(),this.reset()}return a.prototype.reset=function(){this.qi=0},a.prototype.Qi=function(){this.qi=this.Bi},a.prototype.ji=function(a){var b=this;this.cancel();var c=Math.floor(this.qi+this.Wi()),d=Math.max(0,Date.now()-this.Ki),e=Math.max(0,c-d);e>0&&n("ExponentialBackoff","Backing off for "+e+" ms (base delay: "+this.qi+" ms, delay with jitter: "+c+" ms, last attempt: "+d+" ms ago)"),this.Ui=this.Se.enqueueAfterDelay(this.timerId,e,function(){return b.Ki=Date.now(),a()}),this.qi*=this.Li,this.qi<this.Mi&&(this.qi=this.Mi),this.qi>this.Bi&&(this.qi=this.Bi)},a.prototype.Gi=function(){null!==this.Ui&&(this.Ui.skipDelay(),this.Ui=null)},a.prototype.cancel=function(){null!==this.Ui&&(this.Ui.cancel(),this.Ui=null)},a.prototype.Wi=function(){return(Math.random()-.5)*this.qi},a}(),em=function(){function a(a,b,c,d,e,f){this.Se=a,this.zi=c,this.Hi=d,this.Ji=e,this.listener=f,this.state=0,this.Yi=0,this.Xi=null,this.stream=null,this.Zi=new el(a,b)}return a.prototype.tr=function(){return 1===this.state||2===this.state||4===this.state},a.prototype.er=function(){return 2===this.state},a.prototype.start=function(){3!==this.state?this.auth():this.nr()},a.prototype.stop=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(a){switch(a.label){case 0:return this.tr()?[4,this.close(0)]:[3,2];case 1:a.sent(),a.label=2;case 2:return[2]}})})},a.prototype.sr=function(){this.state=0,this.Zi.reset()},a.prototype.ir=function(){var a=this;this.er()&&null===this.Xi&&(this.Xi=this.Se.enqueueAfterDelay(this.zi,6e4,function(){return a.rr()}))},a.prototype.cr=function(a){this.ur(),this.stream.send(a)},a.prototype.rr=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(a){return this.er()?[2,this.close(0)]:[2]})})},a.prototype.ur=function(){this.Xi&&(this.Xi.cancel(),this.Xi=null)},a.prototype.close=function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(c){switch(c.label){case 0:return this.ur(),this.Zi.cancel(),this.Yi++,3!==a?this.Zi.reset():b&&b.code===j.RESOURCE_EXHAUSTED?(o(b.toString()),o("Using maximum backoff delay to prevent overloading the backend."),this.Zi.Qi()):b&&b.code===j.UNAUTHENTICATED&&this.Ji.invalidateToken(),null!==this.stream&&(this.ar(),this.stream.close(),this.stream=null),this.state=a,[4,this.listener.Ri(b)];case 1:return c.sent(),[2]}})})},a.prototype.ar=function(){},a.prototype.auth=function(){var a=this;this.state=1;var b=this.hr(this.Yi),c=this.Yi;this.Ji.getToken().then(function(b){a.Yi===c&&a.lr(b)},function(c){b(function(){var b=new k(j.UNKNOWN,"Fetching auth token failed: "+c.message);return a.dr(b)})})},a.prototype.lr=function(a){var b=this,c=this.hr(this.Yi);this.stream=this.wr(a),this.stream.Ii(function(){c(function(){return b.state=2,b.listener.Ii()})}),this.stream.Ri(function(a){c(function(){return b.dr(a)})}),this.stream.onMessage(function(a){c(function(){return b.onMessage(a)})})},a.prototype.nr=function(){var a=this;this.state=4,this.Zi.ji(function(){return(0,d.__awaiter)(a,void 0,void 0,function(){return(0,d.__generator)(this,function(a){return this.state=0,this.start(),[2]})})})},a.prototype.dr=function(a){return n("PersistentStream","close with error: "+a),this.stream=null,this.close(3,a)},a.prototype.hr=function(a){var b=this;return function(c){b.Se.enqueueAndForget(function(){return b.Yi===a?c():(n("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},a}(),en=function(a){function b(b,c,d,e,f){var g=this;return(g=a.call(this,b,"listen_stream_connection_backoff","listen_stream_idle",c,d,f)||this).R=e,g}return(0,d.__extends)(b,a),b.prototype.wr=function(a){return this.Hi.Oi("Listen",a)},b.prototype.onMessage=function(a){this.Zi.reset();var b=function(a,b){var c;if("targetChange"in b){b.targetChange;var d,e,f,g,h,i,l,m="NO_CHANGE"===(d=b.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===d?1:"REMOVE"===d?2:"CURRENT"===d?3:"RESET"===d?4:r(),n=b.targetChange.targetIds||[],o=(e=a,f=b.targetChange.resumeToken,e.I?(void 0===f||"string"==typeof f||r(),G.fromBase64String(f||"")):(void 0===f||f instanceof Uint8Array||r(),G.fromUint8Array(f||new Uint8Array))),p=(q=b.targetChange.cause)&&(l=void 0===(i=q).code?j.UNKNOWN:bp(i.code),new k(l,i.message||""));c=new bF(m,n,o,p||null)}else if("documentChange"in b){b.documentChange,(m=b.documentChange).document,m.document.name,m.document.updateTime,n=bT(a,m.document.name),o=bP(m.document.updateTime);var q=new ad({mapValue:{fields:m.document.fields}}),s=(p=af.newFoundDocument(n,o,q),m.targetIds||[]),t=m.removedTargetIds||[];c=new bD(s,t,p.key,p)}else if("documentDelete"in b)b.documentDelete,(m=b.documentDelete).document,n=bT(a,m.document),o=m.readTime?bP(m.readTime):x.min(),q=af.newNoDocument(n,o),p=m.removedTargetIds||[],c=new bD([],p,q.key,q);else if("documentRemove"in b)b.documentRemove,(m=b.documentRemove).document,n=bT(a,m.document),o=m.removedTargetIds||[],c=new bD([],o,n,null);else{if(!("filter"in b))return r();b.filter;var u=b.filter;u.targetId,m=u.count||0,n=new bn(m),o=u.targetId,c=new bE(o,n)}return c}(this.R,a),c=function(a){if(!("targetChange"in a))return x.min();var b=a.targetChange;return b.targetIds&&b.targetIds.length?x.min():b.readTime?bP(b.readTime):x.min()}(a);return this.listener._r(b,c)},b.prototype.mr=function(a){var b,c,d,e,f,g,h,i={};i.database=bW(this.R),i.addTarget=(b=this.R,e=(c=a).target,(d=ak(e)?{documents:b0(b,e)}:{query:b1(b,e)}).targetId=c.targetId,c.resumeToken.approximateByteSize()>0?d.resumeToken=bO(b,c.resumeToken):c.snapshotVersion.compareTo(x.min())>0&&(d.readTime=bN(b,c.snapshotVersion.toTimestamp())),d);var j=(this.R,null==(h=function(a,b){switch(b){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return r()}}(0,(g=a).purpose))?null:{"goog-listen-tags":h});j&&(i.labels=j),this.cr(i)},b.prototype.yr=function(a){var b={};b.database=bW(this.R),b.removeTarget=a,this.cr(b)},b}(em),eo=function(a){function b(b,c,d,e,f){var g=this;return(g=a.call(this,b,"write_stream_connection_backoff","write_stream_idle",c,d,f)||this).R=e,g.gr=!1,g}return(0,d.__extends)(b,a),Object.defineProperty(b.prototype,"pr",{get:function(){return this.gr},enumerable:!1,configurable:!0}),b.prototype.start=function(){this.gr=!1,this.lastStreamToken=void 0,a.prototype.start.call(this)},b.prototype.ar=function(){this.gr&&this.Er([])},b.prototype.wr=function(a){return this.Hi.Oi("Write",a)},b.prototype.onMessage=function(a){if(!a.streamToken&&r(),this.lastStreamToken=a.streamToken,this.gr){this.Zi.reset();var b,c,d,e,f,g=(d=a.writeResults,e=a.commitTime,d&&d.length>0?(void 0!==e||r(),d.map(function(a){var b,c,d;return b=a,c=e,(d=b.updateTime?bP(b.updateTime):bP(c)).isEqual(x.min())&&(d=bP(c)),new a5(d,b.transformResults||[])})):[]),h=bP(a.commitTime);return this.listener.Tr(h,g)}return a.writeResults&&0!==a.writeResults.length&&r(),this.gr=!0,this.listener.Ir()},b.prototype.Ar=function(){var a={};a.database=bW(this.R),this.cr(a)},b.prototype.Er=function(a){var b=this,c={streamToken:this.lastStreamToken,writes:a.map(function(a){return b$(b.R,a)})};this.cr(c)},b}(em),ep=function(a){function b(b,c,d){var e=this;return(e=a.call(this)||this).credentials=b,e.Hi=c,e.R=d,e.Rr=!1,e}return(0,d.__extends)(b,a),b.prototype.br=function(){if(this.Rr)throw new k(j.FAILED_PRECONDITION,"The client has already been terminated.")},b.prototype.Ni=function(a,b,c){var d=this;return this.br(),this.credentials.getToken().then(function(e){return d.Hi.Ni(a,b,c,e)}).catch(function(a){throw"FirebaseError"===a.name?(a.code===j.UNAUTHENTICATED&&d.credentials.invalidateToken(),a):new k(j.UNKNOWN,a.toString())})},b.prototype.$i=function(a,b,c){var d=this;return this.br(),this.credentials.getToken().then(function(e){return d.Hi.$i(a,b,c,e)}).catch(function(a){throw"FirebaseError"===a.name?(a.code===j.UNAUTHENTICATED&&d.credentials.invalidateToken(),a):new k(j.UNKNOWN,a.toString())})},b.prototype.terminate=function(){this.Rr=!0},b}(function(){}),eq=function(){function a(a,b){this.asyncQueue=a,this.onlineStateHandler=b,this.state="Unknown",this.vr=0,this.Pr=null,this.Vr=!0}return a.prototype.Sr=function(){var a=this;0===this.vr&&(this.Dr("Unknown"),this.Pr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,function(){return a.Pr=null,a.Cr("Backend didn't respond within 10 seconds."),a.Dr("Offline"),Promise.resolve()}))},a.prototype.Nr=function(a){"Online"===this.state?this.Dr("Unknown"):(this.vr++,this.vr>=1&&(this.Fr(),this.Cr("Connection failed 1 times. Most recent error: "+a.toString()),this.Dr("Offline")))},a.prototype.set=function(a){this.Fr(),this.vr=0,"Online"===a&&(this.Vr=!1),this.Dr(a)},a.prototype.Dr=function(a){a!==this.state&&(this.state=a,this.onlineStateHandler(a))},a.prototype.Cr=function(a){var b="Could not reach Cloud Firestore backend. "+a+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.Vr?(o(b),this.Vr=!1):n("OnlineStateTracker",b)},a.prototype.Fr=function(){null!==this.Pr&&(this.Pr.cancel(),this.Pr=null)},a}(),er=function(a,b,c,e,f){var g=this;this.localStore=a,this.datastore=b,this.asyncQueue=c,this.remoteSyncer={},this.kr=[],this.$r=new Map,this.Or=new Set,this.Mr=[],this.Lr=f,this.Lr.di(function(a){c.enqueueAndForget(function(){return(0,d.__awaiter)(g,void 0,void 0,function(){return(0,d.__generator)(this,function(a){switch(a.label){case 0:return eA(this)?(n("RemoteStore","Restarting streams for network reachability change."),[4,function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:var d;return(b=d=a).Or.add(4),[4,et(b)];case 1:return c.sent(),b.Br.set("Unknown"),b.Or.delete(4),[4,es(b)];case 2:return c.sent(),[2]}})})}(this)]):[3,2];case 1:a.sent(),a.label=2;case 2:return[2]}})})})}),this.Br=new eq(c,e)};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A PersistentStream is an abstract base class that represents a streaming RPC
 * to the Firestore backend. It's built on top of the connections own support
 * for streaming RPCs, and adds several critical features for our clients:
 *
 *   - Exponential backoff on failure
 *   - Authentication via CredentialsProvider
 *   - Dispatching all callbacks into the shared worker queue
 *   - Closing idle streams after 60 seconds of inactivity
 *
 * Subclasses of PersistentStream implement serialization of models to and
 * from the JSON representation of the protocol buffers for a specific
 * streaming RPC.
 *
 * ## Starting and Stopping
 *
 * Streaming RPCs are stateful and need to be start()ed before messages can
 * be sent and received. The PersistentStream will call the onOpen() function
 * of the listener once the stream is ready to accept requests.
 *
 * Should a start() fail, PersistentStream will call the registered onClose()
 * listener with a FirestoreError indicating what went wrong.
 *
 * A PersistentStream can be started and stopped repeatedly.
 *
 * Generic types:
 *  SendType: The type of the outgoing message of the underlying
 *    connection stream
 *  ReceiveType: The type of the incoming message of the underlying
 *    connection stream
 *  ListenerType: The type of the listener that will be used for callbacks
 */ function es(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b,c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:if(!eA(a))return[3,4];b=0,c=a.Mr,d.label=1;case 1:return b<c.length?[4,(0,c[b])(!0)]:[3,4];case 2:d.sent(),d.label=3;case 3:return b++,[3,1];case 4:return[2]}})})}function et(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b,c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:b=0,c=a.Mr,d.label=1;case 1:return b<c.length?[4,(0,c[b])(!1)]:[3,4];case 2:d.sent(),d.label=3;case 3:return b++,[3,1];case 4:return[2]}})})}function eu(a,b){var c,d=c=a;d.$r.has(b.targetId)||(d.$r.set(b.targetId,b),ez(d)?ey(d):eP(d).er()&&ew(d,b))}function ev(a,b){var c,d=c=a,e=eP(d);d.$r.delete(b),e.er()&&ex(d,b),0===d.$r.size&&(e.er()?e.ir():eA(d)&&d.Br.set("Unknown"))}function ew(a,b){a.qr.U(b.targetId),eP(a).mr(b)}function ex(a,b){a.qr.U(b),eP(a).yr(b)}function ey(a){a.qr=new bH({getRemoteKeysForTarget:function(b){return a.remoteSyncer.getRemoteKeysForTarget(b)},lt:function(b){return a.$r.get(b)||null}}),eP(a).start(),a.Br.Sr()}function ez(a){return eA(a)&&!eP(a).tr()&&a.$r.size>0}function eA(a){var b;return 0===(b=a).Or.size}function eB(a){a.qr=void 0}function eC(a){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(b){return a.$r.forEach(function(b,c){ew(a,b)}),[2]})})}function eD(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(c){return eB(a),ez(a)?(a.Br.Nr(b),ey(a)):a.Br.set("Unknown"),[2]})})}function eE(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f,g;return(0,d.__generator)(this,function(h){switch(h.label){case 0:if(a.Br.set("Online"),!(b instanceof bF&&2===b.state&&b.cause))return[3,6];h.label=1;case 1:return h.trys.push([1,3,,5]),[4,function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g;return(0,d.__generator)(this,function(d){switch(d.label){case 0:c=b.cause,e=0,f=b.targetIds,d.label=1;case 1:return e<f.length?(g=f[e],a.$r.has(g)?[4,a.remoteSyncer.rejectListen(g,c)]:[3,3]):[3,5];case 2:d.sent(),a.$r.delete(g),a.qr.removeTarget(g),d.label=3;case 3:d.label=4;case 4:return e++,[3,1];case 5:return[2]}})})}(a,b)];case 2:case 4:return h.sent(),[3,5];case 3:return e=h.sent(),n("RemoteStore","Failed to remove targets %s: %s ",b.targetIds.join(","),e),[4,eF(a,e)];case 5:return[3,13];case 6:if(b instanceof bD?a.qr.X(b):b instanceof bE?a.qr.rt(b):a.qr.et(b),c.isEqual(x.min()))return[3,13];h.label=7;case 7:return h.trys.push([7,11,,13]),[4,dN(a.localStore)];case 8:var i,j,k;return f=h.sent(),c.compareTo(f)>=0?[4,(i=a,j=c,(k=i.qr.ut(j)).targetChanges.forEach(function(a,b){if(a.resumeToken.approximateByteSize()>0){var c=i.$r.get(b);c&&i.$r.set(b,c.withResumeToken(a.resumeToken,j))}}),k.targetMismatches.forEach(function(a){var b=i.$r.get(a);if(b){i.$r.set(a,b.withResumeToken(G.EMPTY_BYTE_STRING,b.snapshotVersion)),ex(i,a);var c=new cP(b.target,a,1,b.sequenceNumber);ew(i,c)}}),i.remoteSyncer.applyRemoteEvent(k))]:[3,10];case 9:h.sent(),h.label=10;case 10:return[3,13];case 11:return n("RemoteStore","Failed to raise snapshot:",g=h.sent()),[4,eF(a,g)];case 12:return h.sent(),[3,13];case 13:return[2]}})})}function eF(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e=this;return(0,d.__generator)(this,function(f){switch(f.label){case 0:if(!cG(b))throw b;return a.Or.add(1),[4,et(a)];case 1:return f.sent(),a.Br.set("Offline"),c||(c=function(){return dN(a.localStore)}),a.asyncQueue.enqueueRetryable(function(){return(0,d.__awaiter)(e,void 0,void 0,function(){return(0,d.__generator)(this,function(b){switch(b.label){case 0:return n("RemoteStore","Retrying IndexedDB access"),[4,c()];case 1:return b.sent(),a.Or.delete(1),[4,es(a)];case 2:return b.sent(),[2]}})})}),[2]}})})}function eG(a,b){return b().catch(function(c){return eF(a,c,b)})}function eH(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b,c,e,f,g;return(0,d.__generator)(this,function(d){var h,i,j,k,l,m;switch(d.label){case 0:c=eQ(b=h=a),e=b.kr.length>0?b.kr[b.kr.length-1].batchId:-1,d.label=1;case 1:if(!eA(i=b)||!(i.kr.length<10))return[3,7];d.label=2;case 2:return d.trys.push([2,4,,6]),[4,(j=b.localStore,k=e,(m=l=j).persistence.runTransaction("Get next mutation batch","readonly",function(a){return void 0===k&&(k=-1),m._n.getNextMutationBatchAfterBatchId(a,k)}))];case 3:return null===(f=d.sent())?(0===b.kr.length&&c.ir(),[3,7]):(e=f.batchId,function(a,b){a.kr.push(b);var c=eQ(a);c.er()&&c.pr&&c.Er(b.mutations)}(b,f),[3,6]);case 4:return[4,eF(b,g=d.sent())];case 5:return d.sent(),[3,6];case 6:return[3,1];case 7:return eI(b)&&eJ(b),[2]}})})}function eI(a){return eA(a)&&!eQ(a).tr()&&a.kr.length>0}function eJ(a){eQ(a).start()}function eK(a){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(b){return eQ(a).Ar(),[2]})})}function eL(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b,c,e,f;return(0,d.__generator)(this,function(d){for(b=eQ(a),c=0,e=a.kr;c<e.length;c++)f=e[c],b.Er(f.mutations);return[2]})})}function eM(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return e=a.kr.shift(),f=cO.from(e,b,c),[4,eG(a,function(){return a.remoteSyncer.applySuccessfulWrite(f)})];case 1:return d.sent(),[4,eH(a)];case 2:return d.sent(),[2]}})})}function eN(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(c){switch(c.label){case 0:return b&&eQ(a).pr?[4,function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return bo(e=b.code)&&e!==j.ABORTED?(c=a.kr.shift(),eQ(a).sr(),[4,eG(a,function(){return a.remoteSyncer.rejectFailedWrite(c.batchId,b)})]):[3,3];case 1:return d.sent(),[4,eH(a)];case 2:d.sent(),d.label=3;case 3:return[2]}})})}(a,b)]:[3,2];case 1:c.sent(),c.label=2;case 2:return eI(a)&&eJ(a),[2]}})})}function eO(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var e;return c=e=a,b?(c.Or.delete(2),[4,es(c)]):[3,2];case 1:return d.sent(),[3,5];case 2:return b?[3,4]:(c.Or.add(2),[4,et(c)]);case 3:d.sent(),c.Br.set("Unknown"),d.label=4;case 4:d.label=5;case 5:return[2]}})})}function eP(a){var b,c,e,f,g,h=this;return a.Ur||(a.Ur=(b=a.datastore,c=a.asyncQueue,e={Ii:eC.bind(null,a),Ri:eD.bind(null,a),_r:eE.bind(null,a)},g=f=b,g.br(),new en(c,g.Hi,g.credentials,g.R,e)),a.Mr.push(function(b){return(0,d.__awaiter)(h,void 0,void 0,function(){return(0,d.__generator)(this,function(c){switch(c.label){case 0:return b?(a.Ur.sr(),ez(a)?ey(a):a.Br.set("Unknown"),[3,3]):[3,1];case 1:return[4,a.Ur.stop()];case 2:c.sent(),eB(a),c.label=3;case 3:return[2]}})})})),a.Ur}function eQ(a){var b,c,e,f,g,h=this;return a.Kr||(a.Kr=(b=a.datastore,c=a.asyncQueue,e={Ii:eK.bind(null,a),Ri:eN.bind(null,a),Ir:eL.bind(null,a),Tr:eM.bind(null,a)},g=f=b,g.br(),new eo(c,g.Hi,g.credentials,g.R,e)),a.Mr.push(function(b){return(0,d.__awaiter)(h,void 0,void 0,function(){return(0,d.__generator)(this,function(c){switch(c.label){case 0:return b?(a.Kr.sr(),[4,eH(a)]):[3,2];case 1:return c.sent(),[3,4];case 2:return[4,a.Kr.stop()];case 3:c.sent(),a.kr.length>0&&(n("RemoteStore","Stopping write stream with "+a.kr.length+" pending writes"),a.kr=[]),c.label=4;case 4:return[2]}})})})),a.Kr}var eR=function(){function a(a,b,c,d,e){this.asyncQueue=a,this.timerId=b,this.targetTimeMs=c,this.op=d,this.removalCallback=e,this.deferred=new cA,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(function(a){})}return a.createAndSchedule=function(b,c,d,e,f){var g=new a(b,c,Date.now()+d,e,f);return g.start(d),g},a.prototype.start=function(a){var b=this;this.timerHandle=setTimeout(function(){return b.handleDelayElapsed()},a)},a.prototype.skipDelay=function(){return this.handleDelayElapsed()},a.prototype.cancel=function(a){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new k(j.CANCELLED,"Operation cancelled"+(a?": "+a:""))))},a.prototype.handleDelayElapsed=function(){var a=this;this.asyncQueue.enqueueAndForget(function(){return null!==a.timerHandle?(a.clearTimeout(),a.op().then(function(b){return a.deferred.resolve(b)})):Promise.resolve()})},a.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},a}();function eS(a,b){if(o("AsyncQueue",b+": "+a),cG(a))return new k(j.UNAVAILABLE,b+": "+a);throw a}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * DocumentSet is an immutable (copy-on-write) collection that holds documents
 * in order specified by the provided comparator. We always add a document key
 * comparator on top of what is provided to guarantee document equality based on
 * the key.
 */ var eT=function(){function a(a){this.comparator=a?function(b,c){return a(b,c)||Q.comparator(b.key,c.key)}:function(a,b){return Q.comparator(a.key,b.key)},this.keyedMap=bw,this.sortedSet=new bq(this.comparator)}return a.emptySet=function(b){return new a(b.comparator)},a.prototype.has=function(a){return null!=this.keyedMap.get(a)},a.prototype.get=function(a){return this.keyedMap.get(a)},a.prototype.first=function(){return this.sortedSet.minKey()},a.prototype.last=function(){return this.sortedSet.maxKey()},a.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},a.prototype.indexOf=function(a){var b=this.keyedMap.get(a);return b?this.sortedSet.indexOf(b):-1},Object.defineProperty(a.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!1,configurable:!0}),a.prototype.forEach=function(a){this.sortedSet.inorderTraversal(function(b,c){return a(b),!1})},a.prototype.add=function(a){var b=this.delete(a.key);return b.copy(b.keyedMap.insert(a.key,a),b.sortedSet.insert(a,null))},a.prototype.delete=function(a){var b=this.get(a);return b?this.copy(this.keyedMap.remove(a),this.sortedSet.remove(b)):this},a.prototype.isEqual=function(b){if(!(b instanceof a)||this.size!==b.size)return!1;for(var c=this.sortedSet.getIterator(),d=b.sortedSet.getIterator();c.hasNext();){var e=c.getNext().key,f=d.getNext().key;if(!e.isEqual(f))return!1}return!0},a.prototype.toString=function(){var a=[];return this.forEach(function(b){a.push(b.toString())}),0===a.length?"DocumentSet ()":"DocumentSet (\n  "+a.join("  \n")+"\n)"},a.prototype.copy=function(b,c){var d=new a;return d.comparator=this.comparator,d.keyedMap=b,d.sortedSet=c,d},a}(),eU=function(){function a(){this.Qr=new bq(Q.comparator)}return a.prototype.track=function(a){var b=a.doc.key,c=this.Qr.get(b);c?0!==a.type&&3===c.type?this.Qr=this.Qr.insert(b,a):3===a.type&&1!==c.type?this.Qr=this.Qr.insert(b,{type:c.type,doc:a.doc}):2===a.type&&2===c.type?this.Qr=this.Qr.insert(b,{type:2,doc:a.doc}):2===a.type&&0===c.type?this.Qr=this.Qr.insert(b,{type:0,doc:a.doc}):1===a.type&&0===c.type?this.Qr=this.Qr.remove(b):1===a.type&&2===c.type?this.Qr=this.Qr.insert(b,{type:1,doc:c.doc}):0===a.type&&1===c.type?this.Qr=this.Qr.insert(b,{type:2,doc:a.doc}):r():this.Qr=this.Qr.insert(b,a)},a.prototype.jr=function(){var a=[];return this.Qr.inorderTraversal(function(b,c){a.push(c)}),a},a}(),eV=function(){function a(a,b,c,d,e,f,g,h){this.query=a,this.docs=b,this.oldDocs=c,this.docChanges=d,this.mutatedKeys=e,this.fromCache=f,this.syncStateChanged=g,this.excludesMetadataChanges=h}return a.fromInitialDocuments=function(b,c,d,e){var f=[];return c.forEach(function(a){f.push({type:0,doc:a})}),new a(b,c,eT.emptySet(c),f,d,e,!0,!1)},Object.defineProperty(a.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!1,configurable:!0}),a.prototype.isEqual=function(a){if(!(this.fromCache===a.fromCache&&this.syncStateChanged===a.syncStateChanged&&this.mutatedKeys.isEqual(a.mutatedKeys)&&aL(this.query,a.query)&&this.docs.isEqual(a.docs)&&this.oldDocs.isEqual(a.oldDocs)))return!1;var b=this.docChanges,c=a.docChanges;if(b.length!==c.length)return!1;for(var d=0;d<b.length;d++)if(b[d].type!==c[d].type||!b[d].doc.isEqual(c[d].doc))return!1;return!0},a}(),eW=function(){this.Wr=void 0,this.listeners=[]},eX=function(){this.queries=new ds(function(a){return aM(a)},aL),this.onlineState="Unknown",this.Gr=new Set};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * DocumentChangeSet keeps track of a set of changes to docs in a query, merging
 * duplicate events for the same doc.
 */ function eY(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g,h,i,j;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var k;if(c=k=a,e=b.query,f=!1,(g=c.queries.get(e))||(f=!0,g=new eW),!f)return[3,4];d.label=1;case 1:return d.trys.push([1,3,,4]),h=g,[4,c.onListen(e)];case 2:return h.Wr=d.sent(),[3,4];case 3:return j=eS(i=d.sent(),"Initialization of query '"+aN(b.query)+"' failed"),[2,void b.onError(j)];case 4:return c.queries.set(e,g),g.listeners.push(b),b.zr(c.onlineState),g.Wr&&b.Hr(g.Wr)&&e0(c),[2]}})})}function eZ(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g,h;return(0,d.__generator)(this,function(d){var i;return c=i=a,e=b.query,f=!1,(g=c.queries.get(e))&&(h=g.listeners.indexOf(b))>=0&&(g.listeners.splice(h,1),f=0===g.listeners.length),f?[2,(c.queries.delete(e),c.onUnlisten(e))]:[2]})})}function e$(a,b){for(var c,d=c=a,e=!1,f=0,g=b;f<g.length;f++){var h=g[f],i=h.query,j=d.queries.get(i);if(j){for(var k=0,l=j.listeners;k<l.length;k++)l[k].Hr(h)&&(e=!0);j.Wr=h}}e&&e0(d)}function e_(a,b,c){var d,e=d=a,f=e.queries.get(b);if(f)for(var g=0,h=f.listeners;g<h.length;g++)h[g].onError(c);e.queries.delete(b)}function e0(a){a.Gr.forEach(function(a){a.next()})}var e1=function(){function a(a,b,c){this.query=a,this.Jr=b,this.Yr=!1,this.Xr=null,this.onlineState="Unknown",this.options=c||{}}return a.prototype.Hr=function(a){if(!this.options.includeMetadataChanges){for(var b=[],c=0,d=a.docChanges;c<d.length;c++){var e=d[c];3!==e.type&&b.push(e)}a=new eV(a.query,a.docs,a.oldDocs,b,a.mutatedKeys,a.fromCache,a.syncStateChanged,!0)}var f=!1;return this.Yr?this.Zr(a)&&(this.Jr.next(a),f=!0):this.eo(a,this.onlineState)&&(this.no(a),f=!0),this.Xr=a,f},a.prototype.onError=function(a){this.Jr.error(a)},a.prototype.zr=function(a){this.onlineState=a;var b=!1;return this.Xr&&!this.Yr&&this.eo(this.Xr,a)&&(this.no(this.Xr),b=!0),b},a.prototype.eo=function(a,b){if(!a.fromCache)return!0;var c="Offline"!==b;return!(this.options.so&&c||a.docs.isEmpty()&&"Offline"!==b)},a.prototype.Zr=function(a){if(a.docChanges.length>0)return!0;var b=this.Xr&&this.Xr.hasPendingWrites!==a.hasPendingWrites;return!(!a.syncStateChanged&&!b)&& !0===this.options.includeMetadataChanges},a.prototype.no=function(a){a=eV.fromInitialDocuments(a.query,a.docs,a.mutatedKeys,a.fromCache),this.Yr=!0,this.Jr.next(a)},a}(),e2=function(){function a(a,b){this.payload=a,this.byteLength=b}return a.prototype.io=function(){return"metadata"in this.payload},a}(),e3=function(){function a(a){this.R=a}return a.prototype.qn=function(a){return bT(this.R,a)},a.prototype.Un=function(a){return a.metadata.exists?bZ(this.R,a.document,!1):af.newNoDocument(this.qn(a.metadata.name),this.Kn(a.metadata.readTime))},a.prototype.Kn=function(a){return bP(a)},a}(),e4=function(){function a(a,b,c){this.ro=a,this.localStore=b,this.R=c,this.queries=[],this.documents=[],this.progress=e5(a)}return a.prototype.oo=function(a){this.progress.bytesLoaded+=a.byteLength;var b=this.progress.documentsLoaded;return a.payload.namedQuery?this.queries.push(a.payload.namedQuery):a.payload.documentMetadata?(this.documents.push({metadata:a.payload.documentMetadata}),a.payload.documentMetadata.exists|| ++b):a.payload.document&&(this.documents[this.documents.length-1].document=a.payload.document,++b),b!==this.progress.documentsLoaded?(this.progress.documentsLoaded=b,Object.assign({},this.progress)):null},a.prototype.co=function(a){for(var b=new Map,c=new e3(this.R),d=0,e=a;d<e.length;d++){var f=e[d];if(f.metadata.queries)for(var g=c.qn(f.metadata.name),h=0,i=f.metadata.queries;h<i.length;h++){var j=i[h],k=(b.get(j)||bz()).add(g);b.set(j,k)}}return b},a.prototype.complete=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a,b,c,e,f;return(0,d.__generator)(this,function(g){switch(g.label){case 0:return[4,function(a,b,c,e){return(0,d.__awaiter)(this,void 0,void 0,function(){var f,g,h,i,j,k,l,m,n,o;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var p,q;for(f=p=a,g=bz(),h=bv,i=bx,j=0,k=c;j<k.length;j++)l=k[j],m=b.qn(l.metadata.name),l.document&&(g=g.add(m)),h=h.insert(m,b.Un(l)),i=i.insert(m,b.Kn(l.metadata.readTime));return n=f.On.newChangeBuffer({trackRemovals:!0}),[4,dP(f,(q=e,aJ(aC(C.fromString("__bundle__/docs/"+q)))))];case 1:return o=d.sent(),[2,f.persistence.runTransaction("Apply bundle documents","readwrite",function(a){return dO(a,n,h,x.min(),i).next(function(b){return n.apply(a),b}).next(function(b){return f.qe.removeMatchingKeysForTargetId(a,o.targetId).next(function(){return f.qe.addMatchingKeys(a,g,o.targetId)}).next(function(){return f.Mn.En(a,b)}).next(function(){return b})})})]}})})}(this.localStore,new e3(this.R),this.documents,this.ro.id)];case 1:a=g.sent(),b=this.co(this.documents),c=0,e=this.queries,g.label=2;case 2:return c<e.length?(f=e[c],[4,function(a,b,c){return void 0===c&&(c=bz()),(0,d.__awaiter)(this,void 0,void 0,function(){var e,f;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return[4,dP(a,aJ(c$(b.bundledQuery)))];case 1:var g;return e=d.sent(),[2,(f=g=a).persistence.runTransaction("Save named query","readwrite",function(a){var d=bP(b.readTime);if(e.snapshotVersion.compareTo(d)>=0)return f.Ke.saveNamedQuery(a,b);var g=e.withResumeToken(G.EMPTY_BYTE_STRING,d);return f.Fn=f.Fn.insert(g.targetId,g),f.qe.updateTargetData(a,g).next(function(){return f.qe.removeMatchingKeysForTargetId(a,e.targetId)}).next(function(){return f.qe.addMatchingKeys(a,c,e.targetId)}).next(function(){return f.Ke.saveNamedQuery(a,b)})})]}})})}(this.localStore,f,b.get(f.name))]):[3,5];case 3:g.sent(),g.label=4;case 4:return c++,[3,2];case 5:return[2,(this.progress.taskState="Success",new dG(Object.assign({},this.progress),a))]}})})},a}();/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A complete element in the bundle stream, together with the byte length it
 * occupies in the stream.
 */ /**
 * Returns a `LoadBundleTaskProgress` representing the initial progress of
 * loading a bundle.
 */ function e5(a){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:a.totalDocuments,totalBytes:a.totalBytes}}/**
 * Returns a `LoadBundleTaskProgress` representing the progress that the loading
 * has succeeded.
 */ /**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ var e6=function(a){this.key=a},e7=function(a){this.key=a},e8=function(){function a(a,b){this.query=a,this.uo=b,this.ao=null,this.current=!1,this.ho=bz(),this.mutatedKeys=bz(),this.lo=aP(a),this.fo=new eT(this.lo)}return Object.defineProperty(a.prototype,"wo",{get:function(){return this.uo},enumerable:!1,configurable:!0}),a.prototype._o=function(a,b){var c=this,d=b?b.mo:new eU,e=b?b.fo:this.fo,f=b?b.mutatedKeys:this.mutatedKeys,g=e,h=!1,i=aD(this.query)&&e.size===this.query.limit?e.last():null,j=aE(this.query)&&e.size===this.query.limit?e.first():null;if(a.inorderTraversal(function(a,b){var k=e.get(a),l=aO(c.query,b)?b:null,m=!!k&&c.mutatedKeys.has(k.key),n=!!l&&(l.hasLocalMutations||c.mutatedKeys.has(l.key)&&l.hasCommittedMutations),o=!1;k&&l?k.data.isEqual(l.data)?m!==n&&(d.track({type:3,doc:l}),o=!0):c.yo(k,l)||(d.track({type:2,doc:l}),o=!0,(i&&c.lo(l,i)>0||j&&0>c.lo(l,j))&&(h=!0)):!k&&l?(d.track({type:0,doc:l}),o=!0):k&&!l&&(d.track({type:1,doc:k}),o=!0,(i||j)&&(h=!0)),o&&(l?(g=g.add(l),f=n?f.add(a):f.delete(a)):(g=g.delete(a),f=f.delete(a)))}),aD(this.query)||aE(this.query))for(;g.size>this.query.limit;){var k=aD(this.query)?g.last():g.first();g=g.delete(k.key),f=f.delete(k.key),d.track({type:1,doc:k})}return{fo:g,mo:d,Nn:h,mutatedKeys:f}},a.prototype.yo=function(a,b){return a.hasLocalMutations&&b.hasCommittedMutations&&!b.hasLocalMutations},a.prototype.applyChanges=function(a,b,c){var d=this,e=this.fo;this.fo=a.fo,this.mutatedKeys=a.mutatedKeys;var f=a.mo.jr();f.sort(function(a,b){var c,e,f;return c=a.type,e=b.type,(f=function(a){switch(a){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return r()}})(c)-f(e)||d.lo(a.doc,b.doc)}),this.po(c);var g=b?this.Eo():[],h=0===this.ho.size&&this.current?1:0,i=h!==this.ao;return this.ao=h,0!==f.length||i?{snapshot:new eV(this.query,a.fo,e,f,a.mutatedKeys,0===h,i,!1),To:g}:{To:g}},a.prototype.zr=function(a){return this.current&&"Offline"===a?(this.current=!1,this.applyChanges({fo:this.fo,mo:new eU,mutatedKeys:this.mutatedKeys,Nn:!1},!1)):{To:[]}},a.prototype.Io=function(a){return!this.uo.has(a)&&!!this.fo.has(a)&&!this.fo.get(a).hasLocalMutations},a.prototype.po=function(a){var b=this;a&&(a.addedDocuments.forEach(function(a){return b.uo=b.uo.add(a)}),a.modifiedDocuments.forEach(function(a){}),a.removedDocuments.forEach(function(a){return b.uo=b.uo.delete(a)}),this.current=a.current)},a.prototype.Eo=function(){var a=this;if(!this.current)return[];var b=this.ho;this.ho=bz(),this.fo.forEach(function(b){a.Io(b.key)&&(a.ho=a.ho.add(b.key))});var c=[];return b.forEach(function(b){a.ho.has(b)||c.push(new e7(b))}),this.ho.forEach(function(a){b.has(a)||c.push(new e6(a))}),c},a.prototype.Ao=function(a){this.uo=a.Bn,this.ho=bz();var b=this._o(a.documents);return this.applyChanges(b,!0)},a.prototype.Ro=function(){return eV.fromInitialDocuments(this.query,this.fo,this.mutatedKeys,0===this.ao)},a}(),e9=function(a,b,c){this.query=a,this.targetId=b,this.view=c},fa=function(a){this.key=a,this.bo=!1},fb=function(){function a(a,b,c,d,e,f){this.localStore=a,this.remoteStore=b,this.eventManager=c,this.sharedClientState=d,this.currentUser=e,this.maxConcurrentLimboResolutions=f,this.vo={},this.Po=new ds(function(a){return aM(a)},aL),this.Vo=new Map,this.So=new Set,this.Do=new bq(Q.comparator),this.Co=new Map,this.No=new dV,this.xo={},this.Fo=new Map,this.ko=df.Yt(),this.onlineState="Unknown",this.$o=void 0}return Object.defineProperty(a.prototype,"isPrimaryClient",{get:function(){return!0===this.$o},enumerable:!1,configurable:!0}),a}();function fc(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g,h,i;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return(g=(c=fD(a)).Po.get(b))?(e=g.targetId,c.sharedClientState.addLocalQueryTarget(e),f=g.view.Ro(),[3,4]):[3,1];case 1:return[4,dP(c.localStore,aJ(b))];case 2:return h=d.sent(),i=c.sharedClientState.addLocalQueryTarget(h.targetId),e=h.targetId,[4,fd(c,b,e,"current"===i)];case 3:f=d.sent(),c.isPrimaryClient&&eu(c.remoteStore,h),d.label=4;case 4:return[2,f]}})})}function fd(a,b,c,e){return(0,d.__awaiter)(this,void 0,void 0,function(){var f,g,h,i,j,k;return(0,d.__generator)(this,function(l){switch(l.label){case 0:return a.Oo=function(b,c,e){return function(a,b,c,e){return(0,d.__awaiter)(this,void 0,void 0,function(){var f,g,h;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return(f=b.view._o(c)).Nn?[4,dR(a.localStore,b.query,!1).then(function(a){var c=a.documents;return b.view._o(c,f)})]:[3,2];case 1:f=d.sent(),d.label=2;case 2:return g=e&&e.targetChanges.get(b.targetId),h=b.view.applyChanges(f,a.isPrimaryClient,g),[2,(fq(a,b.targetId,h.To),h.snapshot)]}})})}(a,b,c,e)},[4,dR(a.localStore,b,!0)];case 1:return f=l.sent(),h=(g=new e8(b,f.Bn))._o(f.documents),i=bC.createSynthesizedTargetChangeForCurrentChange(c,e&&"Offline"!==a.onlineState),j=g.applyChanges(h,a.isPrimaryClient,i),fq(a,c,j.To),k=new e9(b,c,g),[2,(a.Po.set(b,k),a.Vo.has(c)?a.Vo.get(c).push(b):a.Vo.set(c,[b]),j.snapshot)]}})})}function fe(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var g;return e=(c=g=a).Po.get(b),(f=c.Vo.get(e.targetId)).length>1?[2,(c.Vo.set(e.targetId,f.filter(function(a){return!aL(a,b)})),void c.Po.delete(b))]:c.isPrimaryClient?(c.sharedClientState.removeLocalQueryTarget(e.targetId),c.sharedClientState.isActiveQueryTarget(e.targetId)?[3,2]:[4,dQ(c.localStore,e.targetId,!1).then(function(){c.sharedClientState.clearQueryState(e.targetId),ev(c.remoteStore,e.targetId),fo(c,e.targetId)}).catch(dk)]):[3,3];case 1:d.sent(),d.label=2;case 2:return[3,5];case 3:return fo(c,e.targetId),[4,dQ(c.localStore,e.targetId,!0)];case 4:d.sent(),d.label=5;case 5:return[2]}})})}function ff(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f,g,h;return(0,d.__generator)(this,function(d){var i,j,k,l,m,n,o,p,q,r,s;switch(d.label){case 0:e=fE(a),d.label=1;case 1:return d.trys.push([1,5,,6]),[4,(i=e.localStore,j=b,m=k=i,n=w.now(),o=j.reduce(function(a,b){return a.add(b.key)},bz()),m.persistence.runTransaction("Locally write mutations","readwrite",function(a){return m.Mn.pn(a,o).next(function(b){l=b;for(var c=[],d=0,e=j;d<e.length;d++){var f=e[d],g=bb(f,l.get(f.key));null!=g&&c.push(new bf(f.key,g,ae(g.value.mapValue),a6.exists(!0)))}return m._n.addMutationBatch(a,n,c,j)})}).then(function(a){return a.applyToLocalDocumentSet(l),{batchId:a.batchId,changes:l}}))];case 2:return f=d.sent(),e.sharedClientState.addPendingMutation(f.batchId),p=e,q=f.batchId,r=c,(s=p.xo[p.currentUser.toKey()])||(s=new bq(u)),s=s.insert(q,r),p.xo[p.currentUser.toKey()]=s,[4,ft(e,f.changes)];case 3:return d.sent(),[4,eH(e.remoteStore)];case 4:return d.sent(),[3,6];case 5:return h=eS(g=d.sent(),"Failed to persist write"),c.reject(h),[3,6];case 6:return[2]}})})}function fg(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e;return(0,d.__generator)(this,function(d){var f,g,h,i,j,k,l;switch(d.label){case 0:c=f=a,d.label=1;case 1:return d.trys.push([1,4,,6]),[4,(g=c.localStore,h=b,j=i=g,k=h.snapshotVersion,l=j.Fn,j.persistence.runTransaction("Apply remote event","readwrite-primary",function(a){var b=j.On.newChangeBuffer({trackRemovals:!0});l=j.Fn;var c=[];h.targetChanges.forEach(function(b,d){var e=l.get(d);if(e){c.push(j.qe.removeMatchingKeys(a,b.removedDocuments,d).next(function(){return j.qe.addMatchingKeys(a,b.addedDocuments,d)}));var f=b.resumeToken;if(f.approximateByteSize()>0){var g,h,i,m,n=e.withResumeToken(f,k).withSequenceNumber(a.currentSequenceNumber);l=l.insert(d,n),g=e,h=n,i=b,h.resumeToken.approximateByteSize()>0||r(),(0===g.resumeToken.approximateByteSize()||h.snapshotVersion.toMicroseconds()-g.snapshotVersion.toMicroseconds()>=3e8||i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size>0)&&c.push(j.qe.updateTargetData(a,n))}}});var d=bv;if(h.documentUpdates.forEach(function(b,d){h.resolvedLimboDocuments.has(b)&&c.push(j.persistence.referenceDelegate.updateLimboDocument(a,b))}),c.push(dO(a,b,h.documentUpdates,k,void 0).next(function(a){d=a})),!k.isEqual(x.min())){var e=j.qe.getLastRemoteSnapshotVersion(a).next(function(b){return j.qe.setTargetsMetadata(a,a.currentSequenceNumber,k)});c.push(e)}return cB.waitFor(c).next(function(){return b.apply(a)}).next(function(){return j.Mn.En(a,d)}).next(function(){return d})}).then(function(a){return j.Fn=l,a}))];case 2:return e=d.sent(),b.targetChanges.forEach(function(a,b){var d,e,f,g=c.Co.get(b);g&&(a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size<=1||r(),a.addedDocuments.size>0?g.bo=!0:a.modifiedDocuments.size>0?(e=g.bo)||r():a.removedDocuments.size>0&&(g.bo||r(),g.bo=!1))}),[4,ft(c,e,b)];case 3:case 5:return d.sent(),[3,6];case 4:return[4,dk(d.sent())];case 6:return[2]}})})}function fh(a,b,c){var d,e=d=a;if(e.isPrimaryClient&&0===c|| !e.isPrimaryClient&&1===c){var f,g,h,i,j,k=[];e.Po.forEach(function(a,c){var d=c.view.zr(b);d.snapshot&&k.push(d.snapshot)}),f=e.eventManager,g=b,(i=h=f).onlineState=g,j=!1,i.queries.forEach(function(a,b){for(var c=0,d=b.listeners;c<d.length;c++)d[c].zr(g)&&(j=!0)}),j&&e0(i),k.length&&e.vo._r(k),e.onlineState=b,e.isPrimaryClient&&e.sharedClientState.setOnlineState(b)}}function fi(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f,g,h,i,j;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var k;return(e=k=a).sharedClientState.updateQueryState(b,"rejected",c),(g=(f=e.Co.get(b))&&f.key)?(h=(h=new bq(Q.comparator)).insert(g,af.newNoDocument(g,x.min())),i=bz().add(g),j=new bB(x.min(),new Map,new bt(u),h,i),[4,fg(e,j)]):[3,2];case 1:return d.sent(),e.Do=e.Do.remove(g),e.Co.delete(b),fs(e),[3,4];case 2:return[4,dQ(e.localStore,b,!1).then(function(){return fo(e,b,c)}).catch(dk)];case 3:d.sent(),d.label=4;case 4:return[2]}})})}function fj(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f;return(0,d.__generator)(this,function(d){var g,h,i,j,k;switch(d.label){case 0:c=g=a,e=b.batch.batchId,d.label=1;case 1:return d.trys.push([1,4,,6]),[4,(h=c.localStore,i=b,(k=j=h).persistence.runTransaction("Acknowledge batch","readwrite-primary",function(a){var b,c,d,e,f,g,h,j=i.batch.keys(),l=k.On.newChangeBuffer({trackRemovals:!0});return(b=k,c=a,d=i,e=l,g=(f=d.batch).keys(),h=cB.resolve(),g.forEach(function(a){h=h.next(function(){return e.getEntry(c,a)}).next(function(b){var c,g=d.docVersions.get(a);null!==g||r(),0>b.version.compareTo(g)&&(f.applyToRemoteDocument(b,d),b.isValidDocument()&&e.addEntry(b,d.commitVersion))})}),h.next(function(){return b._n.removeMutationBatch(c,f)})).next(function(){return l.apply(a)}).next(function(){return k._n.performConsistencyCheck(a)}).next(function(){return k.Mn.pn(a,j)})}))];case 2:return f=d.sent(),fn(c,e,null),fm(c,e),c.sharedClientState.updateMutationState(e,"acknowledged"),[4,ft(c,f)];case 3:case 5:return d.sent(),[3,6];case 4:return[4,dk(d.sent())];case 6:return[2]}})})}function fk(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f;return(0,d.__generator)(this,function(d){var g,h,i,j,k;switch(d.label){case 0:e=g=a,d.label=1;case 1:return d.trys.push([1,4,,6]),[4,(h=e.localStore,i=b,(k=j=h).persistence.runTransaction("Reject batch","readwrite-primary",function(a){var b;return k._n.lookupMutationBatch(a,i).next(function(c){var d;return null!==c||r(),b=c.keys(),k._n.removeMutationBatch(a,c)}).next(function(){return k._n.performConsistencyCheck(a)}).next(function(){return k.Mn.pn(a,b)})}))];case 2:return f=d.sent(),fn(e,b,c),fm(e,b),e.sharedClientState.updateMutationState(b,"rejected",c),[4,ft(e,f)];case 3:case 5:return d.sent(),[3,6];case 4:return[4,dk(d.sent())];case 6:return[2]}})})}function fl(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g,h;return(0,d.__generator)(this,function(d){var i,j,k,l;switch(d.label){case 0:eA((c=i=a).remoteStore)||n("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),d.label=1;case 1:return d.trys.push([1,3,,4]),[4,(l=k=j=c.localStore).persistence.runTransaction("Get highest unacknowledged batch id","readonly",function(a){return l._n.getHighestUnacknowledgedBatchId(a)})];case 2:return -1===(e=d.sent())?[2,void b.resolve()]:((f=c.Fo.get(e)||[]).push(b),c.Fo.set(e,f),[3,4]);case 3:return h=eS(g=d.sent(),"Initialization of waitForPendingWrites() operation failed"),b.reject(h),[3,4];case 4:return[2]}})})}function fm(a,b){(a.Fo.get(b)||[]).forEach(function(a){a.resolve()}),a.Fo.delete(b)}function fn(a,b,c){var d,e=d=a,f=e.xo[e.currentUser.toKey()];if(f){var g=f.get(b);g&&(c?g.reject(c):g.resolve(),f=f.remove(b)),e.xo[e.currentUser.toKey()]=f}}function fo(a,b,c){void 0===c&&(c=null),a.sharedClientState.removeLocalQueryTarget(b);for(var d=0,e=a.Vo.get(b);d<e.length;d++){var f=e[d];a.Po.delete(f),c&&a.vo.Mo(f,c)}a.Vo.delete(b),a.isPrimaryClient&&a.No.Zn(b).forEach(function(b){a.No.containsKey(b)||fp(a,b)})}function fp(a,b){a.So.delete(b.path.canonicalString());var c=a.Do.get(b);null!==c&&(ev(a.remoteStore,c),a.Do=a.Do.remove(b),a.Co.delete(c),fs(a))}function fq(a,b,c){for(var d=0,e=c;d<e.length;d++){var f=e[d];f instanceof e6?(a.No.addReference(f.key,b),fr(a,f)):f instanceof e7?(n("SyncEngine","Document no longer in limbo: "+f.key),a.No.removeReference(f.key,b),a.No.containsKey(f.key)||fp(a,f.key)):r()}}function fr(a,b){var c=b.key,d=c.path.canonicalString();a.Do.get(c)||a.So.has(d)||(n("SyncEngine","New document in limbo: "+c),a.So.add(d),fs(a))}function fs(a){for(;a.So.size>0&&a.Do.size<a.maxConcurrentLimboResolutions;){var b=a.So.values().next().value;a.So.delete(b);var c=new Q(C.fromString(b)),d=a.ko.next();a.Co.set(d,new fa(c)),a.Do=a.Do.insert(c,d),eu(a.remoteStore,new cP(aJ(aC(c.path)),d,2,i.o))}}function ft(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f,g,h;return(0,d.__generator)(this,function(i){switch(i.label){case 0:var j;return e=j=a,f=[],g=[],h=[],e.Po.isEmpty()?[3,3]:(e.Po.forEach(function(a,d){h.push(e.Oo(d,b,c).then(function(a){if(a){e.isPrimaryClient&&e.sharedClientState.updateQueryState(d.targetId,a.fromCache?"not-current":"current"),f.push(a);var b=dI.Pn(d.targetId,a);g.push(b)}}))}),[4,Promise.all(h)]);case 1:return i.sent(),e.vo._r(f),[4,function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g,h,i,j,k,l;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var m;c=m=a,d.label=1;case 1:return d.trys.push([1,3,,4]),[4,c.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(a){return cB.forEach(b,function(b){return cB.forEach(b.bn,function(d){return c.persistence.referenceDelegate.addReference(a,b.targetId,d)}).next(function(){return cB.forEach(b.vn,function(d){return c.persistence.referenceDelegate.removeReference(a,b.targetId,d)})})})})];case 2:return d.sent(),[3,4];case 3:if(!cG(e=d.sent()))throw e;return n("LocalStore","Failed to update sequence numbers: "+e),[3,4];case 4:for(f=0,g=b;f<g.length;f++)i=(h=g[f]).targetId,h.fromCache||(k=(j=c.Fn.get(i)).snapshotVersion,l=j.withLastLimboFreeSnapshotVersion(k),c.Fn=c.Fn.insert(i,l));return[2]}})})}(e.localStore,g)];case 2:i.sent(),i.label=3;case 3:return[2]}})})}function fu(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e;return(0,d.__generator)(this,function(d){var f,g;switch(d.label){case 0:return(c=f=a).currentUser.isEqual(b)?[3,3]:(n("SyncEngine","User change. New user:",b.toKey()),[4,dM(c.localStore,b)]);case 1:return e=d.sent(),c.currentUser=b,(g=c).Fo.forEach(function(a){a.forEach(function(a){a.reject(new k(j.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),g.Fo.clear(),c.sharedClientState.handleUserChange(b,e.removedBatchIds,e.addedBatchIds),[4,ft(c,e.Ln)];case 2:d.sent(),d.label=3;case 3:return[2]}})})}function fv(a,b){var c,d=c=a,e=d.Co.get(b);if(e&&e.bo)return bz().add(e.key);var f=bz(),g=d.Vo.get(b);if(!g)return f;for(var h=0,i=g;h<i.length;h++){var j=i[h],k=d.Po.get(j);f=f.unionWith(k.view.wo)}return f}function fw(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){var d;return[2,dT((b=d=a).localStore).then(function(a){return ft(b,a)})]})})}function fx(a,b,c,e){return(0,d.__awaiter)(this,void 0,void 0,function(){var f,g;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var h,i,j,k,l,m,o;return[4,(i=(f=h=a).localStore,j=b,o=l=(m=k=i)._n,m.persistence.runTransaction("Lookup mutation documents","readonly",function(a){return o.jt(a,j).next(function(b){return b?m.Mn.pn(a,b):cB.resolve(null)})}))];case 1:return null===(g=d.sent())?[3,6]:"pending"!==c?[3,3]:[4,eH(f.remoteStore)];case 2:return d.sent(),[3,4];case 3:"acknowledged"===c||"rejected"===c?(fn(f,b,e||null),fm(f,b),function(a,b){var c,d;(d=(c=a)._n).Gt(b)}(f.localStore,b)):r(),d.label=4;case 4:return[4,ft(f,g)];case 5:return d.sent(),[3,7];case 6:n("SyncEngine","Cannot apply mutation batch with id: "+b),d.label=7;case 7:return[2]}})})}function fy(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g,h,i,j,k,l,m,n,o,p,q;return(0,d.__generator)(this,function(r){switch(r.label){case 0:var s;c=s=a,e=[],f=[],g=0,h=b,r.label=1;case 1:return g<h.length?(i=h[g],j=void 0,(k=c.Vo.get(i))&&0!==k.length?[4,dP(c.localStore,aJ(k[0]))]:[3,7]):[3,13];case 2:j=r.sent(),l=0,m=k,r.label=3;case 3:return l<m.length?(n=m[l],o=c.Po.get(n),[4,function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var g;return[4,dR((c=g=a).localStore,b.query,!0)];case 1:return e=d.sent(),f=b.view.Ao(e),[2,(c.isPrimaryClient&&fq(c,b.targetId,f.To),f)]}})})}(c,o)]):[3,6];case 4:(p=r.sent()).snapshot&&f.push(p.snapshot),r.label=5;case 5:return l++,[3,3];case 6:return[3,11];case 7:return[4,dS(c.localStore,i)];case 8:return q=r.sent(),[4,dP(c.localStore,q)];case 9:return j=r.sent(),[4,fd(c,fz(q),i,!1)];case 10:r.sent(),r.label=11;case 11:e.push(j),r.label=12;case 12:return g++,[3,1];case 13:return[2,(c.vo._r(f),e)]}})})}function fz(a){return aB(a.path,a.collectionGroup,a.orderBy,a.filters,a.limit,"F",a.startAt,a.endAt)}function fA(a){var b,c,d;return(d=(c=(b=a).localStore).persistence).fn()}function fB(a,b,c,e){return(0,d.__awaiter)(this,void 0,void 0,function(){var f,g,h;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var i;return(f=i=a).$o?(n("SyncEngine","Ignoring unexpected query state notification."),[3,8]):[3,1];case 1:if(!f.Vo.has(b))return[3,8];switch(c){case"current":case"not-current":return[3,2];case"rejected":return[3,5]}return[3,7];case 2:return[4,dT(f.localStore)];case 3:return[4,ft(f,g=d.sent(),h=bB.createSynthesizedRemoteEventForCurrentChange(b,"current"===c))];case 4:return d.sent(),[3,8];case 5:return[4,dQ(f.localStore,b,!0)];case 6:return d.sent(),fo(f,b,e),[3,8];case 7:r(),d.label=8;case 8:return[2]}})})}function fC(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f,g,h,i,j,k,l,m,o;return(0,d.__generator)(this,function(p){switch(p.label){case 0:if(!(e=fD(a)).$o)return[3,10];f=0,g=b,p.label=1;case 1:return f<g.length?(h=g[f],e.Vo.has(h)?(n("SyncEngine","Adding an already active target "+h),[3,5]):[4,dS(e.localStore,h)]):[3,6];case 2:return i=p.sent(),[4,dP(e.localStore,i)];case 3:return j=p.sent(),[4,fd(e,fz(i),j.targetId,!1)];case 4:p.sent(),eu(e.remoteStore,j),p.label=5;case 5:return f++,[3,1];case 6:k=function(a){return(0,d.__generator)(this,function(b){switch(b.label){case 0:return e.Vo.has(a)?[4,dQ(e.localStore,a,!1).then(function(){ev(e.remoteStore,a),fo(e,a)}).catch(dk)]:[3,2];case 1:b.sent(),b.label=2;case 2:return[2]}})},l=0,m=c,p.label=7;case 7:return l<m.length?[5,k(o=m[l])]:[3,10];case 8:p.sent(),p.label=9;case 9:return l++,[3,7];case 10:return[2]}})})}function fD(a){var b,c=b=a;return c.remoteStore.remoteSyncer.applyRemoteEvent=fg.bind(null,c),c.remoteStore.remoteSyncer.getRemoteKeysForTarget=fv.bind(null,c),c.remoteStore.remoteSyncer.rejectListen=fi.bind(null,c),c.vo._r=e$.bind(null,c.eventManager),c.vo.Mo=e_.bind(null,c.eventManager),c}function fE(a){var b,c=b=a;return c.remoteStore.remoteSyncer.applySuccessfulWrite=fj.bind(null,c),c.remoteStore.remoteSyncer.rejectFailedWrite=fk.bind(null,c),c}function fF(a,b,c){var e,f=e=a;(function(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f,g,h,i,j;return(0,d.__generator)(this,function(d){var k,l,m,n,o,q,r,s,t,u;switch(d.label){case 0:return d.trys.push([0,14,,15]),[4,b.getMetadata()];case 1:return e=d.sent(),[4,(k=a.localStore,l=e,n=m=k,o=bP(l.createTime),n.persistence.runTransaction("hasNewerBundle","readonly",function(a){return n.Ke.getBundleMetadata(a,l.id)}).then(function(a){return!!a&&a.createTime.compareTo(o)>=0}))];case 2:return d.sent()?[4,b.close()]:[3,4];case 3:return[2,(d.sent(),void c._completeWith({taskState:"Success",documentsLoaded:(q=e).totalDocuments,bytesLoaded:q.totalBytes,totalDocuments:q.totalDocuments,totalBytes:q.totalBytes}))];case 4:return c._updateProgress(e5(e)),f=new e4(e,a.localStore,b.R),[4,b.Lo()];case 5:g=d.sent(),d.label=6;case 6:return g?[4,f.oo(g)]:[3,10];case 7:return(h=d.sent())&&c._updateProgress(h),[4,b.Lo()];case 8:g=d.sent(),d.label=9;case 9:return[3,6];case 10:return[4,f.complete()];case 11:return[4,ft(a,(i=d.sent()).wn,void 0)];case 12:return d.sent(),[4,(r=a.localStore,s=e,(u=t=r).persistence.runTransaction("Save bundle","readwrite",function(a){return u.Ke.saveBundleMetadata(a,s)}))];case 13:return d.sent(),c._completeWith(i.progress),[3,15];case 14:return p("SyncEngine","Loading bundle failed with "+(j=d.sent())),c._failWith(j),[3,15];case 15:return[2]}})})})(f,b,c).then(function(){f.sharedClientState.notifyBundleLoaded()})}var fG=function(){function a(){this.synchronizeTabs=!1}return a.prototype.initialize=function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(b){switch(b.label){case 0:return this.R=ek(a.databaseInfo.databaseId),this.sharedClientState=this.Bo(a),this.persistence=this.qo(a),[4,this.persistence.start()];case 1:return b.sent(),this.gcScheduler=this.Uo(a),this.localStore=this.Ko(a),[2]}})})},a.prototype.Uo=function(a){return null},a.prototype.Ko=function(a){return dL(this.persistence,new dJ,a.initialUser,this.R)},a.prototype.qo=function(a){return new d_(d1.bs,this.R)},a.prototype.Bo=function(a){return new ec},a.prototype.terminate=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(a){switch(a.label){case 0:return this.gcScheduler&&this.gcScheduler.stop(),[4,this.sharedClientState.shutdown()];case 1:return a.sent(),[4,this.persistence.shutdown()];case 2:return a.sent(),[2]}})})},a}(),fH=function(a){function b(b,c,d){var e=this;return(e=a.call(this)||this).Qo=b,e.cacheSizeBytes=c,e.forceOwnership=d,e.synchronizeTabs=!1,e}return(0,d.__extends)(b,a),b.prototype.initialize=function(b){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(c){switch(c.label){case 0:return[4,a.prototype.initialize.call(this,b)];case 1:return c.sent(),[4,function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){var d;return[2,(b=d=a).persistence.runTransaction("Synchronize last document change read time","readonly",function(a){var b,c,d;return c=dx(b=a),d=x.min(),c.$t({index:co.readTimeIndex,reverse:!0},function(a,b,c){b.readTime&&(d=cU(b.readTime)),c.done()}).next(function(){return d})}).then(function(a){b.$n=a})]})})}(this.localStore)];case 2:return c.sent(),[4,this.Qo.initialize(this,b)];case 3:return c.sent(),[4,fE(this.Qo.syncEngine)];case 4:return c.sent(),[4,eH(this.Qo.remoteStore)];case 5:return c.sent(),[2]}})})},b.prototype.Ko=function(a){return dL(this.persistence,new dJ,a.initialUser,this.R)},b.prototype.Uo=function(a){var b=this.persistence.referenceDelegate.garbageCollector;return new dn(b,a.asyncQueue)},b.prototype.qo=function(a){var b=dF(a.databaseInfo.databaseId,a.databaseInfo.persistenceKey),c=void 0!==this.cacheSizeBytes?c7.withCacheSize(this.cacheSizeBytes):c7.DEFAULT;return new dC(this.synchronizeTabs,b,a.clientId,c,a.asyncQueue,ei(),ej(),this.R,this.sharedClientState,!!this.forceOwnership)},b.prototype.Bo=function(a){return new ec},b}(fG),fI=function(a){function b(b,c){var d=this;return(d=a.call(this,b,c,!1)||this).Qo=b,d.cacheSizeBytes=c,d.synchronizeTabs=!0,d}return(0,d.__extends)(b,a),b.prototype.initialize=function(b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e=this;return(0,d.__generator)(this,function(f){switch(f.label){case 0:return[4,a.prototype.initialize.call(this,b)];case 1:return f.sent(),c=this.Qo.syncEngine,this.sharedClientState instanceof eb?(this.sharedClientState.syncEngine={ui:fx.bind(null,c),ai:fB.bind(null,c),hi:fC.bind(null,c),fn:fA.bind(null,c),ci:fw.bind(null,c)},[4,this.sharedClientState.start()]):[3,3];case 2:f.sent(),f.label=3;case 3:return[4,this.persistence.He(function(a){return(0,d.__awaiter)(e,void 0,void 0,function(){return(0,d.__generator)(this,function(b){switch(b.label){case 0:return[4,function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g,h,i,j,k;return(0,d.__generator)(this,function(d){var l,m,n,o;switch(d.label){case 0:return fD(c=l=a),fE(c),!0!==b|| !0===c.$o?[3,3]:(e=c.sharedClientState.getAllActiveQueryTargets(),[4,fy(c,e.toArray())]);case 1:return f=d.sent(),c.$o=!0,[4,eO(c.remoteStore,!0)];case 2:for(d.sent(),g=0,h=f;g<h.length;g++)i=h[g],eu(c.remoteStore,i);return[3,7];case 3:return!1!==b|| !1===c.$o?[3,7]:(j=[],k=Promise.resolve(),c.Vo.forEach(function(a,b){c.sharedClientState.isLocalQueryTarget(b)?j.push(b):k=k.then(function(){return fo(c,b),dQ(c.localStore,b,!0)}),ev(c.remoteStore,b)}),[4,k]);case 4:return d.sent(),[4,fy(c,j)];case 5:return d.sent(),(o=n=c).Co.forEach(function(a,b){ev(o.remoteStore,b)}),o.No.ts(),o.Co=new Map,o.Do=new bq(Q.comparator),c.$o=!1,[4,eO(c.remoteStore,!1)];case 6:d.sent(),d.label=7;case 7:return[2]}})})}(this.Qo.syncEngine,a)];case 1:return b.sent(),this.gcScheduler&&(a&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):a||this.gcScheduler.stop()),[2]}})})})];case 4:return f.sent(),[2]}})})},b.prototype.Bo=function(a){var b=ei();if(!eb.yt(b))throw new k(j.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var c=dF(a.databaseInfo.databaseId,a.databaseInfo.persistenceKey);return new eb(b,a.asyncQueue,c,a.clientId,a.initialUser)},b}(fH),fJ=function(){function a(){}return a.prototype.initialize=function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c=this;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return this.localStore?[3,2]:(this.localStore=a.localStore,this.sharedClientState=a.sharedClientState,this.datastore=this.createDatastore(b),this.remoteStore=this.createRemoteStore(b),this.eventManager=this.createEventManager(b),this.syncEngine=this.createSyncEngine(b,!a.synchronizeTabs),this.sharedClientState.onlineStateHandler=function(a){return fh(c.syncEngine,a,1)},this.remoteStore.remoteSyncer.handleCredentialChange=fu.bind(null,this.syncEngine),[4,eO(this.remoteStore,this.syncEngine.isPrimaryClient)]);case 1:d.sent(),d.label=2;case 2:return[2]}})})},a.prototype.createEventManager=function(a){return new eX},a.prototype.createDatastore=function(a){var b,c,d,e,f=ek(a.databaseInfo.databaseId),g=(b=a.databaseInfo,new eh(b));return c=a.credentials,d=g,e=f,new ep(c,d,e)},a.prototype.createRemoteStore=function(a){var b,c,d,e,f,g=this;return b=this.localStore,c=this.datastore,d=a.asyncQueue,e=function(a){return fh(g.syncEngine,a,0)},f=ee.yt()?new ee:new ed,new er(b,c,d,e,f)},a.prototype.createSyncEngine=function(a,b){var c,d,e,f,g,h,i,j;return c=this.localStore,d=this.remoteStore,e=this.eventManager,f=this.sharedClientState,g=a.initialUser,h=a.maxConcurrentLimboResolutions,i=b,j=new fb(c,d,e,f,g,h),i&&(j.$o=!0),j},a.prototype.terminate=function(){return function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:var d;return b=d=a,n("RemoteStore","RemoteStore shutting down."),b.Or.add(5),[4,et(b)];case 1:return c.sent(),b.Lr.shutdown(),b.Br.set("Unknown"),[2]}})})}(this.remoteStore)},a}();/**
 * Provides all components needed for Firestore with IndexedDB persistence.
 */ /**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * How many bytes to read each time when `ReadableStreamReader.read()` is
 * called. Only applicable for byte streams that we control (e.g. those backed
 * by an UInt8Array).
 */ /**
 * Builds a `ByteStreamReader` from a UInt8Array.
 * @param source - The data source to use.
 * @param bytesPerRead - How many bytes each `read()` from the returned reader
 *        will read.
 */ function fK(a,b){void 0===b&&(b=10240);var c=0;return{read:function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var e;return(0,d.__generator)(this,function(d){return c<a.byteLength?(e={value:a.slice(c,c+b),done:!1},[2,(c+=b,e)]):[2,{done:!0}]})})},cancel:function(){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(a){return[2]})})},releaseLock:function(){},closed:Promise.reject("unimplemented")}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * On web, a `ReadableStream` is wrapped around by a `ByteStreamReader`.
 */ /**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /*
 * A wrapper implementation of Observer<T> that will dispatch events
 * asynchronously. To allow immediate silencing, a mute call is added which
 * causes events scheduled to no longer be raised.
 */ var fL=function(){function a(a){this.observer=a,this.muted=!1}return a.prototype.next=function(a){this.observer.next&&this.jo(this.observer.next,a)},a.prototype.error=function(a){this.observer.error?this.jo(this.observer.error,a):console.error("Uncaught Error in snapshot listener:",a)},a.prototype.Wo=function(){this.muted=!0},a.prototype.jo=function(a,b){var c=this;this.muted||setTimeout(function(){c.muted||a(b)},0)},a}(),fM=function(){function a(a,b){var c=this;this.Go=a,this.R=b,this.metadata=new cA,this.buffer=new Uint8Array,this.zo=new TextDecoder("utf-8"),this.Ho().then(function(a){a&&a.io()?c.metadata.resolve(a.payload.metadata):c.metadata.reject(Error("The first element of the bundle is not a metadata, it is\n             "+JSON.stringify(null==a?void 0:a.payload)))},function(a){return c.metadata.reject(a)})}return a.prototype.close=function(){return this.Go.cancel()},a.prototype.getMetadata=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(a){return[2,this.metadata.promise]})})},a.prototype.Lo=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(a){switch(a.label){case 0:return[4,this.getMetadata()];case 1:return[2,(a.sent(),this.Ho())]}})})},a.prototype.Ho=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a,b,c,e;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return[4,this.Jo()];case 1:return null===(a=d.sent())?[2,null]:(isNaN(c=Number(b=this.zo.decode(a)))&&this.Yo("length string ("+b+") is not valid number"),[4,this.Xo(c)]);case 2:return e=d.sent(),[2,new e2(JSON.parse(e),a.length+c)]}})})},a.prototype.Zo=function(){return this.buffer.findIndex(function(a){return 123===a})},a.prototype.Jo=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a,b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return 0>this.Zo()?[4,this.tc()]:[3,3];case 1:if(c.sent())return[3,3];c.label=2;case 2:return[3,0];case 3:return 0===this.buffer.length?[2,null]:((a=this.Zo())<0&&this.Yo("Reached the end of bundle when a length string is expected."),b=this.buffer.slice(0,a),[2,(this.buffer=this.buffer.slice(a),b)])}})})},a.prototype.Xo=function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return this.buffer.length<a?[4,this.tc()]:[3,3];case 1:c.sent()&&this.Yo("Reached the end of bundle when more is expected."),c.label=2;case 2:return[3,0];case 3:return b=this.zo.decode(this.buffer.slice(0,a)),[2,(this.buffer=this.buffer.slice(a),b)]}})})},a.prototype.Yo=function(a){throw this.Go.cancel(),Error("Invalid bundle format: "+a)},a.prototype.tc=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a,b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return[4,this.Go.read()];case 1:return(a=c.sent()).done||((b=new Uint8Array(this.buffer.length+a.value.length)).set(this.buffer),b.set(a.value,this.buffer.length),this.buffer=b),[2,a.done]}})})},a}(),fN=function(){function a(a){this.datastore=a,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}return a.prototype.lookup=function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b,c=this;return(0,d.__generator)(this,function(e){switch(e.label){case 0:if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new k(j.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return[4,function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f,g,h,i;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var j;return e=bW((c=j=a).R)+"/documents",f={documents:b.map(function(a){return bS(c.R,a)})},[4,c.$i("BatchGetDocuments",e,f)];case 1:return g=d.sent(),h=new Map,g.forEach(function(a){var b,d,e,f,g,i,j,k,l,m,n,o,p,q,s=(b=c.R,"found"in(d=a)?(e=b,!(f=d).found&&r(),f.found.name,f.found.updateTime,i=bT(e,f.found.name),j=bP(f.found.updateTime),k=new ad({mapValue:{fields:f.found.fields}}),af.newFoundDocument(i,j,k)):"missing"in d?(l=b,!(m=d).missing&&r(),!m.readTime&&r(),p=bT(l,m.missing),q=bP(m.readTime),af.newNoDocument(p,q)):r());h.set(s.key.toString(),s)}),i=[],[2,(b.forEach(function(a){var b,c=h.get(a.toString());c||r(),i.push(c)}),i)]}})})}(this.datastore,a)];case 1:return[2,((b=e.sent()).forEach(function(a){return c.recordVersion(a)}),b)]}})})},a.prototype.set=function(a,b){this.write(b.toMutation(a,this.precondition(a))),this.writtenDocs.add(a.toString())},a.prototype.update=function(a,b){try{this.write(b.toMutation(a,this.preconditionForUpdate(a)))}catch(c){this.lastWriteError=c}this.writtenDocs.add(a.toString())},a.prototype.delete=function(a){this.write(new bl(a,this.precondition(a))),this.writtenDocs.add(a.toString())},a.prototype.commit=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a,b=this;return(0,d.__generator)(this,function(c){switch(c.label){case 0:if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;return a=this.readVersions,this.mutations.forEach(function(b){a.delete(b.key.toString())}),a.forEach(function(a,c){var d=Q.fromPath(c);b.mutations.push(new bm(d,b.precondition(d)))}),[4,function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var g;return e=bW((c=g=a).R)+"/documents",f={writes:b.map(function(a){return b$(c.R,a)})},[4,c.Ni("Commit",e,f)];case 1:return d.sent(),[2]}})})}(this.datastore,this.mutations)];case 1:return c.sent(),this.committed=!0,[2]}})})},a.prototype.recordVersion=function(a){if(a.isFoundDocument())b=a.version;else{if(!a.isNoDocument())throw r();b=x.min()}var b,c=this.readVersions.get(a.key.toString());if(c){if(!b.isEqual(c))throw new k(j.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(a.key.toString(),b)},a.prototype.precondition=function(a){var b=this.readVersions.get(a.toString());return!this.writtenDocs.has(a.toString())&&b?a6.updateTime(b):a6.none()},a.prototype.preconditionForUpdate=function(a){var b=this.readVersions.get(a.toString());if(!this.writtenDocs.has(a.toString())&&b){if(b.isEqual(x.min()))throw new k(j.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return a6.updateTime(b)}return a6.exists(!0)},a.prototype.write=function(a){this.ensureCommitNotCalled(),this.mutations.push(a)},a.prototype.ensureCommitNotCalled=function(){},a}(),fO=function(){function a(a,b,c,d){this.asyncQueue=a,this.datastore=b,this.updateFunction=c,this.deferred=d,this.ec=5,this.Zi=new el(this.asyncQueue,"transaction_retry")}return a.prototype.run=function(){this.ec-=1,this.nc()},a.prototype.nc=function(){var a=this;this.Zi.ji(function(){return(0,d.__awaiter)(a,void 0,void 0,function(){var a,b,c=this;return(0,d.__generator)(this,function(d){return a=new fN(this.datastore),(b=this.sc(a))&&b.then(function(b){c.asyncQueue.enqueueAndForget(function(){return a.commit().then(function(){c.deferred.resolve(b)}).catch(function(a){c.ic(a)})})}).catch(function(a){c.ic(a)}),[2]})})})},a.prototype.sc=function(a){try{var b,c=this.updateFunction(a);return(b=c,null!=b&&c.catch&&c.then)?c:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(d){return this.deferred.reject(d),null}},a.prototype.ic=function(a){var b=this;this.ec>0&&this.rc(a)?(this.ec-=1,this.asyncQueue.enqueueAndForget(function(){return b.nc(),Promise.resolve()})):this.deferred.reject(a)},a.prototype.rc=function(a){if("FirebaseError"===a.name){var b=a.code;return"aborted"===b||"failed-precondition"===b||!bo(b)}return!1},a}(),fP=function(){function a(a,b,c){var e=this;this.credentials=a,this.asyncQueue=b,this.databaseInfo=c,this.user=d2.UNAUTHENTICATED,this.clientId=t.u(),this.credentialListener=function(){return Promise.resolve()},this.credentials.setChangeListener(b,function(a){return(0,d.__awaiter)(e,void 0,void 0,function(){return(0,d.__generator)(this,function(b){switch(b.label){case 0:return n("FirestoreClient","Received user=",a.uid),[4,this.credentialListener(a)];case 1:return b.sent(),this.user=a,[2]}})})})}return a.prototype.getConfiguration=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(a){return[2,{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}]})})},a.prototype.setCredentialChangeListener=function(a){this.credentialListener=a},a.prototype.verifyNotTerminated=function(){if(this.asyncQueue.isShuttingDown)throw new k(j.FAILED_PRECONDITION,"The client has already been terminated.")},a.prototype.terminate=function(){var a=this;this.asyncQueue.enterRestrictedMode();var b=new cA;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(function(){return(0,d.__awaiter)(a,void 0,void 0,function(){var a,c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return d.trys.push([0,5,,6]),this.onlineComponents?[4,this.onlineComponents.terminate()]:[3,2];case 1:d.sent(),d.label=2;case 2:return this.offlineComponents?[4,this.offlineComponents.terminate()]:[3,4];case 3:d.sent(),d.label=4;case 4:return this.credentials.removeChangeListener(),b.resolve(),[3,6];case 5:return c=eS(a=d.sent(),"Failed to shutdown persistence"),b.reject(c),[3,6];case 6:return[2]}})})}),b.promise},a}();/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A class representing a bundle.
 *
 * Takes a bundle stream or buffer, and presents abstractions to read bundled
 * elements out of the underlying content.
 */ function fQ(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e,f=this;return(0,d.__generator)(this,function(g){switch(g.label){case 0:return a.asyncQueue.verifyOperationInProgress(),n("FirestoreClient","Initializing OfflineComponentProvider"),[4,a.getConfiguration()];case 1:return c=g.sent(),[4,b.initialize(c)];case 2:return g.sent(),e=c.initialUser,a.setCredentialChangeListener(function(a){return(0,d.__awaiter)(f,void 0,void 0,function(){return(0,d.__generator)(this,function(c){switch(c.label){case 0:return e.isEqual(a)?[3,2]:[4,dM(b.localStore,a)];case 1:c.sent(),e=a,c.label=2;case 2:return[2]}})})}),b.persistence.setDatabaseDeletedListener(function(){return a.terminate()}),a.offlineComponents=b,[2]}})})}function fR(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e;return(0,d.__generator)(this,function(f){switch(f.label){case 0:return a.asyncQueue.verifyOperationInProgress(),[4,fS(a)];case 1:return c=f.sent(),n("FirestoreClient","Initializing OnlineComponentProvider"),[4,a.getConfiguration()];case 2:return e=f.sent(),[4,b.initialize(c,e)];case 3:return f.sent(),a.setCredentialChangeListener(function(a){return function(a,b){return(0,d.__awaiter)(this,void 0,void 0,function(){var c,e;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var f;return(c=f=a).asyncQueue.verifyOperationInProgress(),n("RemoteStore","RemoteStore received new credentials"),e=eA(c),c.Or.add(3),[4,et(c)];case 1:return d.sent(),e&&c.Br.set("Unknown"),[4,c.remoteSyncer.handleCredentialChange(b)];case 2:return d.sent(),c.Or.delete(3),[4,es(c)];case 3:return d.sent(),[2]}})})}(b.remoteStore,a)}),a.onlineComponents=b,[2]}})})}function fS(a){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(b){switch(b.label){case 0:return a.offlineComponents?[3,2]:(n("FirestoreClient","Using default OfflineComponentProvider"),[4,fQ(a,new fG)]);case 1:b.sent(),b.label=2;case 2:return[2,a.offlineComponents]}})})}function fT(a){return(0,d.__awaiter)(this,void 0,void 0,function(){return(0,d.__generator)(this,function(b){switch(b.label){case 0:return a.onlineComponents?[3,2]:(n("FirestoreClient","Using default OnlineComponentProvider"),[4,fR(a,new fJ)]);case 1:b.sent(),b.label=2;case 2:return[2,a.onlineComponents]}})})}function fU(a){return fS(a).then(function(a){return a.persistence})}function fV(a){return fS(a).then(function(a){return a.localStore})}function fW(a){return fT(a).then(function(a){return a.remoteStore})}function fX(a){return fT(a).then(function(a){return a.syncEngine})}function fY(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b,c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return[4,fT(a)];case 1:return[2,((c=(b=d.sent()).eventManager).onListen=fc.bind(null,b.syncEngine),c.onUnlisten=fe.bind(null,b.syncEngine),c)]}})})}function fZ(a,b,c){var e=this;void 0===c&&(c={});var f=new cA;return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(e,void 0,void 0,function(){var e;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return e=function(a,b,c,d,e){var f=new fL({next:function(f){b.enqueueAndForget(function(){return eZ(a,g)});var h=f.docs.has(c);!h&&f.fromCache?e.reject(new k(j.UNAVAILABLE,"Failed to get document because the client is offline.")):h&&f.fromCache&&d&&"server"===d.source?e.reject(new k(j.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):e.resolve(f)},error:function(a){return e.reject(a)}}),g=new e1(aC(c.path),f,{includeMetadataChanges:!0,so:!0});return eY(a,g)},[4,fY(a)];case 1:return[2,e.apply(void 0,[d.sent(),a.asyncQueue,b,c,f])]}})})}),f.promise}function f$(a,b,c){var e=this;void 0===c&&(c={});var f=new cA;return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(e,void 0,void 0,function(){var e;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return e=function(a,b,c,d,e){var f=new fL({next:function(c){b.enqueueAndForget(function(){return eZ(a,g)}),c.fromCache&&"server"===d.source?e.reject(new k(j.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):e.resolve(c)},error:function(a){return e.reject(a)}}),g=new e1(c,f,{includeMetadataChanges:!0,so:!0});return eY(a,g)},[4,fY(a)];case 1:return[2,e.apply(void 0,[d.sent(),a.asyncQueue,b,c,f])]}})})}),f.promise}var f_=function(a,b,c,d,e,f,g,h){this.databaseId=a,this.appId=b,this.persistenceKey=c,this.host=d,this.ssl=e,this.forceLongPolling=f,this.autoDetectLongPolling=g,this.useFetchStreams=h},f0=function(){function a(a,b){this.projectId=a,this.database=b||"(default)"}return Object.defineProperty(a.prototype,"isDefaultDatabase",{get:function(){return"(default)"===this.database},enumerable:!1,configurable:!0}),a.prototype.isEqual=function(b){return b instanceof a&&b.projectId===this.projectId&&b.database===this.database},a}(),f1=new Map,f2=function(a,b){this.user=b,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization="Bearer "+a},f3=function(){function a(){this.changeListener=null}return a.prototype.getToken=function(){return Promise.resolve(null)},a.prototype.invalidateToken=function(){},a.prototype.setChangeListener=function(a,b){this.changeListener=b,a.enqueueRetryable(function(){return b(d2.UNAUTHENTICATED)})},a.prototype.removeChangeListener=function(){this.changeListener=null},a}(),f4=function(){function a(a){this.token=a,this.changeListener=null}return a.prototype.getToken=function(){return Promise.resolve(this.token)},a.prototype.invalidateToken=function(){},a.prototype.setChangeListener=function(a,b){var c=this;this.changeListener=b,a.enqueueRetryable(function(){return b(c.token.user)})},a.prototype.removeChangeListener=function(){this.changeListener=null},a}(),f5=function(){function a(a){var b=this;this.currentUser=d2.UNAUTHENTICATED,this.oc=new cA,this.cc=0,this.forceRefresh=!1,this.auth=null,this.asyncQueue=null,this.uc=function(){b.cc++,b.currentUser=b.ac(),b.oc.resolve(),b.changeListener&&b.asyncQueue.enqueueRetryable(function(){return b.changeListener(b.currentUser)})};var c=function(a){n("FirebaseCredentialsProvider","Auth detected"),b.auth=a,b.auth.addAuthTokenListener(b.uc)};a.onInit(function(a){return c(a)}),setTimeout(function(){if(!b.auth){var d=a.getImmediate({optional:!0});d?c(d):(n("FirebaseCredentialsProvider","Auth not yet detected"),b.oc.resolve())}},0)}return a.prototype.getToken=function(){var a=this,b=this.cc,c=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(c).then(function(c){var d;return a.cc!==b?(n("FirebaseCredentialsProvider","getToken aborted due to token change."),a.getToken()):c?("string"==typeof c.accessToken||r(),new f2(c.accessToken,a.currentUser)):null}):Promise.resolve(null)},a.prototype.invalidateToken=function(){this.forceRefresh=!0},a.prototype.setChangeListener=function(a,b){var c=this;this.asyncQueue=a,this.asyncQueue.enqueueRetryable(function(){return(0,d.__awaiter)(c,void 0,void 0,function(){return(0,d.__generator)(this,function(a){switch(a.label){case 0:return[4,this.oc.promise];case 1:return a.sent(),[4,b(this.currentUser)];case 2:return a.sent(),this.changeListener=b,[2]}})})})},a.prototype.removeChangeListener=function(){this.auth&&this.auth.removeAuthTokenListener(this.uc),this.changeListener=function(){return Promise.resolve()}},a.prototype.ac=function(){var a,b=this.auth&&this.auth.getUid();return null===b||"string"==typeof b||r(),new d2(b)},a}(),f6=function(){function a(a,b,c){this.hc=a,this.lc=b,this.fc=c,this.type="FirstParty",this.user=d2.FIRST_PARTY}return Object.defineProperty(a.prototype,"authHeaders",{get:function(){var a={"X-Goog-AuthUser":this.lc},b=this.hc.auth.getAuthHeaderValueForFirstParty([]);return b&&(a.Authorization=b),this.fc&&(a["X-Goog-Iam-Authorization-Token"]=this.fc),a},enumerable:!1,configurable:!0}),a}(),f7=function(){function a(a,b,c){this.hc=a,this.lc=b,this.fc=c}return a.prototype.getToken=function(){return Promise.resolve(new f6(this.hc,this.lc,this.fc))},a.prototype.setChangeListener=function(a,b){a.enqueueRetryable(function(){return b(d2.FIRST_PARTY)})},a.prototype.removeChangeListener=function(){},a.prototype.invalidateToken=function(){},a}();/** The default database name for a project. */ /** Represents the database ID a Firestore client is associated with. */ /**
 * Builds a CredentialsProvider depending on the type of
 * the credentials passed in.
 */ /**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ function f8(a,b,c){if(!c)throw new k(j.INVALID_ARGUMENT,"Function "+a+"() cannot be called with an empty "+b+".")}function f9(a,b){if(void 0===b)return{merge:!1};if(void 0!==b.mergeFields&& void 0!==b.merge)throw new k(j.INVALID_ARGUMENT,"Invalid options passed to function "+a+'(): You cannot specify both "merge" and "mergeFields".');return b}function ga(a,b,c,d){if(!0===b&& !0===d)throw new k(j.INVALID_ARGUMENT,a+" and "+c+" cannot be used together.")}function gb(a){if(!Q.isDocumentKey(a))throw new k(j.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+a+" has "+a.length+".")}function gc(a){if(Q.isDocumentKey(a))throw new k(j.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+a+" has "+a.length+".")}function gd(a){if(void 0===a)return"undefined";if(null===a)return"null";if("string"==typeof a)return a.length>20&&(a=a.substring(0,20)+"..."),JSON.stringify(a);if("number"==typeof a||"boolean"==typeof a)return""+a;if("object"==typeof a){if(a instanceof Array)return"an array";var b=function(a){if(a.constructor){var b=/function\s+([^\s(]+)\s*\(/.exec(a.constructor.toString());if(b&&b.length>1)return b[1]}return null}(a);return b?"a custom "+b+" object":"an object"}return"function"==typeof a?"a function":r()}function ge(a,b){if("_delegate"in a&&(a=a._delegate),!(a instanceof b)){if(b.name===a.constructor.name)throw new k(j.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var c=gd(a);throw new k(j.INVALID_ARGUMENT,"Expected type '"+b.name+"', but it was: "+c)}return a}function gf(a,b){if(b<=0)throw new k(j.INVALID_ARGUMENT,"Function "+a+"() requires a positive number, but it was: "+b+".")}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ // settings() defaults:
/**
 * A concrete type describing all the values that can be applied via a
 * user-supplied firestore.Settings object. This is a separate type so that
 * defaults can be supplied and the value can be checked for equality.
 */ var gg=function(){function a(a){var b;if(void 0===a.host){if(void 0!==a.ssl)throw new k(j.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=a.host,this.ssl=null===(b=a.ssl)|| void 0===b||b;if(this.credentials=a.credentials,this.ignoreUndefinedProperties=!!a.ignoreUndefinedProperties,void 0===a.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==a.cacheSizeBytes&&a.cacheSizeBytes<1048576)throw new k(j.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=a.cacheSizeBytes}this.experimentalForceLongPolling=!!a.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!a.experimentalAutoDetectLongPolling,this.useFetchStreams=!!a.useFetchStreams,ga("experimentalForceLongPolling",a.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",a.experimentalAutoDetectLongPolling)}return a.prototype.isEqual=function(a){return this.host===a.host&&this.ssl===a.ssl&&this.credentials===a.credentials&&this.cacheSizeBytes===a.cacheSizeBytes&&this.experimentalForceLongPolling===a.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===a.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===a.ignoreUndefinedProperties&&this.useFetchStreams===a.useFetchStreams},a}(),gh=function(){function a(a,b){this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new gg({}),this._settingsFrozen=!1,a instanceof f0?(this._databaseId=a,this._credentials=new f3):(this._app=a,this._databaseId=function(a){if(!Object.prototype.hasOwnProperty.apply(a.options,["projectId"]))throw new k(j.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new f0(a.options.projectId)}(a),this._credentials=new f5(b))}return Object.defineProperty(a.prototype,"app",{get:function(){if(!this._app)throw new k(j.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"_initialized",{get:function(){return this._settingsFrozen},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"_terminated",{get:function(){return void 0!==this._terminateTask},enumerable:!1,configurable:!0}),a.prototype._setSettings=function(a){if(this._settingsFrozen)throw new k(j.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new gg(a),void 0!==a.credentials&&(this._credentials=function(a){if(!a)return new f3;switch(a.type){case"gapi":var b,c=a.client;return("object"!=typeof c||null===c||!c.auth||!c.auth.getAuthHeaderValueForFirstParty)&&r(),new f7(c,a.sessionIndex||"0",a.iamToken||null);case"provider":return a.client;default:throw new k(j.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(a.credentials))},a.prototype._getSettings=function(){return this._settings},a.prototype._freezeSettings=function(){return this._settingsFrozen=!0,this._settings},a.prototype._delete=function(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask},a.prototype.toJSON=function(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}},a.prototype._terminate=function(){var a,b;return a=this,(b=f1.get(a))&&(n("ComponentProvider","Removing Datastore"),f1.delete(a),b.terminate()),Promise.resolve()},a}(),gi=function(){function a(a,b,c){this.converter=b,this._key=c,this.type="document",this.firestore=a}return Object.defineProperty(a.prototype,"_path",{get:function(){return this._key.path},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"parent",{get:function(){return new gk(this.firestore,this.converter,this._key.path.popLast())},enumerable:!1,configurable:!0}),a.prototype.withConverter=function(b){return new a(this.firestore,b,this._key)},a}(),gj=function(){function a(a,b,c){this.converter=b,this._query=c,this.type="query",this.firestore=a}return a.prototype.withConverter=function(b){return new a(this.firestore,b,this._query)},a}(),gk=function(a){function b(b,c,d){var e=this;return(e=a.call(this,b,c,aC(d))||this)._path=d,e.type="collection",e}return(0,d.__extends)(b,a),Object.defineProperty(b.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"parent",{get:function(){var a=this._path.popLast();return a.isEmpty()?null:new gi(this.firestore,null,new Q(a))},enumerable:!1,configurable:!0}),b.prototype.withConverter=function(a){return new b(this.firestore,a,this._path)},b}(gj);/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * The Cloud Firestore service interface.
 *
 * Do not call this constructor directly. Instead, use {@link getFirestore}.
 */ function gl(a,b){for(var c,f=[],g=2;g<arguments.length;g++)f[g-2]=arguments[g];if(a=(0,e.getModularInstance)(a),f8("collection","path",b),a instanceof gh)return gc(c=C.fromString.apply(C,(0,d.__spreadArray)([b],f))),new gk(a,null,c);if(!(a instanceof gi||a instanceof gk))throw new k(j.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return gc(c=C.fromString.apply(C,(0,d.__spreadArray)([a.path],f)).child(C.fromString(b))),new gk(a.firestore,null,c)}function gm(a,b){for(var c,f=[],g=2;g<arguments.length;g++)f[g-2]=arguments[g];if(a=(0,e.getModularInstance)(a),1===arguments.length&&(b=t.u()),f8("doc","path",b),a instanceof gh)return gb(c=C.fromString.apply(C,(0,d.__spreadArray)([b],f))),new gi(a,null,new Q(c));if(!(a instanceof gi||a instanceof gk))throw new k(j.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return gb(c=a._path.child(C.fromString.apply(C,(0,d.__spreadArray)([b],f)))),new gi(a.firestore,a instanceof gk?a.converter:null,new Q(c))}function gn(a,b){return a=(0,e.getModularInstance)(a),b=(0,e.getModularInstance)(b),(a instanceof gi||a instanceof gk)&&(b instanceof gi||b instanceof gk)&&a.firestore===b.firestore&&a.path===b.path&&a.converter===b.converter}function go(a,b){return a=(0,e.getModularInstance)(a),b=(0,e.getModularInstance)(b),a instanceof gj&&b instanceof gj&&a.firestore===b.firestore&&aL(a._query,b._query)&&a.converter===b.converter /**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ }var gp=function(){function a(){var a=this;this.dc=Promise.resolve(),this.wc=[],this._c=!1,this.mc=[],this.yc=null,this.gc=!1,this.Ec=!1,this.Tc=[],this.Zi=new el(this,"async_queue_retry"),this.Ic=function(){var b=ej();b&&n("AsyncQueue","Visibility state changed to "+b.visibilityState),a.Zi.Gi()};var b=ej();b&&"function"==typeof b.addEventListener&&b.addEventListener("visibilitychange",this.Ic)}return Object.defineProperty(a.prototype,"isShuttingDown",{get:function(){return this._c},enumerable:!1,configurable:!0}),a.prototype.enqueueAndForget=function(a){this.enqueue(a)},a.prototype.enqueueAndForgetEvenWhileRestricted=function(a){this.Ac(),this.Rc(a)},a.prototype.enterRestrictedMode=function(a){if(!this._c){this._c=!0,this.Ec=a||!1;var b=ej();b&&"function"==typeof b.removeEventListener&&b.removeEventListener("visibilitychange",this.Ic)}},a.prototype.enqueue=function(a){var b=this;if(this.Ac(),this._c)return new Promise(function(){});var c=new cA;return this.Rc(function(){return b._c&&b.Ec?Promise.resolve():(a().then(c.resolve,c.reject),c.promise)}).then(function(){return c.promise})},a.prototype.enqueueRetryable=function(a){var b=this;this.enqueueAndForget(function(){return b.wc.push(a),b.bc()})},a.prototype.bc=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a,b=this;return(0,d.__generator)(this,function(c){switch(c.label){case 0:if(0===this.wc.length)return[3,5];c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this.wc[0]()];case 2:return c.sent(),this.wc.shift(),this.Zi.reset(),[3,4];case 3:if(!cG(a=c.sent()))throw a;return n("AsyncQueue","Operation failed with retryable error: "+a),[3,4];case 4:this.wc.length>0&&this.Zi.ji(function(){return b.bc()}),c.label=5;case 5:return[2]}})})},a.prototype.Rc=function(a){var b=this,c=this.dc.then(function(){return b.gc=!0,a().catch(function(a){var c,d;throw b.yc=a,b.gc=!1,o("INTERNAL UNHANDLED ERROR: ",(d=(c=a).message||"",c.stack&&(d=c.stack.includes(c.message)?c.stack:c.message+"\n"+c.stack),d)),a}).then(function(a){return b.gc=!1,a})});return this.dc=c,c},a.prototype.enqueueAfterDelay=function(a,b,c){var d=this;this.Ac(),this.Tc.indexOf(a)> -1&&(b=0);var e=eR.createAndSchedule(this,a,b,c,function(a){return d.vc(a)});return this.mc.push(e),e},a.prototype.Ac=function(){this.yc&&r()},a.prototype.verifyOperationInProgress=function(){},a.prototype.Pc=function(){return(0,d.__awaiter)(this,void 0,void 0,function(){var a;return(0,d.__generator)(this,function(b){switch(b.label){case 0:return[4,a=this.dc];case 1:b.sent(),b.label=2;case 2:if(a!==this.dc)return[3,0];b.label=3;case 3:return[2]}})})},a.prototype.Vc=function(a){for(var b=0,c=this.mc;b<c.length;b++)if(c[b].timerId===a)return!0;return!1},a.prototype.Sc=function(a){var b=this;return this.Pc().then(function(){b.mc.sort(function(a,b){return a.targetTimeMs-b.targetTimeMs});for(var c=0,d=b.mc;c<d.length;c++){var e=d[c];if(e.skipDelay(),"all"!==a&&e.timerId===a)break}return b.Pc()})},a.prototype.Dc=function(a){this.Tc.push(a)},a.prototype.vc=function(a){var b=this.mc.indexOf(a);this.mc.splice(b,1)},a}();function gq(a){return function(a,b){if("object"!=typeof a||null===a)return!1;for(var c=a,d=0,e=["next","error","complete"];d<e.length;d++){var f=e[d];if(f in c&&"function"==typeof c[f])return!0}return!1}(a)}var gr=function(){function a(){this._progressObserver={},this._taskCompletionResolver=new cA,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}return a.prototype.onProgress=function(a,b,c){this._progressObserver={next:a,error:b,complete:c}},a.prototype.catch=function(a){return this._taskCompletionResolver.promise.catch(a)},a.prototype.then=function(a,b){return this._taskCompletionResolver.promise.then(a,b)},a.prototype._completeWith=function(a){this._updateProgress(a),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(a)},a.prototype._failWith=function(a){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(a),this._taskCompletionResolver.reject(a)},a.prototype._updateProgress=function(a){this._lastProgress=a,this._progressObserver.next&&this._progressObserver.next(a)},a}(),gs=-1,gt=function(a){function b(b,c){var d=this;return(d=a.call(this,b,c)||this).type="firestore",d._queue=new gp,d._persistenceKey="name"in b?b.name:"[DEFAULT]",d}return(0,d.__extends)(b,a),b.prototype._terminate=function(){return this._firestoreClient||gv(this),this._firestoreClient.terminate()},b}(gh);/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** DOMException error code constants. */ /**
 * @internal
 */ function gu(a){return a._firestoreClient||gv(a),a._firestoreClient.verifyNotTerminated(),a._firestoreClient}function gv(a){var b,c,d,e,f,g=a._freezeSettings(),h=(b=a._databaseId,c=(null===(f=a._app)|| void 0===f?void 0:f.options.appId)||"",d=a._persistenceKey,e=g,new f_(b,c,d,e.host,e.ssl,e.experimentalForceLongPolling,e.experimentalAutoDetectLongPolling,e.useFetchStreams));a._firestoreClient=new fP(a._credentials,a._queue,h)}function gw(a,b,c){var e=this,f=new cA;return a.asyncQueue.enqueue(function(){return(0,d.__awaiter)(e,void 0,void 0,function(){var e;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return d.trys.push([0,3,,4]),[4,fQ(a,c)];case 1:return d.sent(),[4,fR(a,b)];case 2:return d.sent(),f.resolve(),[3,4];case 3:var g;if("FirebaseError"===(g=e=d.sent()).name?g.code!==j.FAILED_PRECONDITION&&g.code!==j.UNIMPLEMENTED:!!("undefined"!=typeof DOMException&&g instanceof DOMException)&&22!==g.code&&20!==g.code&&11!==g.code)throw e;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+e),f.reject(e),[3,4];case 4:return[2]}})})}).then(function(){return f.promise})}function gx(a){if(a._initialized||a._terminated)throw new k(j.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A `FieldPath` refers to a field in a document. The path may consist of a
 * single field name (referring to a top-level field in the document), or a
 * list of field names (referring to a nested field in the document).
 *
 * Create a `FieldPath` by providing field names. If more than one field
 * name is provided, the path will point to a nested field in a document.
 */ var gy=function(){function a(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];for(var c=0;c<a.length;++c)if(0===a[c].length)throw new k(j.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new E(a)}return a.prototype.isEqual=function(a){return this._internalPath.isEqual(a._internalPath)},a}(),gz=function(){function a(a){this._byteString=a}return a.fromBase64String=function(b){try{return new a(G.fromBase64String(b))}catch(c){throw new k(j.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+c)}},a.fromUint8Array=function(b){return new a(G.fromUint8Array(b))},a.prototype.toBase64=function(){return this._byteString.toBase64()},a.prototype.toUint8Array=function(){return this._byteString.toUint8Array()},a.prototype.toString=function(){return"Bytes(base64: "+this.toBase64()+")"},a.prototype.isEqual=function(a){return this._byteString.isEqual(a._byteString)},a}(),gA=function(a){this._methodName=a},gB=function(){function a(a,b){if(!isFinite(a)||a< -90||a>90)throw new k(j.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+a);if(!isFinite(b)||b< -180||b>180)throw new k(j.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+b);this._lat=a,this._long=b}return Object.defineProperty(a.prototype,"latitude",{get:function(){return this._lat},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"longitude",{get:function(){return this._long},enumerable:!1,configurable:!0}),a.prototype.isEqual=function(a){return this._lat===a._lat&&this._long===a._long},a.prototype.toJSON=function(){return{latitude:this._lat,longitude:this._long}},a.prototype._compareTo=function(a){return u(this._lat,a._lat)||u(this._long,a._long)},a}(),gC=/^__.*__$/,gD=function(){function a(a,b,c){this.data=a,this.fieldMask=b,this.fieldTransforms=c}return a.prototype.toMutation=function(a,b){return null!==this.fieldMask?new bf(a,this.data,this.fieldMask,b,this.fieldTransforms):new be(a,this.data,b,this.fieldTransforms)},a}(),gE=function(){function a(a,b,c){this.data=a,this.fieldMask=b,this.fieldTransforms=c}return a.prototype.toMutation=function(a,b){return new bf(a,this.data,this.fieldMask,b,this.fieldTransforms)},a}();/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * An immutable object representing an array of bytes.
 */ function gF(a){switch(a){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw r()}}var gG=function(){function a(a,b,c,d,e,f){this.settings=a,this.databaseId=b,this.R=c,this.ignoreUndefinedProperties=d,void 0===e&&this.Cc(),this.fieldTransforms=e||[],this.fieldMask=f||[]}return Object.defineProperty(a.prototype,"path",{get:function(){return this.settings.path},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"Nc",{get:function(){return this.settings.Nc},enumerable:!1,configurable:!0}),a.prototype.xc=function(b){return new a(Object.assign(Object.assign({},this.settings),b),this.databaseId,this.R,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)},a.prototype.Fc=function(a){var b,c=null===(b=this.path)|| void 0===b?void 0:b.child(a),d=this.xc({path:c,kc:!1});return d.$c(a),d},a.prototype.Oc=function(a){var b,c=null===(b=this.path)|| void 0===b?void 0:b.child(a),d=this.xc({path:c,kc:!1});return d.Cc(),d},a.prototype.Mc=function(a){return this.xc({path:void 0,kc:!0})},a.prototype.Lc=function(a){return g$(a,this.settings.methodName,this.settings.Bc||!1,this.path,this.settings.qc)},a.prototype.contains=function(a){return void 0!==this.fieldMask.find(function(b){return a.isPrefixOf(b)})|| void 0!==this.fieldTransforms.find(function(b){return a.isPrefixOf(b.field)})},a.prototype.Cc=function(){if(this.path)for(var a=0;a<this.path.length;a++)this.$c(this.path.get(a))},a.prototype.$c=function(a){if(0===a.length)throw this.Lc("Document fields must not be empty");if(gF(this.Nc)&&gC.test(a))throw this.Lc('Document fields cannot begin and end with "__"')},a}(),gH=function(){function a(a,b,c){this.databaseId=a,this.ignoreUndefinedProperties=b,this.R=c||ek(a)}return a.prototype.Uc=function(a,b,c,d){return void 0===d&&(d=!1),new gG({Nc:a,methodName:b,qc:c,path:E.emptyPath(),kc:!1,Bc:d},this.databaseId,this.R,this.ignoreUndefinedProperties)},a}();function gI(a){var b=a._freezeSettings(),c=ek(a._databaseId);return new gH(a._databaseId,!!b.ignoreUndefinedProperties,c)}function gJ(a,b,c,d,e,f){void 0===f&&(f={});var g=a.Uc(f.merge||f.mergeFields?2:0,b,c,e);gW("Data must be an object, but it was:",g,d);var h,i,l=gU(d,g);if(f.merge)h=new F(g.fieldMask),i=g.fieldTransforms;else if(f.mergeFields){for(var m=[],n=0,o=f.mergeFields;n<o.length;n++){var p=gX(b,o[n],c);if(!g.contains(p))throw new k(j.INVALID_ARGUMENT,"Field '"+p+"' is specified in your field mask but missing from your input data.");g_(m,p)||m.push(p)}h=new F(m),i=g.fieldTransforms.filter(function(a){return h.covers(a.field)})}else h=null,i=g.fieldTransforms;return new gD(new ad(l),h,i)}var gK=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return(0,d.__extends)(b,a),b.prototype._toFieldTransform=function(a){if(2!==a.Nc)throw 1===a.Nc?a.Lc(this._methodName+"() can only appear at the top level of your update data"):a.Lc(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return a.fieldMask.push(a.path),null},b.prototype.isEqual=function(a){return a instanceof b},b}(gA);function gL(a,b,c){return new gG({Nc:3,qc:b.settings.qc,methodName:a._methodName,kc:c},b.databaseId,b.R,b.ignoreUndefinedProperties)}var gM=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return(0,d.__extends)(b,a),b.prototype._toFieldTransform=function(a){return new a4(a.path,new aY)},b.prototype.isEqual=function(a){return a instanceof b},b}(gA),gN=function(a){function b(b,c){var d=this;return(d=a.call(this,b)||this).Kc=c,d}return(0,d.__extends)(b,a),b.prototype._toFieldTransform=function(a){var b=gL(this,a,!0),c=this.Kc.map(function(a){return gT(a,b)}),d=new aZ(c);return new a4(a.path,d)},b.prototype.isEqual=function(a){return this===a},b}(gA),gO=function(a){function b(b,c){var d=this;return(d=a.call(this,b)||this).Kc=c,d}return(0,d.__extends)(b,a),b.prototype._toFieldTransform=function(a){var b=gL(this,a,!0),c=this.Kc.map(function(a){return gT(a,b)}),d=new a_(c);return new a4(a.path,d)},b.prototype.isEqual=function(a){return this===a},b}(gA),gP=function(a){function b(b,c){var d=this;return(d=a.call(this,b)||this).Qc=c,d}return(0,d.__extends)(b,a),b.prototype._toFieldTransform=function(a){var b=new a1(a.R,aT(a.R,this.Qc));return new a4(a.path,b)},b.prototype.isEqual=function(a){return this===a},b}(gA);function gQ(a,b,c,d){var f=a.Uc(1,b,c);gW("Data must be an object, but it was:",f,d);var g=[],h=ad.empty();z(d,function(a,d){var i=gZ(b,a,c);d=(0,e.getModularInstance)(d);var j=f.Oc(i);if(d instanceof gK)g.push(i);else{var k=gT(d,j);null!=k&&(g.push(i),h.set(i,k))}});var i=new F(g);return new gE(h,i,f.fieldTransforms)}function gR(a,b,c,d,f,g){var h=a.Uc(1,b,c),i=[gX(b,d,c)],l=[f];if(g.length%2!=0)throw new k(j.INVALID_ARGUMENT,"Function "+b+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var m=0;m<g.length;m+=2)i.push(gX(b,g[m])),l.push(g[m+1]);for(var n=[],o=ad.empty(),p=i.length-1;p>=0;--p)if(!g_(n,i[p])){var q=i[p],r=l[p];r=(0,e.getModularInstance)(r);var s=h.Oc(q);if(r instanceof gK)n.push(q);else{var t=gT(r,s);null!=t&&(n.push(q),o.set(q,t))}}var u=new F(n);return new gE(o,u,h.fieldTransforms)}function gS(a,b,c,d){return void 0===d&&(d=!1),gT(c,a.Uc(d?4:3,b))}function gT(a,b){if(gV(a=(0,e.getModularInstance)(a)))return gW("Unsupported field value:",b,a),gU(a,b);if(a instanceof gA)return function(a,b){if(!gF(b.Nc))throw b.Lc(a._methodName+"() can only be used with update() and set()");if(!b.path)throw b.Lc(a._methodName+"() is not currently supported inside arrays");var c=a._toFieldTransform(b);c&&b.fieldTransforms.push(c)}(a,b),null;if(void 0===a&&b.ignoreUndefinedProperties)return null;if(b.path&&b.fieldMask.push(b.path),a instanceof Array){if(b.settings.kc&&4!==b.Nc)throw b.Lc("Nested arrays are not supported");return function(a,b){for(var c=[],d=0,e=0,f=a;e<f.length;e++){var g=gT(f[e],b.Mc(d));null==g&&(g={nullValue:"NULL_VALUE"}),c.push(g),d++}return{arrayValue:{values:c}}}(a,b)}return function(a,b){if(null===(a=(0,e.getModularInstance)(a)))return{nullValue:"NULL_VALUE"};if("number"==typeof a)return aT(b.R,a);if("boolean"==typeof a)return{booleanValue:a};if("string"==typeof a)return{stringValue:a};if(a instanceof Date){var c=w.fromDate(a);return{timestampValue:bN(b.R,c)}}if(a instanceof w)return c=new w(a.seconds,1e3*Math.floor(a.nanoseconds/1e3)),{timestampValue:bN(b.R,c)};if(a instanceof gB)return{geoPointValue:{latitude:a.latitude,longitude:a.longitude}};if(a instanceof gz)return{bytesValue:bO(b.R,a._byteString)};if(a instanceof gi){c=b.databaseId;var d=a.firestore._databaseId;if(!d.isEqual(c))throw b.Lc("Document reference is for database "+d.projectId+"/"+d.database+" but should be for database "+c.projectId+"/"+c.database);return{referenceValue:bQ(a.firestore._databaseId||b.databaseId,a._key.path)}}throw b.Lc("Unsupported field value: "+gd(a))}(a,b)}function gU(a,b){var c={};return A(a)?b.path&&b.path.length>0&&b.fieldMask.push(b.path):z(a,function(a,d){var e=gT(d,b.Fc(a));null!=e&&(c[a]=e)}),{mapValue:{fields:c}}}function gV(a){return!("object"!=typeof a||null===a||a instanceof Array||a instanceof Date||a instanceof w||a instanceof gB||a instanceof gz||a instanceof gi||a instanceof gA)}function gW(a,b,c){var d;if(!gV(c)||"object"!=typeof(d=c)||null===d||Object.getPrototypeOf(d)!==Object.prototype&&null!==Object.getPrototypeOf(d)){var e=gd(c);throw"an object"===e?b.Lc(a+" a custom object"):b.Lc(a+" "+e)}}function gX(a,b,c){if((b=(0,e.getModularInstance)(b))instanceof gy)return b._internalPath;if("string"==typeof b)return gZ(a,b);throw g$("Field path arguments must be of type string or FieldPath.",a,!1,void 0,c)}var gY=RegExp("[~\\*/\\[\\]]");function gZ(a,b,c){if(b.search(gY)>=0)throw g$("Invalid field path ("+b+"). Paths must not contain '~', '*', '/', '[', or ']'",a,!1,void 0,c);try{return(new(gy.bind.apply(gy,(0,d.__spreadArray)([void 0],b.split(".")))))._internalPath}catch(e){throw g$("Invalid field path ("+b+"). Paths must not be empty, begin with '.', end with '.', or contain '..'",a,!1,void 0,c)}}function g$(a,b,c,d,e){var f=d&&!d.isEmpty(),g=void 0!==e,h="Function "+b+"() called with invalid data";c&&(h+=" (via `toFirestore()`)");var i="";return(f||g)&&(i+=" (found",f&&(i+=" in field "+d),g&&(i+=" in document "+e),i+=")"),new k(j.INVALID_ARGUMENT,(h+=". ")+a+i)}function g_(a,b){return a.some(function(a){return a.isEqual(b)})}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A `DocumentSnapshot` contains data read from a document in your Firestore
 * database. The data can be extracted with `.data()` or `.get(<field>)` to
 * get a specific field.
 *
 * For a `DocumentSnapshot` that points to a non-existing document, any data
 * access will return 'undefined'. You can use the `exists()` method to
 * explicitly verify a document's existence.
 */ var g0=function(){function a(a,b,c,d,e){this._firestore=a,this._userDataWriter=b,this._key=c,this._document=d,this._converter=e}return Object.defineProperty(a.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"ref",{get:function(){return new gi(this._firestore,this._converter,this._key)},enumerable:!1,configurable:!0}),a.prototype.exists=function(){return null!==this._document},a.prototype.data=function(){if(this._document){if(this._converter){var a=new g1(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(a)}return this._userDataWriter.convertValue(this._document.data.value)}},a.prototype.get=function(a){if(this._document){var b=this._document.data.field(g2("DocumentSnapshot.get",a));if(null!==b)return this._userDataWriter.convertValue(b)}},a}(),g1=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return(0,d.__extends)(b,a),b.prototype.data=function(){return a.prototype.data.call(this)},b}(g0);function g2(a,b){return"string"==typeof b?gZ(a,b):b instanceof gy?b._internalPath:b._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Metadata about a snapshot, describing the state of the snapshot.
 */ var g3=function(){function a(a,b){this.hasPendingWrites=a,this.fromCache=b}return a.prototype.isEqual=function(a){return this.hasPendingWrites===a.hasPendingWrites&&this.fromCache===a.fromCache},a}(),g4=function(a){function b(b,c,d,e,f,g){var h=this;return(h=a.call(this,b,c,d,e,g)||this)._firestore=b,h._firestoreImpl=b,h.metadata=f,h}return(0,d.__extends)(b,a),b.prototype.exists=function(){return a.prototype.exists.call(this)},b.prototype.data=function(a){if(void 0===a&&(a={}),this._document){if(this._converter){var b=new g5(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(b,a)}return this._userDataWriter.convertValue(this._document.data.value,a.serverTimestamps)}},b.prototype.get=function(a,b){if(void 0===b&&(b={}),this._document){var c=this._document.data.field(g2("DocumentSnapshot.get",a));if(null!==c)return this._userDataWriter.convertValue(c,b.serverTimestamps)}},b}(g0),g5=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return(0,d.__extends)(b,a),b.prototype.data=function(b){return void 0===b&&(b={}),a.prototype.data.call(this,b)},b}(g4),g6=function(){function a(a,b,c,d){this._firestore=a,this._userDataWriter=b,this._snapshot=d,this.metadata=new g3(d.hasPendingWrites,d.fromCache),this.query=c}return Object.defineProperty(a.prototype,"docs",{get:function(){var a=[];return this.forEach(function(b){return a.push(b)}),a},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"empty",{get:function(){return 0===this.size},enumerable:!1,configurable:!0}),a.prototype.forEach=function(a,b){var c=this;this._snapshot.docs.forEach(function(d){a.call(b,new g5(c._firestore,c._userDataWriter,d.key,d,new g3(c._snapshot.mutatedKeys.has(d.key),c._snapshot.fromCache),c.query.converter))})},a.prototype.docChanges=function(a){void 0===a&&(a={});var b=!!a.includeMetadataChanges;if(b&&this._snapshot.excludesMetadataChanges)throw new k(j.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===b||(this._cachedChanges=function(a,b){if(a._snapshot.oldDocs.isEmpty()){var c=0;return a._snapshot.docChanges.map(function(b){return{type:"added",doc:new g5(a._firestore,a._userDataWriter,b.doc.key,b.doc,new g3(a._snapshot.mutatedKeys.has(b.doc.key),a._snapshot.fromCache),a.query.converter),oldIndex:-1,newIndex:c++}})}var d=a._snapshot.oldDocs;return a._snapshot.docChanges.filter(function(a){return b||3!==a.type}).map(function(b){var c=new g5(a._firestore,a._userDataWriter,b.doc.key,b.doc,new g3(a._snapshot.mutatedKeys.has(b.doc.key),a._snapshot.fromCache),a.query.converter),e=-1,f=-1;return 0!==b.type&&(e=d.indexOf(b.doc.key),d=d.delete(b.doc.key)),1!==b.type&&(f=(d=d.add(b.doc)).indexOf(b.doc.key)),{type:g7(b.type),doc:c,oldIndex:e,newIndex:f}})}(this,b),this._cachedChangesIncludeMetadataChanges=b),this._cachedChanges},a}();function g7(a){switch(a){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return r()}}function g8(a,b){return a instanceof g4&&b instanceof g4?a._firestore===b._firestore&&a._key.isEqual(b._key)&&(null===a._document?null===b._document:a._document.isEqual(b._document))&&a._converter===b._converter:a instanceof g6&&b instanceof g6&&a._firestore===b._firestore&&go(a.query,b.query)&&a.metadata.isEqual(b.metadata)&&a._snapshot.isEqual(b._snapshot)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ function g9(a){if(aE(a)&&0===a.explicitOrderBy.length)throw new k(j.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var ha=function(){};function hb(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];for(var d=0,e=b;d<e.length;d++)a=e[d]._apply(a);return a}var hc=function(a){function b(b,c,d){var e=this;return(e=a.call(this)||this).jc=b,e.Wc=c,e.Gc=d,e.type="where",e}return(0,d.__extends)(b,a),b.prototype._apply=function(a){var b,c,d,e=gI(a.firestore),f=function(a,b,c,d,e,f,g){if(e.isKeyField()){if("array-contains"===f||"array-contains-any"===f)throw new k(j.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+f+"' queries on FieldPath.documentId().");if("in"===f||"not-in"===f){hj(g,f);for(var h,i=[],l=0,m=g;l<m.length;l++){var n=m[l];i.push(hi(d,a,n))}h={arrayValue:{values:i}}}else h=hi(d,a,g)}else"in"!==f&&"not-in"!==f&&"array-contains-any"!==f||hj(g,f),h=gS(c,"where",g,"in"===f||"not-in"===f);var o=al.create(e,f,h);return function(a,b){if(b.g()){var c=aG(a);if(null!==c&&!c.isEqual(b.field))throw new k(j.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '"+c.toString()+"' and '"+b.field.toString()+"'");var d=aF(a);null!==d&&hk(a,b.field,d)}var e=function(a,b){for(var c=0,d=a.filters;c<d.length;c++){var e=d[c];if(b.indexOf(e.op)>=0)return e.op}return null}(a,function(a){switch(a){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(b.op));if(null!==e)throw e===b.op?new k(j.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+b.op.toString()+"' filter."):new k(j.INVALID_ARGUMENT,"Invalid query. You cannot use '"+b.op.toString()+"' filters with '"+e.toString()+"' filters.")}(a,o),o}(a._query,0,e,a.firestore._databaseId,this.jc,this.Wc,this.Gc);return new gj(a.firestore,a.converter,(b=a._query,c=f,d=b.filters.concat([c]),new aA(b.path,b.collectionGroup,b.explicitOrderBy.slice(),d,b.limit,b.limitType,b.startAt,b.endAt)))},b}(ha),hd=function(a){function b(b,c){var d=this;return(d=a.call(this)||this).jc=b,d.zc=c,d.type="orderBy",d}return(0,d.__extends)(b,a),b.prototype._apply=function(a){var b,c,d,e=function(a,b,c){if(null!==a.startAt)throw new k(j.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==a.endAt)throw new k(j.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var d=new aw(b,c);return function(a,b){if(null===aF(a)){var c=aG(a);null!==c&&hk(a,c,b.field)}}(a,d),d}(a._query,this.jc,this.zc);return new gj(a.firestore,a.converter,(b=a._query,c=e,d=b.explicitOrderBy.concat([c]),new aA(b.path,b.collectionGroup,d,b.filters.slice(),b.limit,b.limitType,b.startAt,b.endAt)))},b}(ha),he=function(a){function b(b,c,d){var e=this;return(e=a.call(this)||this).type=b,e.Hc=c,e.Jc=d,e}return(0,d.__extends)(b,a),b.prototype._apply=function(a){return new gj(a.firestore,a.converter,aK(a._query,this.Hc,this.Jc))},b}(ha),hf=function(a){function b(b,c,d){var e=this;return(e=a.call(this)||this).type=b,e.Yc=c,e.Xc=d,e}return(0,d.__extends)(b,a),b.prototype._apply=function(a){var b,c,d=hh(a,this.type,this.Yc,this.Xc);return new gj(a.firestore,a.converter,(b=a._query,c=d,new aA(b.path,b.collectionGroup,b.explicitOrderBy.slice(),b.filters.slice(),b.limit,b.limitType,c,b.endAt)))},b}(ha),hg=function(a){function b(b,c,d){var e=this;return(e=a.call(this)||this).type=b,e.Yc=c,e.Xc=d,e}return(0,d.__extends)(b,a),b.prototype._apply=function(a){var b,c,d=hh(a,this.type,this.Yc,this.Xc);return new gj(a.firestore,a.converter,(b=a._query,c=d,new aA(b.path,b.collectionGroup,b.explicitOrderBy.slice(),b.filters.slice(),b.limit,b.limitType,b.startAt,c)))},b}(ha);function hh(a,b,c,d){if(c[0]=(0,e.getModularInstance)(c[0]),c[0]instanceof g0)return function(a,b,c,d,e){if(!d)throw new k(j.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+c+"().");for(var f=[],g=0,h=aI(a);g<h.length;g++){var i=h[g];if(i.field.isKeyField())f.push(Y(b,d.key));else{var l=d.data.field(i.field);if(L(l))throw new k(j.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+i.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===l){var m=i.field.canonicalString();throw new k(j.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+m+"' (used as the orderBy) does not exist.")}f.push(l)}}return new au(f,e)}(a._query,a.firestore._databaseId,b,c[0]._document,d);var f=gI(a.firestore);return function(a,b,c,d,e,f){var g=a.explicitOrderBy;if(e.length>g.length)throw new k(j.INVALID_ARGUMENT,"Too many arguments provided to "+d+"(). The number of arguments must be less than or equal to the number of orderBy() clauses");for(var h=[],i=0;i<e.length;i++){var l=e[i];if(g[i].field.isKeyField()){if("string"!=typeof l)throw new k(j.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+d+"(), but got a "+typeof l);if(!aH(a)&& -1!==l.indexOf("/"))throw new k(j.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+d+"() must be a plain document ID, but '"+l+"' contains a slash.");var m=a.path.child(C.fromString(l));if(!Q.isDocumentKey(m))throw new k(j.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+d+"() must result in a valid document path, but '"+m+"' is not because it contains an odd number of segments.");var n=new Q(m);h.push(Y(b,n))}else{var o=gS(c,d,l);h.push(o)}}return new au(h,f)}(a._query,a.firestore._databaseId,f,b,c,d)}function hi(a,b,c){if("string"==typeof(c=(0,e.getModularInstance)(c))){if(""===c)throw new k(j.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!aH(b)&& -1!==c.indexOf("/"))throw new k(j.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+c+"' contains a '/' character.");var d=b.path.child(C.fromString(c));if(!Q.isDocumentKey(d))throw new k(j.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+d+"' is not because it has an odd number of segments ("+d.length+").");return Y(a,new Q(d))}if(c instanceof gi)return Y(a,c._key);throw new k(j.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+gd(c)+".")}function hj(a,b){if(!Array.isArray(a)||0===a.length)throw new k(j.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+b.toString()+"' filters.");if(a.length>10)throw new k(j.INVALID_ARGUMENT,"Invalid Query. '"+b.toString()+"' filters support a maximum of 10 elements in the value array.")}function hk(a,b,c){if(!c.isEqual(b))throw new k(j.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '"+b.toString()+"' and so you must also use '"+b.toString()+"' as your first argument to orderBy(), but your first orderBy() is on field '"+c.toString()+"' instead.")}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Converts Firestore's internal types to the JavaScript types that we expose
 * to the user.
 *
 * @internal
 */ var hl=function(){function a(){}return a.prototype.convertValue=function(a,b){switch(void 0===b&&(b="none"),R(a)){case 0:return null;case 1:return a.booleanValue;case 2:return J(a.integerValue||a.doubleValue);case 3:return this.convertTimestamp(a.timestampValue);case 4:return this.convertServerTimestamp(a,b);case 5:return a.stringValue;case 6:return this.convertBytes(K(a.bytesValue));case 7:return this.convertReference(a.referenceValue);case 8:return this.convertGeoPoint(a.geoPointValue);case 9:return this.convertArray(a.arrayValue,b);case 10:return this.convertObject(a.mapValue,b);default:throw r()}},a.prototype.convertObject=function(a,b){var c=this,d={};return z(a.fields,function(a,e){d[a]=c.convertValue(e,b)}),d},a.prototype.convertGeoPoint=function(a){return new gB(J(a.latitude),J(a.longitude))},a.prototype.convertArray=function(a,b){var c=this;return(a.values||[]).map(function(a){return c.convertValue(a,b)})},a.prototype.convertServerTimestamp=function(a,b){switch(b){case"previous":var c=M(a);return null==c?null:this.convertValue(c,b);case"estimate":return this.convertTimestamp(N(a));default:return null}},a.prototype.convertTimestamp=function(a){var b=I(a);return new w(b.seconds,b.nanos)},a.prototype.convertDocumentKey=function(a,b){var c,d=C.fromString(a);(c=cd(d))||r();var e=new f0(d.get(1),d.get(3)),f=new Q(d.popFirst(5));return e.isEqual(b)||o("Document "+f+" contains a document reference within a different database ("+e.projectId+"/"+e.database+") which is not supported. It will be treated as a reference in the current database ("+b.projectId+"/"+b.database+") instead."),f},a}();/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * Converts custom model object of type T into DocumentData by applying the
 * converter if it exists.
 *
 * This function is used when converting user objects to DocumentData
 * because we want to provide the user with a more specific error message if
 * their set() or fails due to invalid data originating from a toFirestore()
 * call.
 */ function hm(a,b,c){return a?c&&(c.merge||c.mergeFields)?a.toFirestore(b,c):a.toFirestore(b):b}var hn=function(a){function b(b){var c=this;return(c=a.call(this)||this).firestore=b,c}return(0,d.__extends)(b,a),b.prototype.convertBytes=function(a){return new gz(a)},b.prototype.convertReference=function(a){var b=this.convertDocumentKey(a,this.firestore._databaseId);return new gi(this.firestore,null,b)},b}(hl),ho=function(){function a(a,b){this._firestore=a,this._commitHandler=b,this._mutations=[],this._committed=!1,this._dataReader=gI(a)}return a.prototype.set=function(a,b,c){this._verifyNotCommitted();var d=hp(a,this._firestore),e=hm(d.converter,b,c),f=gJ(this._dataReader,"WriteBatch.set",d._key,e,null!==d.converter,c);return this._mutations.push(f.toMutation(d._key,a6.none())),this},a.prototype.update=function(a,b,c){for(var d=[],f=3;f<arguments.length;f++)d[f-3]=arguments[f];this._verifyNotCommitted();var g,h=hp(a,this._firestore);return g="string"==typeof(b=(0,e.getModularInstance)(b))||b instanceof gy?gR(this._dataReader,"WriteBatch.update",h._key,b,c,d):gQ(this._dataReader,"WriteBatch.update",h._key,b),this._mutations.push(g.toMutation(h._key,a6.exists(!0))),this},a.prototype.delete=function(a){this._verifyNotCommitted();var b=hp(a,this._firestore);return this._mutations=this._mutations.concat(new bl(b._key,a6.none())),this},a.prototype.commit=function(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()},a.prototype._verifyNotCommitted=function(){if(this._committed)throw new k(j.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},a}();/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A write batch, used to perform multiple writes as a single atomic unit.
 *
 * A `WriteBatch` object can be acquired by calling {@link writeBatch}. It
 * provides methods for adding writes to the write batch. None of the writes
 * will be committed (or visible locally) until {@link WriteBatch.commit} is
 * called.
 */ function hp(a,b){if((a=(0,e.getModularInstance)(a)).firestore!==b)throw new k(j.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return a}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ // TODO(mrschmidt) Consider using `BaseTransaction` as the base class in the
// legacy SDK.
/**
 * A reference to a transaction.
 *
 * The `Transaction` object passed to a transaction's `updateFunction` provides
 * the methods to read and write data within the transaction context. See
 * {@link runTransaction}.
 */ var hq=function(a){function b(b){var c=this;return(c=a.call(this)||this).firestore=b,c}return(0,d.__extends)(b,a),b.prototype.convertBytes=function(a){return new gz(a)},b.prototype.convertReference=function(a){var b=this.convertDocumentKey(a,this.firestore._databaseId);return new gi(this.firestore,null,b)},b}(hl);function hr(a,b,c){for(var d=[],f=3;f<arguments.length;f++)d[f-3]=arguments[f];a=ge(a,gi);var g=ge(a.firestore,gt),h=gI(g);return ht(g,[("string"==typeof(b=(0,e.getModularInstance)(b))||b instanceof gy?gR(h,"updateDoc",a._key,b,c,d):gQ(h,"updateDoc",a._key,b)).toMutation(a._key,a6.exists(!0))])}function hs(a){for(var b,c,f,g=[],h=1;h<arguments.length;h++)g[h-1]=arguments[h];a=(0,e.getModularInstance)(a);var i={includeMetadataChanges:!1},j=0;"object"!=typeof g[j]||gq(g[j])||(i=g[j],j++);var k,l,m,n={includeMetadataChanges:i.includeMetadataChanges};if(gq(g[j])){var o=g[j];g[j]=null===(b=o.next)|| void 0===b?void 0:b.bind(o),g[j+1]=null===(c=o.error)|| void 0===c?void 0:c.bind(o),g[j+2]=null===(f=o.complete)|| void 0===f?void 0:f.bind(o)}if(a instanceof gi)l=ge(a.firestore,gt),m=aC(a._key.path),k={next:function(b){g[j]&&g[j](hu(l,a,b))},error:g[j+1],complete:g[j+2]};else{var p=ge(a,gj);l=ge(p.firestore,gt),m=p._query;var q=new hq(l);k={next:function(a){g[j]&&g[j](new g6(l,q,p,a))},error:g[j+1],complete:g[j+2]},g9(a._query)}return function(a,b,c,e){var f=this,g=new fL(e),h=new e1(b,g,c);return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(f,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return b=eY,[4,fY(a)];case 1:return[2,b.apply(void 0,[c.sent(),h])]}})})}),function(){g.Wo(),a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(f,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return b=eZ,[4,fY(a)];case 1:return[2,b.apply(void 0,[c.sent(),h])]}})})})}}(gu(l),m,n,k)}function ht(a,b){return function(a,b){var c=this,e=new cA;return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(c,void 0,void 0,function(){var c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return c=ff,[4,fX(a)];case 1:return[2,c.apply(void 0,[d.sent(),b,e])]}})})}),e.promise}(gu(a),b)}function hu(a,b,c){var d=c.docs.get(b._key),e=new hq(a);return new g4(a,e,b._key,d,new g3(c.hasPendingWrites,c.fromCache),b.converter)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * A reference to a transaction.
 *
 * The `Transaction` object passed to a transaction's `updateFunction` provides
 * the methods to read and write data within the transaction context. See
 * {@link runTransaction}.
 */ var hv=function(a){function b(b,c){var d=this;return(d=a.call(this,b,c)||this)._firestore=b,d}return(0,d.__extends)(b,a),b.prototype.get=function(b){var c=this,d=hp(b,this._firestore),e=new hq(this._firestore);return a.prototype.get.call(this,b).then(function(a){return new g4(c._firestore,e,d._key,a._document,new g3(!1,!1),d.converter)})},b}(function(){function a(a,b){this._firestore=a,this._transaction=b,this._dataReader=gI(a)}return a.prototype.get=function(a){var b=this,c=hp(a,this._firestore),d=new hn(this._firestore);return this._transaction.lookup([c._key]).then(function(a){if(!a||1!==a.length)return r();var e=a[0];if(e.isFoundDocument())return new g0(b._firestore,d,e.key,e,c.converter);if(e.isNoDocument())return new g0(b._firestore,d,c._key,null,c.converter);throw r()})},a.prototype.set=function(a,b,c){var d=hp(a,this._firestore),e=hm(d.converter,b,c),f=gJ(this._dataReader,"Transaction.set",d._key,e,null!==d.converter,c);return this._transaction.set(d._key,f),this},a.prototype.update=function(a,b,c){for(var d=[],f=3;f<arguments.length;f++)d[f-3]=arguments[f];var g,h=hp(a,this._firestore);return g="string"==typeof(b=(0,e.getModularInstance)(b))||b instanceof gy?gR(this._dataReader,"Transaction.update",h._key,b,c,d):gQ(this._dataReader,"Transaction.update",h._key,b),this._transaction.update(h._key,g),this},a.prototype.delete=function(a){var b=hp(a,this._firestore);return this._transaction.delete(b._key),this},a}());/**
 * Executes the given `updateFunction` and then attempts to commit the changes
 * applied within the transaction. If any document read within the transaction
 * has changed, Cloud Firestore retries the `updateFunction`. If it fails to
 * commit after 5 attempts, the transaction fails.
 *
 * The maximum number of writes allowed in a single transaction is 500.
 *
 * @param firestore - A reference to the Firestore database to run this
 * transaction against.
 * @param updateFunction - The function to execute within the transaction
 * context.
 * @returns If the transaction completed successfully or was explicitly aborted
 * (the `updateFunction` returned a failed promise), the promise returned by the
 * `updateFunction `is returned here. Otherwise, if the transaction failed, a
 * rejected promise with the corresponding failure error is returned.
 */ /**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /** Helper function to assert Uint8Array is available at runtime. */ function hw(){if("undefined"==typeof Uint8Array)throw new k(j.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function hx(){if("undefined"==typeof atob)throw new k(j.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}var hy=function(){function a(a){this._delegate=a}return a.fromBase64String=function(b){return hx(),new a(gz.fromBase64String(b))},a.fromUint8Array=function(b){return hw(),new a(gz.fromUint8Array(b))},a.prototype.toBase64=function(){return hx(),this._delegate.toBase64()},a.prototype.toUint8Array=function(){return hw(),this._delegate.toUint8Array()},a.prototype.isEqual=function(a){return this._delegate.isEqual(a._delegate)},a.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},a}(),hz=function(){function a(){}return a.prototype.enableIndexedDbPersistence=function(a,b){var c,d,e,f,g;return c=a._delegate,d={forceOwnership:b},gx(c=ge(c,gt)),e=gu(c),f=c._freezeSettings(),g=new fJ,gw(e,g,new fH(g,f.cacheSizeBytes,null==d?void 0:d.forceOwnership))},a.prototype.enableMultiTabIndexedDbPersistence=function(a){var b,c,d,e;return gx(b=ge(b=a._delegate,gt)),c=gu(b),d=b._freezeSettings(),e=new fJ,gw(c,e,new fI(e,d.cacheSizeBytes))},a.prototype.clearIndexedDbPersistence=function(a){return function(a){var b=this;if(a._initialized&&!a._terminated)throw new k(j.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");var c=new cA;return a._queue.enqueueAndForgetEvenWhileRestricted(function(){return(0,d.__awaiter)(b,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return cD.yt()?(b=a+"main",[4,cD.delete(b)]):[2,Promise.resolve()];case 1:return c.sent(),[2]}})})}(dF(a._databaseId,a._persistenceKey))];case 1:return e.sent(),c.resolve(),[3,3];case 2:return b=e.sent(),c.reject(b),[3,3];case 3:return[2]}})})}),c.promise}(a._delegate)},a}(),hA=function(){function a(a,b,c){var d=this;this._delegate=b,this.Zc=c,this.INTERNAL={delete:function(){return d.terminate()}},a instanceof f0||(this.tu=a)}return Object.defineProperty(a.prototype,"_databaseId",{get:function(){return this._delegate._databaseId},enumerable:!1,configurable:!0}),a.prototype.settings=function(a){var b=this._delegate._getSettings();a.merge||b.host===a.host||p("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),a.merge&&delete(a=Object.assign(Object.assign({},b),a)).merge,this._delegate._setSettings(a)},a.prototype.useEmulator=function(a,b,c){void 0===c&&(c={}),function(a,b,c,d){void 0===d&&(d={});var f=(a=ge(a,gh))._getSettings();if("firestore.googleapis.com"!==f.host&&f.host!==b&&p("Host has been set in both settings() and useEmulator(), emulator host will be used"),a._setSettings(Object.assign(Object.assign({},f),{host:b+":"+c,ssl:!1})),d.mockUserToken){var g=(0,e.createMockUserToken)(d.mockUserToken),h=d.mockUserToken.sub||d.mockUserToken.user_id;if(!h)throw new k(j.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");a._credentials=new f4(new f2(g,new d2(h)))}}(this._delegate,a,b,c)},a.prototype.enableNetwork=function(){return function(a){var b=this;return a.asyncQueue.enqueue(function(){return(0,d.__awaiter)(b,void 0,void 0,function(){var b,c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return[4,fU(a)];case 1:return b=d.sent(),[4,fW(a)];case 2:var e,f,g;return c=d.sent(),[2,(b.setNetworkEnabled(!0),(g=f=c).Or.delete(0),es(g))]}})})})}(gu(ge(this._delegate,gt)))},a.prototype.disableNetwork=function(){return function(a){var b=this;return a.asyncQueue.enqueue(function(){return(0,d.__awaiter)(b,void 0,void 0,function(){var b,c;return(0,d.__generator)(this,function(e){switch(e.label){case 0:return[4,fU(a)];case 1:return b=e.sent(),[4,fW(a)];case 2:return c=e.sent(),[2,(b.setNetworkEnabled(!1),function(a){return(0,d.__awaiter)(this,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:var d;return(b=d=a).Or.add(0),[4,et(b)];case 1:return c.sent(),b.Br.set("Offline"),[2]}})})}(c))]}})})})}(gu(ge(this._delegate,gt)))},a.prototype.enablePersistence=function(a){var b=!1,c=!1;return a&&ga("synchronizeTabs",b=!!a.synchronizeTabs,"experimentalForceOwningTab",c=!!a.experimentalForceOwningTab),b?this.Zc.enableMultiTabIndexedDbPersistence(this):this.Zc.enableIndexedDbPersistence(this,c)},a.prototype.clearPersistence=function(){return this.Zc.clearIndexedDbPersistence(this)},a.prototype.terminate=function(){return this.tu&&(this.tu._removeServiceInstance("firestore"),this.tu._removeServiceInstance("firestore-exp")),this._delegate._delete()},a.prototype.waitForPendingWrites=function(){return function(a){var b=this,c=new cA;return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(b,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return b=fl,[4,fX(a)];case 1:return[2,b.apply(void 0,[d.sent(),c])]}})})}),c.promise}(gu(ge(this._delegate,gt)))},a.prototype.onSnapshotsInSync=function(a){var b,c;return b=this._delegate,c=a,function(a,b){var c=this,e=new fL(b);return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(c,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return b=function(a,b){var c;(c=a).Gr.add(b),b.next()},[4,fY(a)];case 1:return[2,b.apply(void 0,[c.sent(),e])]}})})}),function(){e.Wo(),a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(c,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return b=function(a,b){var c;(c=a).Gr.delete(b)},[4,fY(a)];case 1:return[2,b.apply(void 0,[c.sent(),e])]}})})})}}(gu(b=ge(b,gt)),gq(c)?c:{next:c})},Object.defineProperty(a.prototype,"app",{get:function(){if(!this.tu)throw new k(j.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this.tu},enumerable:!1,configurable:!0}),a.prototype.collection=function(a){try{return new hP(this,gl(this._delegate,a))}catch(b){throw hH(b,"collection()","Firestore.collection()")}},a.prototype.doc=function(a){try{return new hG(this,gm(this._delegate,a))}catch(b){throw hH(b,"doc()","Firestore.doc()")}},a.prototype.collectionGroup=function(a){try{return new hM(this,function(a,b){var c;if(a=ge(a,gh),f8("collectionGroup","collection id",b),b.indexOf("/")>=0)throw new k(j.INVALID_ARGUMENT,"Invalid collection ID '"+b+"' passed to function collectionGroup(). Collection IDs must not contain '/'.");return new gj(a,null,(c=b,new aA(C.emptyPath(),c)))}(this._delegate,a))}catch(b){throw hH(b,"collectionGroup()","Firestore.collectionGroup()")}},a.prototype.runTransaction=function(a){var b=this;return function(a,b){return function(a,b){var c=this,e=new cA;return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(c,void 0,void 0,function(){var c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var f;return[4,fT(f=a).then(function(a){return a.datastore})];case 1:return c=d.sent(),new fO(a.asyncQueue,c,b,e).run(),[2]}})})}),e.promise}(gu(a),function(c){return b(new hv(a,c))})}(this._delegate,function(c){return a(new hD(b,c))})},a.prototype.batch=function(){var a=this;return gu(this._delegate),new hE(new ho(this._delegate,function(b){return ht(a._delegate,b)}))},a.prototype.loadBundle=function(a){throw new k(j.FAILED_PRECONDITION,'"loadBundle()" does not exist, have you imported "firebase/firestore/bundle"?')},a.prototype.namedQuery=function(a){throw new k(j.FAILED_PRECONDITION,'"namedQuery()" does not exist, have you imported "firebase/firestore/bundle"?')},a}(),hB=function(a){function b(b){var c=this;return(c=a.call(this)||this).firestore=b,c}return(0,d.__extends)(b,a),b.prototype.convertBytes=function(a){return new hy(new gz(a))},b.prototype.convertReference=function(a){var b=this.convertDocumentKey(a,this.firestore._databaseId);return hG.eu(b,this.firestore,null)},b}(hl);function hC(a){var b;b=a,l.setLogLevel(b)}var hD=function(){function a(a,b){this._firestore=a,this._delegate=b,this._userDataWriter=new hB(a)}return a.prototype.get=function(a){var b=this,c=hQ(a);return this._delegate.get(c).then(function(a){return new hK(b._firestore,new g4(b._firestore._delegate,b._userDataWriter,a._key,a._document,a.metadata,c.converter))})},a.prototype.set=function(a,b,c){var d=hQ(a);return c?(f9("Transaction.set",c),this._delegate.set(d,b,c)):this._delegate.set(d,b),this},a.prototype.update=function(a,b,c){for(var e,f=[],g=3;g<arguments.length;g++)f[g-3]=arguments[g];var h=hQ(a);return 2===arguments.length?this._delegate.update(h,b):(e=this._delegate).update.apply(e,(0,d.__spreadArray)([h,b,c],f)),this},a.prototype.delete=function(a){var b=hQ(a);return this._delegate.delete(b),this},a}(),hE=function(){function a(a){this._delegate=a}return a.prototype.set=function(a,b,c){var d=hQ(a);return c?(f9("WriteBatch.set",c),this._delegate.set(d,b,c)):this._delegate.set(d,b),this},a.prototype.update=function(a,b,c){for(var e,f=[],g=3;g<arguments.length;g++)f[g-3]=arguments[g];var h=hQ(a);return 2===arguments.length?this._delegate.update(h,b):(e=this._delegate).update.apply(e,(0,d.__spreadArray)([h,b,c],f)),this},a.prototype.delete=function(a){var b=hQ(a);return this._delegate.delete(b),this},a.prototype.commit=function(){return this._delegate.commit()},a}(),hF=function(){function a(a,b,c){this._firestore=a,this._userDataWriter=b,this._delegate=c}return a.prototype.fromFirestore=function(a,b){var c=new g5(this._firestore._delegate,this._userDataWriter,a._key,a._document,a.metadata,null);return this._delegate.fromFirestore(new hL(this._firestore,c),null!=b?b:{})},a.prototype.toFirestore=function(a,b){return b?this._delegate.toFirestore(a,b):this._delegate.toFirestore(a)},a.nu=function(b,c){var d=a.su,e=d.get(b);e||(e=new WeakMap,d.set(b,e));var f=e.get(c);return f||(f=new a(b,new hB(b),c),e.set(c,f)),f},a}();hF.su=new WeakMap;var hG=function(){function a(a,b){this.firestore=a,this._delegate=b,this._userDataWriter=new hB(a)}return a.iu=function(b,c,d){if(b.length%2!=0)throw new k(j.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+b.canonicalString()+" has "+b.length);return new a(c,new gi(c._delegate,d,new Q(b)))},a.eu=function(b,c,d){return new a(c,new gi(c._delegate,d,b))},Object.defineProperty(a.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"parent",{get:function(){return new hP(this.firestore,this._delegate.parent)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"path",{get:function(){return this._delegate.path},enumerable:!1,configurable:!0}),a.prototype.collection=function(a){try{return new hP(this.firestore,gl(this._delegate,a))}catch(b){throw hH(b,"collection()","DocumentReference.collection()")}},a.prototype.isEqual=function(a){return(a=(0,e.getModularInstance)(a))instanceof gi&&gn(this._delegate,a)},a.prototype.set=function(a,b){b=f9("DocumentReference.set",b);try{var c,d,e,f,g;return c=this._delegate,d=a,e=b,c=ge(c,gi),f=ge(c.firestore,gt),g=hm(c.converter,d,e),ht(f,[gJ(gI(f),"setDoc",c._key,g,null!==c.converter,e).toMutation(c._key,a6.none())])}catch(h){throw hH(h,"setDoc()","DocumentReference.set()")}},a.prototype.update=function(a,b){for(var c=[],e=2;e<arguments.length;e++)c[e-2]=arguments[e];try{return 1===arguments.length?hr(this._delegate,a):hr.apply(void 0,(0,d.__spreadArray)([this._delegate,a,b],c))}catch(f){throw hH(f,"updateDoc()","DocumentReference.update()")}},a.prototype.delete=function(){var a;return ht(ge((a=this._delegate).firestore,gt),[new bl(a._key,a6.none())])},a.prototype.onSnapshot=function(){for(var a=this,b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];var d=hI(b),e=hJ(b,function(b){return new hK(a.firestore,new g4(a.firestore._delegate,a._userDataWriter,b._key,b._document,b.metadata,a._delegate.converter))});return hs(this._delegate,d,e)},a.prototype.get=function(a){var b,c,e,f,g,h,i,l,m=this;return("cache"===(null==a?void 0:a.source)?(b=ge(b=this._delegate,gi),c=ge(b.firestore,gt),e=gu(c),f=new hq(c),(function(a,b){var c=this,e=new cA;return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(c,void 0,void 0,function(){var c;return(0,d.__generator)(this,function(f){switch(f.label){case 0:return c=function(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f;return(0,d.__generator)(this,function(d){switch(d.label){case 0:var g,h,i,l;return d.trys.push([0,2,,3]),[4,(g=a,h=b,(l=i=g).persistence.runTransaction("read document","readonly",function(a){return l.Mn.mn(a,h)}))];case 1:return(f=d.sent()).isFoundDocument()?c.resolve(f):f.isNoDocument()?c.resolve(null):c.reject(new k(j.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")),[3,3];case 2:return f=eS(e=d.sent(),"Failed to get document '"+b+" from cache"),c.reject(f),[3,3];case 3:return[2]}})})},[4,fV(a)];case 1:return[2,c.apply(void 0,[f.sent(),b,e])]}})})}),e.promise})(e,b._key).then(function(a){return new g4(c,f,b._key,a,new g3(null!==a&&a.hasLocalMutations,!0),b.converter)})):"server"===(null==a?void 0:a.source)?(g=ge(g=this._delegate,gi),h=ge(g.firestore,gt),fZ(gu(h),g._key,{source:"server"}).then(function(a){return hu(h,g,a)})):(i=ge(i=this._delegate,gi),l=ge(i.firestore,gt),fZ(gu(l),i._key).then(function(a){return hu(l,i,a)}))).then(function(a){return new hK(m.firestore,new g4(m.firestore._delegate,m._userDataWriter,a._key,a._document,a.metadata,m._delegate.converter))})},a.prototype.withConverter=function(b){return new a(this.firestore,b?this._delegate.withConverter(hF.nu(this.firestore,b)):this._delegate.withConverter(null))},a}();function hH(a,b,c){return a.message=a.message.replace(b,c),a}function hI(a){for(var b=0,c=a;b<c.length;b++){var d=c[b];if("object"==typeof d&&!gq(d))return d}return{}}function hJ(a,b){var c,d,e;return{next:function(a){e.next&&e.next(b(a))},error:null===(c=(e=gq(a[0])?a[0]:gq(a[1])?a[1]:"function"==typeof a[0]?{next:a[0],error:a[1],complete:a[2]}:{next:a[1],error:a[2],complete:a[3]}).error)|| void 0===c?void 0:c.bind(e),complete:null===(d=e.complete)|| void 0===d?void 0:d.bind(e)}}var hK=function(){function a(a,b){this._firestore=a,this._delegate=b}return Object.defineProperty(a.prototype,"ref",{get:function(){return new hG(this._firestore,this._delegate.ref)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"metadata",{get:function(){return this._delegate.metadata},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"exists",{get:function(){return this._delegate.exists()},enumerable:!1,configurable:!0}),a.prototype.data=function(a){return this._delegate.data(a)},a.prototype.get=function(a,b){return this._delegate.get(a,b)},a.prototype.isEqual=function(a){return g8(this._delegate,a._delegate)},a}(),hL=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return(0,d.__extends)(b,a),b.prototype.data=function(a){return this._delegate.data(a)},b}(hK),hM=function(){function a(a,b){this.firestore=a,this._delegate=b,this._userDataWriter=new hB(a)}return a.prototype.where=function(b,c,d){try{var e,f,g,h,i;return new a(this.firestore,hb(this._delegate,(e=b,f=c,g=d,h=f,i=g2("where",e),new hc(i,h,g))))}catch(j){throw hH(j,/(orderBy|where)\(\)/,"Query.$1()")}},a.prototype.orderBy=function(b,c){try{var d,e,f,g;return new a(this.firestore,hb(this._delegate,(d=b,e=c,void 0===e&&(e="asc"),f=e,g=g2("orderBy",d),new hd(g,f))))}catch(h){throw hH(h,/(orderBy|where)\(\)/,"Query.$1()")}},a.prototype.limit=function(b){try{var c;return new a(this.firestore,hb(this._delegate,(c=b,gf("limit",c),new he("limit",c,"F"))))}catch(d){throw hH(d,"limit()","Query.limit()")}},a.prototype.limitToLast=function(b){try{var c;return new a(this.firestore,hb(this._delegate,(c=b,gf("limitToLast",c),new he("limitToLast",c,"L"))))}catch(d){throw hH(d,"limitToLast()","Query.limitToLast()")}},a.prototype.startAt=function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];try{return new a(this.firestore,hb(this._delegate,(function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return new hf("startAt",a,!0)}).apply(void 0,b)))}catch(d){throw hH(d,"startAt()","Query.startAt()")}},a.prototype.startAfter=function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];try{return new a(this.firestore,hb(this._delegate,(function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return new hf("startAfter",a,!1)}).apply(void 0,b)))}catch(d){throw hH(d,"startAfter()","Query.startAfter()")}},a.prototype.endBefore=function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];try{return new a(this.firestore,hb(this._delegate,(function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return new hg("endBefore",a,!0)}).apply(void 0,b)))}catch(d){throw hH(d,"endBefore()","Query.endBefore()")}},a.prototype.endAt=function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];try{return new a(this.firestore,hb(this._delegate,(function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return new hg("endAt",a,!1)}).apply(void 0,b)))}catch(d){throw hH(d,"endAt()","Query.endAt()")}},a.prototype.isEqual=function(a){return go(this._delegate,a._delegate)},a.prototype.get=function(a){var b,c,e,f,g,h,i,j,k,l,m,n,o=this;return("cache"===(null==a?void 0:a.source)?(b=ge(b=this._delegate,gj),c=ge(b.firestore,gt),e=gu(c),f=new hq(c),(function(a,b){var c=this,e=new cA;return a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(c,void 0,void 0,function(){var c;return(0,d.__generator)(this,function(f){switch(f.label){case 0:return c=function(a,b,c){return(0,d.__awaiter)(this,void 0,void 0,function(){var e,f,g,h,i;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return d.trys.push([0,2,,3]),[4,dR(a,b,!0)];case 1:return i=d.sent(),f=(e=new e8(b,i.Bn))._o(i.documents),g=e.applyChanges(f,!1),c.resolve(g.snapshot),[3,3];case 2:return i=eS(h=d.sent(),"Failed to execute query '"+b+" against cache"),c.reject(i),[3,3];case 3:return[2]}})})},[4,fV(a)];case 1:return[2,c.apply(void 0,[f.sent(),b,e])]}})})}),e.promise})(e,b._query).then(function(a){return new g6(c,f,b,a)})):"server"===(null==a?void 0:a.source)?(g=ge(g=this._delegate,gj),h=ge(g.firestore,gt),i=gu(h),j=new hq(h),f$(i,g._query,{source:"server"}).then(function(a){return new g6(h,j,g,a)})):(k=ge(k=this._delegate,gj),l=ge(k.firestore,gt),m=gu(l),n=new hq(l),g9(k._query),f$(m,k._query).then(function(a){return new g6(l,n,k,a)}))).then(function(a){return new hO(o.firestore,new g6(o.firestore._delegate,o._userDataWriter,o._delegate,a._snapshot))})},a.prototype.onSnapshot=function(){for(var a=this,b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];var d=hI(b),e=hJ(b,function(b){return new hO(a.firestore,new g6(a.firestore._delegate,a._userDataWriter,a._delegate,b._snapshot))});return hs(this._delegate,d,e)},a.prototype.withConverter=function(b){return new a(this.firestore,b?this._delegate.withConverter(hF.nu(this.firestore,b)):this._delegate.withConverter(null))},a}(),hN=function(){function a(a,b){this._firestore=a,this._delegate=b}return Object.defineProperty(a.prototype,"type",{get:function(){return this._delegate.type},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"doc",{get:function(){return new hL(this._firestore,this._delegate.doc)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"oldIndex",{get:function(){return this._delegate.oldIndex},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"newIndex",{get:function(){return this._delegate.newIndex},enumerable:!1,configurable:!0}),a}(),hO=function(){function a(a,b){this._firestore=a,this._delegate=b}return Object.defineProperty(a.prototype,"query",{get:function(){return new hM(this._firestore,this._delegate.query)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"metadata",{get:function(){return this._delegate.metadata},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"size",{get:function(){return this._delegate.size},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"empty",{get:function(){return this._delegate.empty},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"docs",{get:function(){var a=this;return this._delegate.docs.map(function(b){return new hL(a._firestore,b)})},enumerable:!1,configurable:!0}),a.prototype.docChanges=function(a){var b=this;return this._delegate.docChanges(a).map(function(a){return new hN(b._firestore,a)})},a.prototype.forEach=function(a,b){var c=this;this._delegate.forEach(function(d){a.call(b,new hL(c._firestore,d))})},a.prototype.isEqual=function(a){return g8(this._delegate,a._delegate)},a}(),hP=function(a){function b(b,c){var d=this;return(d=a.call(this,b,c)||this).firestore=b,d._delegate=c,d}return(0,d.__extends)(b,a),Object.defineProperty(b.prototype,"id",{get:function(){return this._delegate.id},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"path",{get:function(){return this._delegate.path},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"parent",{get:function(){var a=this._delegate.parent;return a?new hG(this.firestore,a):null},enumerable:!1,configurable:!0}),b.prototype.doc=function(a){try{return new hG(this.firestore,void 0===a?gm(this._delegate):gm(this._delegate,a))}catch(b){throw hH(b,"doc()","CollectionReference.doc()")}},b.prototype.add=function(a){var b,c,d,e,f,g=this;return(b=this._delegate,c=a,d=ge(b.firestore,gt),e=gm(b),f=hm(b.converter,c),ht(d,[gJ(gI(b.firestore),"addDoc",e._key,f,null!==b.converter,{}).toMutation(e._key,a6.exists(!1))]).then(function(){return e})).then(function(a){return new hG(g.firestore,a)})},b.prototype.isEqual=function(a){return gn(this._delegate,a._delegate)},b.prototype.withConverter=function(a){return new b(this.firestore,a?this._delegate.withConverter(hF.nu(this.firestore,a)):this._delegate.withConverter(null))},b}(hM);function hQ(a){return ge(a,gi)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ // The objects that are a part of this API are exposed to third-parties as
// compiled javascript so we want to flag our private members with a leading
// underscore to discourage their use.
/**
 * A `FieldPath` refers to a field in a document. The path may consist of a
 * single field name (referring to a top-level field in the document), or a list
 * of field names (referring to a nested field in the document).
 */ var hR=function(){function a(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];this._delegate=new(gy.bind.apply(gy,(0,d.__spreadArray)([void 0],a)))}return a.documentId=function(){return new a(E.keyField().canonicalString())},a.prototype.isEqual=function(a){return(a=(0,e.getModularInstance)(a))instanceof gy&&this._delegate._internalPath.isEqual(a._internalPath)},a}(),hS=function(){function a(a){this._delegate=a}return a.serverTimestamp=function(){var b=new gM("serverTimestamp");return b._methodName="FieldValue.serverTimestamp",new a(b)},a.delete=function(){var b=new gK("deleteField");return b._methodName="FieldValue.delete",new a(b)},a.arrayUnion=function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];var d=(function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return new gN("arrayUnion",a)}).apply(void 0,b);return d._methodName="FieldValue.arrayUnion",new a(d)},a.arrayRemove=function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];var d=(function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return new gO("arrayRemove",a)}).apply(void 0,b);return d._methodName="FieldValue.arrayRemove",new a(d)},a.increment=function(b){var c,d=(c=b,new gP("increment",c));return d._methodName="FieldValue.increment",new a(d)},a.prototype.isEqual=function(a){return this._delegate.isEqual(a._delegate)},a}();/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ /**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */ function hT(a){var b,c,e,f;return b=this._delegate,c=a,e=gu(b=ge(b,gt)),f=new gr,function(a,b,c,e){var f,g,h,i,j=this,k=(f=c,g=ek(b),h=function(a,b){if(a instanceof Uint8Array)return fK(a,b);if(a instanceof ArrayBuffer)return fK(new Uint8Array(a),b);if(a instanceof ReadableStream)return a.getReader();throw Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof f?(new TextEncoder).encode(f):f),i=g,new fM(h,i));a.asyncQueue.enqueueAndForget(function(){return(0,d.__awaiter)(j,void 0,void 0,function(){var b;return(0,d.__generator)(this,function(c){switch(c.label){case 0:return b=fF,[4,fX(a)];case 1:return b.apply(void 0,[c.sent(),k,e]),[2]}})})})}(e,b._databaseId,c,f),f}function hU(a){var b,c,e=this;return(b=this._delegate,c=a,(function(a,b){var c=this;return a.asyncQueue.enqueue(function(){return(0,d.__awaiter)(c,void 0,void 0,function(){var c;return(0,d.__generator)(this,function(d){switch(d.label){case 0:return c=function(a,b){var c,d=c=a;return d.persistence.runTransaction("Get named query","readonly",function(a){return d.Ke.getNamedQuery(a,b)})},[4,fV(a)];case 1:return[2,c.apply(void 0,[d.sent(),b])]}})})})})(gu(b=ge(b,gt)),c).then(function(a){return a?new gj(b,null,a.query):null})).then(function(a){return a?new hM(e,a):null})}}}])